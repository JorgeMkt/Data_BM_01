---
title: "Data Preparation and Cleaning"
author: "Brian Stacy"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, fig.height=7, fig.width=10)

library(tidyverse)
library(here)
library(wbggeo)
library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(httr)
library(patchwork)


#set directories
dir <- here()

raw_dir <- paste(dir, '01_raw_data', sep="/")


```

```{r programs, include=FALSE}


#Now map the result
quality = "high"
maps <- wbgmaps::wbgmaps[[quality]]

country_metadata <- wbstats::wbcountries()



spi_mapper  <- function(data, indicator, title) {
  
 indicator<-indicator

  map_df <- get(data) %>%
    group_by( country) %>%
    summarise(across(!! indicator,last)) %>%
    mutate(data_available=TRUE) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), FALSE, data_available))    
  
  
   p1 <- ggplot() +
    geom_map(data = map_df, aes(map_id = iso3c, fill = data_available), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
     geom_path(data = maps$boundaries,
               aes(long, lat, group = group),
               color = "white",
               size = 0.1,
               lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
    scale_fill_brewer(
      name='Data Available',
      palette='Paired',
      na.value='blue'
    )  +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap(title,100),
      caption = 'Source: SPI Indicators Raw Data'
    )
  
  #add histogram by region 
  p2 <- map_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=100*mean(data_available),
           Label = paste(sum(data_available),'/',n(), sep="")) %>%
    ggplot(aes(x=Percentage, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Region', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data'
      ) +
      theme_bw()
    
  print(p1)
  
  print(p2)
     
}

```


# Introduction

In this program, I will clean and reshape the raw data files in the 01_rawdata folder in order to produce the Statistical Performance Indicators.

# Data Use 

Cleaning for Data Use Indicators.  Data Use (5 Indicators):  
  - 1.1_DUNL - Indicator 1.1: Data use by national legislature    
  - 1.2_DUNE - Indicator 1.2: Data use by national executive branch   
  - 1.3_DUCS - Indicator 1.3: Data use by civil society     
  - 1.4_DUAC - Indicator 1.4: Data use by academia    
  - 1.5_DUIO - Indicator 1.5: Data use by international organizations   
  
# Data Services


Cleaning for Data Services Indicators.  Data Services (4 Indicators):   
  - 2.1_DSDR - Indicator 2.1: Data releases     
  - 2.2_DSOA - Indicator 2.2: Online access     
  - 2.3_DSAS - Indicator 2.3: Advisory/ Analytical Services  
  - 2.4_DSDS - Indicator 2.4: Data services    
  
# Data Products

Cleaning for Data Products Indicators.  Data Products (4 Indicators):   
  - 3.1_DPSS - Indicator 3.1: social statistics (SDG goals 1-6)     
  - 3.2_DPES - Indicator 3.2: economic statistics (SDG goals 7-12)    
  - 3.3_DPEN - Indicator 3.3 environmental statistics (SDG goals 13-15)     
  - 3.4_DPIS - Indicator 3.4: institutional statistics (SDG goals 16-17)      

# Data Sources

Cleaning for the Data Sources Indicators.  Data Sources (4 Indicators):     
  - 4.1_SOCS - Indicator 4.1: censuses and surveys        
  - 4.2_SOAD - Indicator 4.2: administrative data   
  - 4.3_SOGS - Indicator 4.3: geospatial data     
  - 4.4_SOPC - Indicator 4.4: private/citizen generated data    

## Indicator 4.1: censuses and surveys 

This indicator draws from data collected by the Statistical Performance Indicators team.  The following censuses and surveys are considered.

```{r cs}

cs_fun  <- function(data, input_var, indicator) {
  
  data <- data
  input_var <- input_var
  indicator <- indicator

  #read in csv file.
  cs_df <- read_csv(file = paste(raw_dir, '/4.1_SOCS/', data, ".csv", sep="" )) %>%
    group_by(iso3c, country) %>% 
    rename(input_var = !! input_var) %>%
    nest() %>% # The next chunk of code will split our string with the years of the census (i.e. "2000, 2010") in to separate rows.  We will then aggregate up.
    mutate(
      temp_col = map(
        data, 
        ~ str_extract_all(.x$input_var, "\\d{4}") %>% 
          flatten() %>% 
          map_chr(~return(.x)) %>% 
          as_tibble()
      )
    ) %>% 
    unnest(keep_empty = TRUE) %>% # Now we have a database with the observations equal to Country*Census observations.  From here we can calculate latest census, etc.
    mutate(indicator_date=as.numeric(value)) 
  
  
  
  #Now calculate our SPI score for this indicator
  for (i in 2016:2019) {
   temp <- cs_df %>%
    mutate(date=i) %>%
    mutate(recency_indicator=((date>indicator_date)) ) %>% #restrict to censuses that do not occur after reference date
    mutate(indicator_date=if_else(recency_indicator==TRUE, indicator_date, as.numeric(NA))) %>%
    group_by(iso3c, country, date, database_last_updated, input_var ) %>%
    summarise(last_val=max(indicator_date, na.rm=T)) %>%
    mutate(indicator=case_when(
      (date-last_val<=10) & (date-last_val>0) ~ 1,
      (date-last_val<=20) & (date-last_val>0) ~ 0.5,
      TRUE ~ 0 )
    )  %>%
     ungroup() %>%
    select(c('iso3c', 'country', 'date', 'input_var', 'indicator')  ) %>%
    arrange(date, country)


    assign(paste('temp',i,sep="_"), temp)
  }

  bind_rows(temp_2016, temp_2017, temp_2018, temp_2019)

  
}

cs_df <-cs_fun('D2.1.CEN.POPU', 'POPU.CENSUS', 'SPI.D2.1.POPU')




```

  
## Indicator 4.2: administrative data

The following indicator checks whether administrative data is available for the following topic areas: Social Protection, Education, Population & Health, and Labor

### Social Protection Admin Data

-  Atlas of Social Protection Indicators of Resilience and Equity (ASPIRE) is compilation of Social Protection and Labor (SPL) indicators to analyze scope and performance of SPL programs.   
- ASPIRE has indicators for 136 countries on:    
  * Social assistance   
  * Social insurance    
  * Labor market programs 
  
- Based on both program-level administrative data and national household survey data    
- Data extends from 2001 to 2018

```{r aspire, message=FALSE, warning=FALSE}

#read data
aspire_df_raw <- read_csv(paste(raw_dir, '4.2_SOAD','ASPIRE_sources.csv', sep="/"))

#cleaning of aspire data
aspire_df <- aspire_df_raw %>%
    group_by( ccode) %>%
    summarise(ben_count=mean(ben, na.rm=T),
              ben_exp=mean(exp_b, na.rm=T)) %>%
    rename(iso3c=ccode) %>%
    left_join(country_metadata) %>%
    mutate(ben_info=(!is.na(ben_count) | !is.na(ben_exp))
           ) 

spi_mapper('aspire_df', 'ben_info', 'Administrative Data Available on Beneficiary Counts or Expenditures in 2001-2018 using ASPIRE' )


```


### Education Admin Data

* UNESCO UIS has shared a database containing data we can use on administrative data systems    
* Two areas:    

  * Data tracking SDG 4.1.2 Administration of a nationally-representative learning assessment (a) in Grade 2 or 3; (b) at the end of primary education; and (c) at the end of lower secondary education    
  
  * Data tracking whether countries produce the following from administrative data sources:   
  
      * Out-of-school rate by school age and sex    
      * 4.2.2 Participation rate in organized learning (one year before the official primary entry age), by sex  

```{r uis, message=FALSE, warning=FALSE}

#read data
unesco_df_raw <- read_csv(paste(raw_dir, '4.2_SOAD','unesco_admin_sources.csv', sep="/"))

#cleaning of aspire data
unesco_df <- unesco_df_raw %>%
    group_by( LOCATION2017) %>%
    summarise(Value=mean(Value, na.rm=T)) %>%
    rename(iso3c=LOCATION2017) %>%
    left_join(country_metadata) %>%
    mutate(available=(!is.na(Value))
           ) %>%
    filter(available==TRUE)
  

spi_mapper('unesco_df', 'available', 'Education Administrative Data Available According to UIS' )


```

### Population & Health Admin Data

* This indicator is formed using World Bank metadata on whether the Civil Registration and Vital Statistics (CRVS) system is complete in the country.  

Civil registration is the act of recording and documenting of vital events in a person’s life (including birth, marriage, divorce, adoption, and death and cause of death) and is a fundamental function of national governments. Birth registration establishes an individual’s legal identity at birth. A legal identity, name, nationality, and proof of age, are important human rights. They enable individuals to be included in various government, social and private services, and include the right to vote, etc. Vital statistics are compiled using civil registration information on these vital events. The availability of reliable and up-to-date vital statistics depends on the level of development of civil registration programs. An effective civil registration and vital statistics (CRVS) system is critical for planning and monitoring programs across several sectors. 

By complete, that is representing 90 per cent or more of the events occurring in the specified year.

Source: World Bank WDI Metadata.  

```{r crvs}

Request_metadata <- GET(url = "https://api.worldbank.org/v2/sources/2/country/all/metadata?per_page=30000&format=json")
Response_metadata <- content(Request_metadata, as = "text", encoding = "UTF-8")

# Parse the JSON content and convert it to a data frame.
JSON_metadata <- jsonlite::fromJSON(Response_metadata, flatten = TRUE) %>%
  data.frame()

#do some conversion to produce a dataframe
crvs_df <- JSON_metadata$source.concept %>%
  data.frame() 

#do some more cleaning and conversion
crvs_df <- crvs_df$variable %>%
  data.frame()   %>%
  rename(iso3c=id) %>%
  unnest(metatype) %>%
  pivot_wider(
    id_cols=iso3c,
    names_from=id,
    values_from=value
  ) 

# Manipulate and clean final data
crvs_df <- crvs_df %>%
  filter(!is.na(IncomeGroup)) %>% #keep just countries (drop aggregations)
  rename(country=ShortName) 

crvs_map <- crvs_df %>%
  filter(!is.na(Vitalregistrationcomplete))

spi_mapper('crvs_map', 'Vitalregistrationcomplete', 'Complete Civil Registration & Vital Statistics Data Available According to WDI' )


```


### Labor Admin Data

* ILO shared database containing all administrative data sources used to produce ILO statistics (ILOSTAT)   
  * May not be comprehensive of all administrative datasets available in a country    
  * But gives some indication of whether labor statistics produced using Admin data
  
* Database contains the following admin sources:    

  * Insurance records   
  * Labour inspectorate records   
  * Records of employers' organizations   
  * Employment office records
  * Records of workers' organizations
  * Other administrative records and related sources
  
* Database extends from 2010 to 2019 and covers 177 countries

```{r ilo, message=FALSE, warning=FALSE}

#read data
ilo_df_raw <- read_csv(paste(raw_dir, '4.2_SOAD','ILOSTAT_sources.csv', sep="/"))

#cleaning of aspire data
ilo_df <- ilo_df_raw %>%
  group_by(iso3c) %>%
  summarise(Source.type=last(Source.type)) %>%
  left_join(country_metadata)

  

spi_mapper('ilo_df', 'Source.type', 'Labor Administrative Data Available According to ILO' )


```


## Indicator 4.3: geospatial data  

New indicator based on references to geospatial data in metadata relating to content on NSO website

### Source

Our source for this indicator is Open Data Watch.  From Open Data watch:

> The Open Data Inventory (ODIN) assesses the coverage and openness of official statistics to help identify gaps, promote open data policies, improve access, and encourage dialogue 
> between national statistical offices (NSOs) and data users. ODIN 2018/19 includes 178 countries, including most all OECD countries. Two-year comparisons are for all countries with
> two years of data between 2015-2017. Scores can be compared across topics and countries.

We use their indicator on whether indicators are available at the first or second administrative level.  To identify the first administrative levels, ODIN largely draws on the ISO 3166-2 standard. In many countries, first administrative levels refer to governorates, regions, or province.  No official list exists for the second administrative level classifications. If geographical disaggregation exists that does not qualify as first administrative level, assume that the data are disaggregated to the second administrative level as long as the classification appears to be a further divisions of the first administrative level.  

Scoring for the ODIN indicators for geospatial information is below:

  - 1 point if all published data in a data category are available at first/second administrative level.    
  - 0.5 points if some published data in a data category are available at first/second administrative level.    
  - 0 points if no data are available at this level   

There are 21 data categories.

Social Statistics   
1.	Population and Vital Statistics   
2.	Education Facilities    
3.	Education Outcomes    
4.	Health Facilities   
5.	Health Outcomes   
6.	Reproductive Health   
7.	Gender Statistics   
8.	Crime and Justice Statistics    
9.	Poverty Statistics    

Economic Statistics   
10.	National Accounts   
11.	Labor Statistics    
12.	Price Indexes   
13.	Government Finance    
14.	Money and Banking   
15.	International Trade   
16.	Balance of Payments   

Environmental Statistics    
17.	Land Use    
18.	Resource Use    
19.	Energy Use    
20.	Pollution   
21.	Built Environment   

For the first administrative unit: Money & Banking, International Trade, and Balance of Payments are not scored for this element. For various indicators, lenient interpretations are used for first administrative divisions.

For the second administrative unit: Money & Banking, International Trade, Balance of Payments, National Accounts, Government Finance ,Pollution, Energy Use, Price Indexes,  and Resource Use are not scored for this element. For various indicators within categories, second administrative level data is not required as well.

In the scores we present below, we show a score between 0 and 1 with a maximum score of 1, which would mean the country has geo data in full for 100% of elements. A score of 0 indicates no data at all for any elements. 

More details on the geographic disaggregation considerations can be found in their technical manual:

https://docs.google.com/document/d/1ubPL1l_3im9bjlCVZ6W2ICAy6UAiXl1hGeA1aXImkxI/edit

```{r geo}

geo_df_raw <- read_csv(paste(raw_dir, '4.3_SOGS','ODIN_2018.csv', sep="/")) %>%
  as_tibble(.name_repair = 'universal') 

geo_df <- geo_df_raw %>%
  filter(Data.categories=='All Categories')

geo_df <- geo_df %>%
    select(Country.Code, First.administrative.level, Second.administrative.level) %>%
    rename(iso3c=Country.Code) %>%
    group_by( iso3c) %>%
    summarise(across(c('First.administrative.level', 'Second.administrative.level'),last)) %>%
    right_join(country_metadata) %>%
    mutate(First.administrative.level=if_else(is.na(First.administrative.level), 0, First.administrative.level/18),
           Second.administrative.level=if_else(is.na(Second.administrative.level), 0, Second.administrative.level/12))    
  
  
   ggplot() +
    geom_map(data = geo_df, aes(map_id = iso3c, fill = First.administrative.level), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
     geom_path(data = maps$boundaries,
               aes(long, lat, group = group),
               color = "white",
               size = 0.1,
               lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
    scale_fill_distiller(
      name='Data Available',
      palette='Blues',
      na.value='black',
      direction = 1
    )  +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap('Data Availability at First Administrative Unit Level',100),
      caption = 'Source: ODIN'
    )
   
   geo_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=100*mean(First.administrative.level),
           Label = paste(sum(Second.administrative.level),'/',n(), sep="")) %>%
    ggplot(aes(x=Percentage, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste('Data Availability at First Administrative Unit Level', 'By Region', sep=" - "),100),
      caption = 'Source: ODIN'
      ) +
      theme_bw()

   ggplot() +
    geom_map(data = geo_df, aes(map_id = iso3c, fill = Second.administrative.level), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
     geom_path(data = maps$boundaries,
               aes(long, lat, group = group),
               color = "white",
               size = 0.1,
               lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
    scale_fill_distiller(
      name='Data Available',
      palette='Blues',
      na.value='black',
      direction = 1
    )  +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap('Data Availability at Second Administrative Unit Level',100),
      caption = 'Source: ODIN'
    )   
   
    geo_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=100*mean(Second.administrative.level),
           Label = paste(sum(Second.administrative.level),'/',n(), sep="")) %>%
    ggplot(aes(x=Percentage, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste('Data Availability at Second Administrative Unit Level', 'By Region', sep=" - "),100),
      caption = 'Source: ODIN'
      ) +
      theme_bw()
   
```


## Indicator 4.4: private/citizen generated data  

New indicator based on references to private/citizen generated data in metadata relating to content on NSO website.

### Covid Mobility Data Availability 

We have seen an increased use of private/citizen generated data during the COVID-19 pandemic.  One way in which it has been used is for tracking mobility of citizens to understand the social distancing measures citizens are taking.  As a measure of private/citizen generated data we make use of Apple and Google Mobility tracking data made publicly available during the pandemic.

Source: 

Google LLC "Google COVID-19 Community Mobility Reports".
https://www.google.com/covid19/mobility/ Accessed: 2020-07-23.

Apple "Mobility Trends Reports".
https://www.apple.com/covid19/mobility/ Accessed: 2020-07-23.


```{r 4.4_SOPC, fig.height=7, fig.width=9, message=FALSE, warning=FALSE}
#####
# Google
#####
#google mobility
google_df_raw <- read_csv(paste(raw_dir, '4.4_SOPC','Global_Mobility_Report.csv', sep="/"))


#match to world bank country database
google_df <- google_df_raw %>%
  left_join(country_metadata, by=c('country_region_code'='iso2c'))


spi_mapper('google_df', 'date', 'Google Global Mobility Report Data' )


#####
# Apple
#####

apple_df_raw <- read_csv(paste(raw_dir, '4.4_SOPC','applemobilitytrends-2020-07-26.csv', sep="/")) 

#match to world bank country database
apple_df <- apple_df_raw %>%
  select(-c('country', 'alternative_name', 'sub-region')) %>%
  filter(geo_type=="country/region") %>%
  rename(country=region) %>%
  pivot_longer(cols=starts_with("2020"),
               names_to='date',
               values_to='value') %>%
  group_by(country) %>%
  summarise(across(everything(), last)) %>%
  mutate(country=case_when(
    country=="Egypt" ~ "Egypt, Arab Rep.",
    country=="Republic of Korea" ~ "Korea, Rep.",
    country=="Macao" ~ "Macao SAR, China",
    country=="Slovakia" ~ "Slovak Republic",
    country=="Taiwan" ~ "Taiwan, China",
    TRUE ~ country
  )) %>%
  left_join(country_metadata)



spi_mapper('apple_df', 'date', 'Apple Mobility Report Data' )

```


# Data Infrastructure


Data Infrastructure (5 Indicators):  
  - 5.1_DILG - Indicator 5.1: legislation and governance    
  - 5.2_DISM - Indicator 5.2: standards     
  - 5.3_DISK - Indicator 5.3: skills    
  - 5.4_DIPN - Indicator 5.4: partnerships    
  - 5.5_DIFI - Indicator 5.5: finance     

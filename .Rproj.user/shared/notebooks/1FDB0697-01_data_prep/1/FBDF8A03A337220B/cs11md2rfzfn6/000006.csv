"0",""
"0","#read in saved data"
"0","safely_managed_raw_df <- read_csv(file=paste(raw_dir, '1.5_DUIO/Safely_Managed_Water_data.csv', sep=""/""))"
"0",""
"0","#score the data"
"0",""
"0","#function to calculate 10 year window"
"0","window_fun <- function(date_start, date_end) {"
"0","  temp <- safely_managed_raw_df %>%"
"0","  filter(between(year,date_start,date_end) ) %>%"
"0","  group_by(iso3c, geo) %>%"
"0","  summarise(data_quality=max(data_quality, na.rm=T)) %>%"
"0","  pivot_wider("
"0","    names_from = 'geo',"
"0","    values_from = 'data_quality'"
"0","  ) %>%"
"0","  mutate("
"0","    SPI.D1.5.SAFE.MAN.WATER=case_when("
"0","      (Rural==1 & Urban==1) ~ 1,"
"0","      (Rural==1 | Urban==1 | National==1) ~ 0.5,"
"0","      TRUE ~ 0"
"0","    )"
"0","  ) %>%"
"0","  select(iso3c, SPI.D1.5.SAFE.MAN.WATER) %>%"
"0","  mutate(date=date_end)"
"0","  "
"0","  "
"0",""
"0","}"
"0","####"
"0","# 10 Year window"
"0","####"
"0","#create this database for each year from 2004 to 2019 using a 5 year window"
"0","for (i in c(2004:2019)) {"
"0","  "
"0","  start=i-9"
"0","  end=i"
"0","  "
"0","  temp_df <- window_fun(start,end)"
"0","  assign(paste('safe_managed_',end, sep=""""), temp_df)"
"0","}"
"0",""
"0","if (exists('safe_managed_')) {"
"0","  rm('safe_managed_')"
"0","}"
"0","#now append together and save"
"0","for (i in c(2004:2019)) {"
"0","  "
"0","  temp<-get(paste('safe_managed_',i, sep=""""))"
"0","  "
"0","  if (!exists('safe_managed_df')) {"
"0","    safe_managed_df<-temp"
"0","  } else {"
"0","    safe_managed_df<-safe_managed_df %>%"
"0","      bind_rows(temp) %>%"
"0","      arrange(-date, iso3c)"
"0","  }"
"0","}"
"0",""
"0",""

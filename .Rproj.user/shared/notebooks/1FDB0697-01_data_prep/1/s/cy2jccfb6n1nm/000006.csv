"0",""
"0","#add in population"
"0","pop_df <- wbstats::wb(country=""all"","
"0","             indicator='SP.POP.TOTL',"
"0","             startdate=2004,"
"0","             enddate=2019) %>%"
"0","  mutate(date=as.numeric(date)) %>%"
"0","  mutate(population=value) %>%"
"0","  select(country, date, population)"
"0",""
"0","# save final dataset"
"0","spi_df_final <- spi_df %>%"
"0","  select(country, iso3c, date, starts_with(""SPI""), starts_with(""RAW"")) %>%"
"0","  right_join(spi_df_empty) %>%"
"0","  left_join(pop_df) %>%"
"0","  arrange(-date,country)"
"0",""
"0","#write to csv"
"0","spi_df_final %>%"
"0","  mutate(across(is.list, as.character)) %>%"
"0","  write_excel_csv( path = paste(output_dir, 'SPI_data.csv', sep=""/""))"
"0",""
"0","#label data"
"0","#read in metadata"
"0","names_df <- data.frame('source_id'=colnames(spi_df_final))"
"0",""
"0","spi_meta <- read_csv(paste(raw_dir, '/metadata/SPI_dimensions_sources.csv', sep="""")) %>%"
"0","  right_join(names_df) %>%"
"0","  mutate(source_name=if_else(is.na(source_name), paste(source_id), source_name)) %>%"
"0","  arrange(factor(source_id, levels=colnames(spi_df_final)))"
"0",""
"0","#label data"
"0",""
"0","label(spi_df_final) = as.list(spi_meta$source_name)"
"0",""
"0",""
"0","#write to stata"
"0","spi_df_final %>%"
"0","  mutate(across(is.list, as.character)) %>%"
"0","  rename_with(~gsub(""."",""_"",.x, fixed=TRUE)) %>%"
"0","  select(-lat,-long) %>%"
"0","  write_dta( path = paste(output_dir, 'SPI_data.dta', sep=""/""))"
"0",""

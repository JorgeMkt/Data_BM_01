"0",""
"0","##########"
"0","# Pull Tags for WDI Data"
"0","##########"
"0",""
"0","# make request to World Bank API"
"0","wdiRequest <- GET(url = ""http://api.worldbank.org/v2/indicator?per_page=20000&format=json&source=2"")"
"0","wdiResponse <- content(wdiRequest, as = ""text"", encoding = ""UTF-8"")"
"0",""
"0","# Parse the JSON content and convert it to a data frame."
"0","wdisJSON <- jsonlite::fromJSON(wdiResponse, flatten = TRUE) %>%"
"0","    data.frame()"
"0",""
"0","EdStatsRequest <- GET(url = ""http://api.worldbank.org/v2/indicator?per_page=20000&format=json&source=12"")"
"0","EdStatsResponse <- content(EdStatsRequest, as = ""text"", encoding = ""UTF-8"")"
"0",""
"0","# Parse the JSON content and convert it to a data frame."
"0","EdStatsJSON <- jsonlite::fromJSON(EdStatsResponse, flatten = TRUE) %>%"
"0","  data.frame()"
"0",""
"0","aki<- c("
"0","        'Pupils below minimum reading proficiency at end of primary (%). Low GAML threshold',"
"0","        'People using safely managed drinking water services (% of population)',"
"0","        'Unemployment, total (% of total labor force) (national estimate)' ,"
"0","        'Manufacturing, value added (% of GDP)',"
"0","        'Annualized average growth rate in per capita real survey mean consumption or income, bottom 40% of population (%)',"
"0","        'Level of water stress: freshwater withdrawal as a proportion of available freshwater resources',"
"0","        'Renewable energy consumption (% of total final energy consumption)',"
"0","        'Households and NPISHs Final consumption expenditure (current LCU)',"
"0","        'Debt service (PPG and IMF only, % of exports of goods, services and primary income)'  )"
"0",""
"0","get_tag_aki_df<-wdisJSON %>%"
"0","  bind_rows(EdStatsJSON) %>%"
"0","  filter((name %in% aki	)) %>%"
"0","  arrange(factor(name, levels = aki)) %>%"
"0","  select(id, name,  sourceOrganization) "
"0",""
"0","#get WDI metadata infor"
"0","cache_list<-wbstats::wbcache()"
"0","country_list <- wbstats::wbcountries()"
"0",""
"0","aki_list<-get_tag_aki_df[,'id']"
"0",""
"0","for (reference_year in 2016:2019) {"
"0","  temp <-wbstats::wb(country=""countries_only"", "
"0","              indicator=aki_list,"
"0","              startdate=reference_year-5,"
"0","              enddate=reference_year,"
"0","              return_wide = T,"
"0","              removeNA=FALSE) %>%"
"0","          filter(((reference_year-as.numeric(date))<=5) & (reference_year>=as.numeric(date))) %>% #filter out years outside reference window of 3 years     "
"0","          write_excel_csv(path = paste(output_dir, ""/D3.AKI_data_pull_"",reference_year,"".csv"", sep="""" )) %>%"
"0","          mutate_at(.vars=aki_list, ~if_else(is.na(.),0,1)) %>% #create 0,1 variable for whether data point exists for country"
"0","          group_by(iso3c, country) %>%"
"0","          summarise_all((~(if(is.numeric(.)) sum(., na.rm = TRUE) else first(.)))) %>% #group by country to create one observation per country                 containing whether or not data point existed"
"0","          mutate_at(.vars=aki_list, ~case_when("
"0","            .>=3 ~ 1,"
"0","            .==2 ~ 0.6,"
"0","            .==1 ~ 0.3,"
"0","            .==0 ~ 0, "
"0","            TRUE ~ 0"
"0","          )) %>% # 1 point for at least 3 values, 0.6 for 2 values, 0.3 for 1 values, 0 otherwise"
"0","          mutate(date=reference_year) %>%"
"0","          ungroup() %>%"
"0","          select(iso3c, country, date,  aki_list) %>%"
"0","          rename_at(aki_list, ~(paste('SPI.D1.5.',.,sep=""""))) %>% #add 'D3.' as prefix before these indicators."
"0","          left_join(country_list) #attach country metadata"
"0",""
"0",""
"0","  assign(paste(""D3.AKI"",reference_year,sep=""_""), temp)"
"0","}"
"0",""
"0",""
"0",""

"0",""
"0","#####"
"0","# The following code is blocked out, because the execution time is long"
"0","#####"
"0",""
"0","# # pull all surveys from IHSN"
"0","# ihsn_base_url <- ""https://catalog.ihsn.org/index.php/api/catalog"" #define url"
"0","# study_request_ihsn<-fromJSON(paste(ihsn_base_url,""/search"",""?ps=10000"", sep="""")) # pull from url"
"0","# study_df_ihsn <- study_request_ihsn$result$rows #convert to dataframe"
"0","# "
"0","# #get list of survey ids"
"0","# ihsn_series <- study_df_ihsn$idno"
"0","# "
"0","# "
"0","# "
"0","# #use purr to loop over list of surveys and return some extra info"
"0","# "
"0","# series_info <- function(series) {"
"0","#       "
"0","#     info <- fromJSON(paste('https://catalog.ihsn.org/index.php/api/catalog/',series, sep=""""))"
"0","#     info$dataset$metadata$study_desc$series_statement$series_name"
"0","#       "
"0","# }"
"0","# "
"0","# #now produce a dataframe with the more info on survey"
"0","# study_df_ihsn <- study_df_ihsn %>%"
"0","#   mutate(series_info=map(ihsn_series, possibly(series_info, "
"0","#                                            otherwise = 'Something Wrong'"
"0","#                                            )"
"0","#                      )"
"0","#   )"
"0","# "
"0","# study_df_ihsn <- study_df_ihsn %>%"
"0","#   mutate(across(is.list, as.character))"
"0","# "
"0","# write_excel_csv(study_df_ihsn, paste(raw_dir, '1.4_DUAC', 'ihsn_citations.csv', sep=""/""))"
"0",""
"0","# pull in dataset with citation counts"
"0","study_df_ihsn <- read_csv(paste(raw_dir, '1.4_DUAC', 'ihsn_citations.csv', sep=""/""))"
"0",""
"0",""
"0","#categories surveys in IHSN"
"0","study_df_ihsn <- study_df_ihsn %>%"
"0","  mutate(topic=case_when("
"0","    grepl('Population|Housing|Censuses',series_info) ~ 'Population and Housing Censuses',"
"0","    grepl('lfs',series_info) ~ 'Labor Force Surveys',"
"0","    grepl('dhs|DHS|mics|MICS|whs|hea',series_info) ~ 'Health Surveys',"
"0","    grepl('ies',series_info) ~ 'Income/Expenditure Surveys',"
"0","    grepl('sems',series_info) ~ 'Socio/Economic Monitoring Surveys',"
"0","    grepl('lsms', series_info) ~ 'Living Standards Measurement Study',"
"0","    grepl('ag', series_info) ~ 'Agriculture Survey or Census',"
"0","    grepl('en', series_info) ~ 'Enterprise Survey',"
"0","    grepl('oth',series_info) ~ 'Other Household Surveys',"
"0","    grepl('Opinion', series_info) ~ 'Opinion Survey',"
"0","    TRUE ~ 'Other'"
"0","  )) %>%"
"0","  mutate(date=year_end,"
"0","         country=nation)"
"0",""
"0","##########"
"0","#Form measures of academic use"
"0","##########"
"0",""
"0","#get population data to produce per-capita measure"
"0","pop <-wbstats::wb(country=""countries_only"", "
"0","              indicator='SP.POP.TOTL',"
"0","              startdate=2004,"
"0","              enddate=2019,"
"0","              removeNA=FALSE) %>%"
"0","     transmute("
"0","       iso3c=iso3c,"
"0","       country=country,"
"0","       date=as.numeric(date),"
"0","       population=value"
"0","     )"
"0",""
"0","#get topics list"
"0","topics_list <- unique(study_df_ihsn$topic)"
"0",""
"0","  #Now calculate our SPI score for this indicator"
"0","  for (i in 2004:2019) {"
"0","   temp <- study_df_ihsn %>%"
"0","    filter(date<=i) %>% #get a list of all surveys conducted before the year"
"0","    group_by(country, topic) %>%"
"0","    summarise(total_downloads=sum(total_downloads))"
"0","   "
"0","   #add grand total"
"0","   temp_tot <- study_df_ihsn %>%"
"0","    filter(date<=i) %>% #get a list of all surveys conducted before the year"
"0","    group_by(country) %>%"
"0","    summarise(total_downloads=sum(total_downloads)) %>%"
"0","    mutate(topic=""Total"")"
"0","   "
"0","  temp <- temp %>%"
"0","    bind_rows(temp_tot) %>%"
"0","    mutate(date=i) %>% "
"0","    pivot_wider(names_from='topic',"
"0","                values_from='total_downloads') %>%"
"0","    mutate(across(topics_list, ~if_else(is.na(.),0,.))) %>%"
"0","    arrange(date, country)"
"0",""
"0",""
"0","    assign(paste('academic_use_df',i,sep=""_""), temp)"
"0","  }"
"0",""
"0","  academic_use_df <- academic_use_df_2019"
"0",""
"0","  "
"0","    "
"0","for (i in 2004:2018) {"
"0","    academic_use_df <- bind_rows(academic_use_df, get(paste('academic_use_df',i,sep=""_"")))"
"0","  }"
"0","  "
"0",""
"0",""
"0","academic_use_df <- academic_use_df %>%"
"0","  left_join(pop) %>%"
"0","  right_join(spi_df_empty) %>%"
"0","  filter(!is.na(income)) %>%"
"0","  mutate(downloads_per_capita=1000*Total/population) %>% #create measure of downloads per 1,000,000 persons"
"0","  mutate(downloads_per_capita=if_else(is.na(downloads_per_capita),0,downloads_per_capita)) %>%"
"0","  group_by(date) %>%"
"0","  mutate(academic_use_rank = rank(-downloads_per_capita)) %>%"
"0","  select(country, iso3c, date,region, downloads_per_capita, academic_use_rank)"
"0",""
"0",""
"0","academic_use_map <- academic_use_df %>%"
"0","  filter(downloads_per_capita>0)"
"0",""
"0","#add to spi databases"
"0","# spi_df <- spi_df %>%"
"0","#   left_join(academic_use_df)"
"0",""

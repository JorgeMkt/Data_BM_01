"0",""
"0",""
"0","#reshape metaadata file"
"0","metadata_3.15 <- WDI_metadata %>%"
"0","  transmute(iso3c=if_else(is.na(Country.Code), Code, Country.Code),"
"0","            date=date,"
"0","            External_debt_Reporting=External.debt.Reporting.status) %>%"
"0","  mutate(SPI.QUAL.D3.DT.TDS.DPPF.XP.ZS= case_when("
"0","            External_debt_Reporting=='Actual' ~ 0.5,"
"0","            External_debt_Reporting=='Preliminary' ~ 0.3,"
"0","            External_debt_Reporting=='Estimate' ~ 0.15,"
"0","            TRUE ~ 0"
"0","          ))"
"0",""
"0","#pull data from wdi and merge with metadata"
"0","for (reference_year in 2016:2019) {"
"0","  temp <-wbstats::wb(country=""countries_only"", "
"0","              indicator='DT.TDS.DPPF.XP.ZS',"
"0","              startdate=reference_year-5,"
"0","              enddate=reference_year,"
"0","              return_wide = T,"
"0","              removeNA=FALSE) %>%"
"0","          filter(((reference_year-as.numeric(date))<=5) & (reference_year>=as.numeric(date))) %>% #filter out years outside reference window of 3 years     "
"0","          mutate_at(.vars=c('DT.TDS.DPPF.XP.ZS'), ~if_else(is.na(.),0,1)) %>% #create 0,1 variable for whether data point exists for country"
"0","          group_by(iso3c, country) %>%"
"0","          summarise_all((~(if(is.numeric(.)) sum(., na.rm = TRUE) else first(.)))) %>% #group by country to create one observation per country                 containing whether or not data point existed"
"0","          mutate(SPI.FREQ.D3.DT.TDS.DPPF.XP.ZS = case_when("
"0","            DT.TDS.DPPF.XP.ZS>=3 ~ 0.5,"
"0","            DT.TDS.DPPF.XP.ZS==2 ~ 0.3,"
"0","            DT.TDS.DPPF.XP.ZS==1 ~ 0.15,"
"0","            DT.TDS.DPPF.XP.ZS==0 ~ 0, "
"0","            TRUE ~ 0"
"0","          )) %>% # 0.5 point for at least 3 values, 0.3 for 2 values, 0.15 for 1 values, 0 otherwise"
"0","          mutate(date=reference_year) %>%"
"0","          left_join(metadata_3.15) %>% #attach country metadata "
"0","          mutate(SPI.QUAL.D3.DT.TDS.DPPF.XP.ZS= case_when("
"0","            External_debt_Reporting=='Actual' ~ 0.5,"
"0","            External_debt_Reporting=='Preliminary' ~ 0.3,"
"0","            External_debt_Reporting=='Estimate' ~ 0.15,"
"0","            TRUE ~ 0"
"0","          )) %>% # 0.5 point for actual, 0.3 for preliminary, 0.15 for estimate"
"0","          mutate("
"0","                 SPI.D3.DT.TDS.DPPF.XP.ZS=(SPI.QUAL.D3.DT.TDS.DPPF.XP.ZS + SPI.FREQ.D3.DT.TDS.DPPF.XP.ZS)) %>%"
"0","          ungroup() %>%"
"0","          select(iso3c, country, date,  contains('D3.DT.TDS.DPPF.XP.ZS')) "
"0",""
"0",""
"0",""
"0","  assign(paste(""D3.15.AKI"",reference_year,sep=""_""), temp)"
"0","}"
"0",""
"0","D3.15.AKI <- bind_rows(D3.15.AKI_2016, D3.15.AKI_2017, D3.15.AKI_2018, D3.15.AKI_2019)  "
"0",""

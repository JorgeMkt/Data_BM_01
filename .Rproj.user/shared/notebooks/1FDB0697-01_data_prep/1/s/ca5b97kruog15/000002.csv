"0",""
"0","Request_metadata <- GET(url = ""https://api.worldbank.org/v2/sources/2/country/all/metadata?per_page=30000&format=json"")"
"0","Response_metadata <- content(Request_metadata, as = ""text"", encoding = ""UTF-8"")"
"0",""
"0","# Parse the JSON content and convert it to a data frame."
"0","JSON_metadata <- jsonlite::fromJSON(Response_metadata, flatten = TRUE) %>%"
"0","  data.frame()"
"0",""
"0","#do some conversion to produce a dataframe"
"0","df <- JSON_metadata$source.concept %>%"
"0","  data.frame() "
"0",""
"0","#do some more cleaning and conversion"
"0","df <- df$variable %>%"
"0","  data.frame()   %>%"
"0","  rename(iso3c=id) %>%"
"0","  unnest(metatype) %>%"
"0","  pivot_wider("
"0","    id_cols=iso3c,"
"0","    names_from=id,"
"0","    values_from=value"
"0","  ) "
"0",""
"0","census_df <- df %>%"
"0","  mutate(country=ShortName) %>%"
"0","  filter(!is.na(IncomeGroup)) %>%"
"0","  mutate(indicator_date=as.numeric(Latestpopulationcensus))"
"0",""
"0","#Now calculate our SPI score for this indicator"
"0","for (i in 2016:2019) {"
"0","  temp <- census_df %>%"
"0","    mutate(date=i) %>%"
"0","    mutate(last_val=str_extract(Latestpopulationcensus, ""\\d{4}"") )%>%"
"0","    mutate(last_val=as.numeric(last_val)) %>%"
"0","    mutate(indicator=case_when("
"0","      (date-last_val<=10) & (date-last_val>0) ~ 1,"
"0","      (date-last_val<=20) & (date-last_val>0) ~ 0.5,"
"0","      TRUE ~ 0 )"
"0","    )  %>%"
"0","    ungroup() %>%"
"0","    select(c('iso3c', 'country', 'date', 'last_val', 'indicator')  ) %>%"
"0","    arrange(date, country)"
"0","  "
"0","  "
"0","  assign(paste('temp',i,sep=""_""), temp)"
"0","}"
"0",""
"0","temp <- temp_2019"
"0",""
"0","for (i in 2016:2018) {"
"0","  temp <- bind_rows(temp, get(paste('temp',i,sep=""_"")))"
"0","}"
"0","temp"

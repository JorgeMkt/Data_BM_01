"0",""
"0","#Now map the result"
"0","quality = ""high"""
"0","maps <- wbgmaps::wbgmaps[[quality]]"
"0",""
"0",""
"0","country_metadata <- wbstats::wbcountries()"
"0",""
"0","data = SPI_2019"
"0",""
"0",""
"0",""
"0","spi_mapper <- function(data, indicator, title) {"
"0","  "
"0"," indicator<-indicator"
"0",""
"0","   map_df <- get(data) %>%"
"0","    filter(date==max(date, na.rm=T)) %>%"
"0","    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data."
"0","    group_by( country) %>%"
"0","    #summarise(across(!! indicator,last)) %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    select(iso3c, date, data_available, weights) %>%"
"0","    right_join(country_metadata) %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))     "
"0",""
"0",""
"0","  spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)"
"0","  "
"0","  SPI_map <- map_df %>%"
"0","    mutate(spi_groups=case_when("
"0","      between(data_available, spi_groups_quantiles[4],100) ~ ""Top 20%"","
"0","      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ ""4th Quintile"","
"0","      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ ""3rd Quintile"","
"0","      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ ""2nd Quintile"","
"0","      between(data_available, 0,spi_groups_quantiles[1]) ~ ""Bottom 20%"""
"0","      "
"0","    )) %>%"
"0","    mutate(spi_groups=factor(spi_groups, "
"0","                             levels=c(""Top 20%"",""4th Quintile"",""3rd Quintile"",""2nd Quintile"",""Bottom 20%"" )))  "
"0","  "
"0","  #set color pallete"
"0","  col_pal <- c(""#2ec4b6"",""#acece7"",""#f1dc76"",""#ffbf69"",""#ff9f1c"")  "
"0","  names(col_pal) <- c(""Top 20%"",""4th Quintile"",""3rd Quintile"",""2nd Quintile"",""Bottom 20%"" )"
"0","  "
"0","  p1<-ggplot() +"
"0","    geom_map(data = SPI_map, aes(map_id = iso3c, fill = spi_groups), map = maps$countries) + "
"0","    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = ""grey80"") + "
"0","    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = ""white"")  +"
"0","    geom_path(data = maps$boundaries,"
"0","              aes(long, lat, group = group),"
"0","              color = ""white"","
"0","              size = 0.5,"
"0","              lineend = maps$boundaries$lineend,"
"0","              linetype = maps$boundaries$linetype) +"
"0","    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +"
"0","    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +"
"0","    scale_fill_manual("
"0","      name='SPI Score',"
"0","      values=col_pal,"
"0","      na.value='grey'"
"0","    ) +"
"0","    coord_equal() +"
"0","    theme_map(base_size=12) +"
"0","    labs("
"0","      title=str_wrap(title,80),"
"0","      subtitle='Statistical Performance Indicators - Overall Scores - 2019',"
"0","      caption = 'Source: World Bank. Statistical Performance Indicators'"
"0","    ) +"
"0","    theme("
"0","    title= element_text(size = 20),"
"0","    text = element_text(size = 14)"
"0","    )"
"0"," print(p1)"
"0","}"
"0",""
"0","spi_charts  <- function(data, indicator, title) {"
"0","  "
"0"," indicator<-indicator"
"0",""
"0","  map_df <- get(data) %>%"
"0","    filter(date==max(date, na.rm=T)) %>%"
"0","    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data."
"0","    group_by( country) %>%"
"0","    #summarise(across(!! indicator,last)) %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    select(country, date, data_available, weights ) %>%"
"0","    right_join(country_metadata) %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    "
"0","  "
"0",""
"0","  #add histogram by region "
"0","  p2 <- map_df %>%"
"0","    group_by(region) %>%"
"0","    filter(region!='Aggregates') %>%"
"0","    mutate(Percentage=wtd.mean(data_available, weights = weights, na.rm=T),"
"0","           Label = paste(round(Percentage,0))) %>%"
"0","    ggplot(aes(x=Percentage, y=region, fill=region)) +"
"0","      geom_bar(stat=""identity"",position='dodge') +"
"0","      geom_text(aes(label=Label)) +"
"0","      labs("
"0","      title=str_wrap(paste(title, 'By Region', sep="" - ""),100),"
"0","      caption = 'Source: SPI Indicators Raw Data',"
"0","      subtitle= 'Data Point is for last year available (2019)'"
"0","      ) +"
"0","      expand_limits(x=c(0,100)) +"
"0","      theme_bw()"
"0","  "
"0","  #by income"
"0","    income <- c(""Low income"", ""Lower middle income"",""Upper middle income"",""High income"")"
"0",""
"0","    p3 <- map_df %>%"
"0","    group_by(income) %>%"
"0","    filter(region!='Aggregates') %>%"
"0","    mutate(Percentage=wtd.mean(data_available, weights=weights, na.rm=T),"
"0","           Label = paste(round(Percentage,0))) %>%"
"0","    ggplot(aes(x=Percentage, y=income, fill=income)) +"
"0","      geom_bar(stat=""identity"",position='dodge') +"
"0","      geom_text(aes(label=Label)) +"
"0","      labs("
"0","      title=str_wrap(paste(title, 'By Income', sep="" - ""),100),"
"0","      caption = 'Source: SPI Indicators Raw Data',"
"0","      subtitle= 'Data Point is for last year available (2019)'"
"0","      ) +"
"0","      scale_y_discrete(limits = income) +"
"0","      expand_limits(x=c(0,100)) +"
"0","      theme_bw()"
"0","    "
"0","  # #add line graph over time"
"0","  p4 <- get(data)  %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    # right_join(spi_df_empty) %>%"
"0","    group_by( date) %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available))) %>%"
"0","    mutate(Percentage=mean(data_available, na.rm=T),"
"0","           Label = paste(round(Percentage,0))) %>%"
"0","    ungroup() %>%"
"0","    ggplot(aes(y=Percentage, x=date)) +"
"0","      geom_point() +"
"0","      geom_line(fill='blue') +"
"0","      # geom_text_repel(aes(label=Label)) +"
"0","      labs("
"0","      title=str_wrap(paste(title, 'By Date', sep="" - ""),100),"
"0","      caption = 'Source: SPI Indicators Raw Data'"
"0","      ) +"
"0","    "
"0","      expand_limits(y=c(0,100)) +"
"0","      theme_bw()"
"0","      "
"0"," (p2 / p3) "
"0","    "
"0","}"
"0",""
"0","spi_country_charts  <- function(data, indicator, title) {"
"0","  "
"0",""
"0"," indicator<-indicator"
"0",""
"0","  map_df <- get(data) %>%"
"0","    filter(date==max(date, na.rm=T)) %>%"
"0","    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data."
"0","    group_by( country) %>%"
"0","    #summarise(across(!! indicator,last)) %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    select(country, date, data_available, weights ) %>%"
"0","    right_join(country_metadata) %>%"
"0","    filter(region!=""Aggregates"") %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    "
"0","  "
"0","   spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)"
"0","  "
"0","  SPI_map <- map_df %>%"
"0","    mutate(spi_groups=case_when("
"0","      between(data_available, spi_groups_quantiles[4],100) ~ ""Top 20%"","
"0","      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ ""4th Quintile"","
"0","      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ ""3rd Quintile"","
"0","      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ ""2nd Quintile"","
"0","      between(data_available, 0,spi_groups_quantiles[1]) ~ ""Bottom 20%"""
"0","      "
"0","    )) %>%"
"0","    mutate(spi_groups=factor(spi_groups, "
"0","                             levels=c(""Top 20%"",""4th Quintile"",""3rd Quintile"",""2nd Quintile"",""Bottom 20%"" )))  "
"0","  "
"0","  #set color pallete"
"0","  col_pal <- c(""#2ec4b6"",""#acece7"",""#f1dc76"",""#ffbf69"",""#ff9f1c"")  "
"0","  names(col_pal) <- c(""Top 20%"",""4th Quintile"",""3rd Quintile"",""2nd Quintile"",""Bottom 20%"" )"
"0","  "
"0",""
"0","  p2_alt <- SPI_map %>%"
"0","    ungroup() %>%"
"0","    ggplot(aes(x=data_available, y=region, color=spi_groups)) +"
"0","      geom_point() +"
"0","      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +"
"0","      labs("
"0","      title=str_wrap(title,65),"
"0","      caption = 'Source: SPI Indicators Raw Data',"
"0","      subtitle= 'Statistical Performance Indicators - Overall Scores - 2019'"
"0","      ) +"
"0","      xlab('Score') +"
"0","      expand_limits(x=c(0,100)) +"
"0","      scale_color_manual("
"0","        name='SPI Score',"
"0","        values=col_pal,"
"0","        na.value='grey'"
"0","      ) +"
"0","      theme_bw() +"
"0","      theme(legend.position = 'top',"
"0","            title= element_text(size = 20),"
"0","            axis.title.y=element_blank(),"
"0","            text = element_text(size = 14)) "
"0","   "
"0","p2_alt"
"0",""
"0","}"
"0",""
"0",""
"0",""
"0",""
"0",""
"0",""
"0",""
"0",""
"0",""

"0",""
"0","#pull SCI values"
"0",""
"0","Request_metadata <- GET(url = ""http://api.worldbank.org/v2/country/all/indicator/IQ.SCI.OVRL?format=json&date=2004:2019&per_page=5000"")"
"0","Response_metadata <- content(Request_metadata, as = ""text"", encoding = ""UTF-8"")"
"0",""
"0","# Parse the JSON content and convert it to a data frame."
"0","sci_df <- jsonlite::fromJSON(Response_metadata, flatten = TRUE) %>%"
"0","  data.frame() %>%"
"0","  transmute("
"0","    iso3c=countryiso3code,"
"0","    country=country.value,"
"0","    date=as.numeric(date),"
"0","    SCI=value"
"0","  ) %>%"
"0","  left_join(spi_df_empty) %>% #add on country metadata"
"0","  filter(!is.na(income)) %>%"
"0","  select(iso3c, country, date, SCI  ) %>%"
"0","  group_by(date) %>%"
"0","  arrange(-SCI) %>%"
"0","  mutate(SCI_rank=rank(-SCI),"
"0","         SCI_rank=if_else(is.na(SCI),as.numeric(NA),SCI_rank))"
"0",""
"0","#read in ODIN data"
"0","  for (i in 2015:2018) {"
"0","   temp <- read_csv(paste(raw_dir, '/2.2_DSOA/','ODIN_',i,'.csv', sep=""""))  %>%"
"0","        as_tibble(.name_repair = 'universal') %>%"
"0","        mutate(date=i) %>%"
"0","        filter(Data.categories=='All Categories')"
"0",""
"0",""
"0","    assign(paste('odin_df',i,sep=""_""), temp)"
"0","  }"
"0",""
"0","    #bind different years together"
"0","odin_df <- bind_rows(odin_df_2015, odin_df_2016, odin_df_2017, odin_df_2018)"
"0",""
"0",""
"0","odin_df <- odin_df %>%"
"0","    select(Country.Code, date, Overall.score) %>%"
"0","    rename(iso3c=Country.Code,"
"0","           ODIN_score=Overall.score) %>%"
"0","    group_by(date) %>%"
"0","    arrange(-ODIN_score) %>%"
"0","    mutate(ODIN_rank=rank(-ODIN_score, na.last='NA')) %>% "
"0","  right_join(spi_df_empty) %>%"
"0","  arrange(country, date) %>%"
"0","  group_by(country) %>%"
"0","  mutate(across(starts_with(""ODIN""), na.locf, na.rm=FALSE)) %>%"
"0","  select(country, date, starts_with(""ODIN""))"
"0",""
"0",""
"0","#read in the old SPI"
"0","SPI_v0_df <- readxl::read_excel(path='C:/Users/wb469649/OneDrive - WBG/DECIS/SPI_AKI/Data/FinalCopy of SPI SCORE 2016-2018-DW.xlsx', skip=2) %>%"
"0","  transmute("
"0","    iso3c=Country,"
"0","    SPI_2016=as.numeric(Overall...7),"
"0","    SPI_2017=as.numeric(Overall...12),"
"0","    SPI_2018=as.numeric(Overall...17)"
"0","  ) %>%"
"0","  pivot_longer("
"0","    cols=c('SPI_2016','SPI_2017','SPI_2018'),"
"0","    names_to=""date"","
"0","    values_to = 'SPI_v0'"
"0","  ) %>%"
"0","  mutate(date=gsub('SPI_','',date),"
"0","         date=as.numeric(date))"
"0",""
"0",""
"0","#create one database"
"0","comparison_df <- spi_index_df %>%"
"0","  ungroup() %>%"
"0","  filter(date %in% c(2016:2019)) %>%"
"0","  arrange(-SPI.INDEX) %>%"
"0","  mutate(across(starts_with('SPI.INDEX'),~1*.),"
"0","         across(starts_with('SPI.INDEX'),round,1)) %>%"
"0","  select(country, iso3c, date, income, region, SPI.INDEX) %>%"
"0","  left_join(sci_df) %>%"
"0","  left_join(odin_df) %>%"
"0","  left_join(SPI_v0_df)"
"0",""
"0",""
"0",""
"0",""

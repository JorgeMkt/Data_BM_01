"0",""
"0",""
"0",""
"0","#################"
"0","# Nested Index with high income, OECD coutries top coded"
"0","################"
"0","  spi_index_df_dim3_alt <- spi_index_df_temp %>%"
"0","  arrange(country, date) %>%"
"0","  group_by(country) %>%"
"0","  mutate(across(starts_with(""SPI""), na.locf, na.rm=FALSE)) %>%"
"0","  select(country, iso3c, date, everything()) %>%"
"0","  mutate(across(starts_with(""SPI.D3""),"
"0","                ~if_else(( (income=='High income')  & (country %in% oecd_country_df$name)),1,.)                )) "
"0",""
"0",""
"0",""
"0","#Create overall subscores corresponding to John's framework"
"0","  spi_index_df_dim3_alt <- spi_index_df_dim3_alt %>%"
"0","    mutate(INDEX.SPI.D2.1=rowMeans(across(starts_with('SPI.D2.1'))),"
"0","         INDEX.SPI.D2.2=SPI.D2.2.Openness.subscore,"
"0","         INDEX.SPI.D2.4=SPI.D2.4.NADA,"
"0","         INDEX.SPI.D3.1=rowMeans(across(c(""SPI.D3.1.POV"","
"0","                                            ""SPI.D3.2.HNGR"","
"0","                                            ""SPI.D3.3.HLTH"","
"0","                                            ""SPI.D3.4.EDUC"","
"0","                                            ""SPI.D3.5.GEND"","
"0","                                            ""SPI.D3.6.WTRS""))),"
"0","         INDEX.SPI.D3.2=rowMeans(across(c(""SPI.D3.7.ENRG"","
"0","                                            ""SPI.D3.8.WORK"","
"0","                                            ""SPI.D3.9.INDY"","
"0","                                            ""SPI.D3.10.NEQL"","
"0","                                            ""SPI.D3.11.CITY"","
"0","                                            ""SPI.D3.12.CNSP""))),         "
"0","         INDEX.SPI.D3.3=rowMeans(across(c(""SPI.D3.13.CLMT"","
"0","                                            ""SPI.D3.15.LAND"" ))),"
"0","         INDEX.SPI.D3.4=rowMeans(across(c(""SPI.D3.16.INST"","
"0","                                            ""SPI.D3.17.PTNS"" ))),"
"0","         INDEX.SPI.D4.1=rowMeans(across(starts_with('SPI.D4.1'))),"
"0","         INDEX.SPI.D4.2=rowMeans(across(starts_with('SPI.D4.2'))),"
"0","         INDEX.SPI.D4.3=rowMeans(across(starts_with('SPI.D4.3'))),"
"0","         #INDEX.SPI.D5.1=rowMeans(across(starts_with('SPI.D5.1'))),"
"0","         INDEX.SPI.D5.2=rowMeans(across(starts_with('SPI.D5.2'))),"
"0","         #INDEX.SPI.D5.5=rowMeans(across(starts_with('SPI.D5.5')))"
"0","                 ) %>%"
"0","  mutate("
"0","         SPI.INDEX.DIM1=rowMeans(across(starts_with(""SPI.D1.5"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM2=rowMeans(across(starts_with(""INDEX.SPI.D2"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM3.ALT=(6*INDEX.SPI.D3.1 + 6*INDEX.SPI.D3.2 + 2*INDEX.SPI.D3.3 + 2*INDEX.SPI.D3.4)/16,"
"0","         SPI.INDEX.DIM4=rowMeans(across(starts_with(""INDEX.SPI.D4"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM5=rowMeans(across(starts_with(""INDEX.SPI.D5"")), na.rm=FALSE),"
"0","         SPI.INDEX.ALT=rowMeans(across(c('SPI.INDEX.DIM1',"
"0","                                     'SPI.INDEX.DIM2',"
"0","                                     'SPI.INDEX.DIM3.ALT',"
"0","                                     'SPI.INDEX.DIM4',"
"0","                                     'SPI.INDEX.DIM5')), na.rm=FALSE)"
"0","         ) %>% #"
"0","  mutate(across(starts_with('SPI.INDEX'),~100*.)) %>%"
"0","  arrange(-date, -SPI.INDEX.ALT) %>%"
"0","  select(country, iso3c, date, starts_with('SPI.INDEX'), everything()) %>%"
"0","    filter(date>=2016) #2016 is first year with complete data"
"0",""
"0",""
"0","#################"
"0","# Nested Index with high income coutries top coded"
"0","################"
"0","  spi_index_df_dim3_alt2 <- spi_index_df_temp %>%"
"0","  arrange(country, date) %>%"
"0","  group_by(country) %>%"
"0","  mutate(across(starts_with(""SPI""), na.locf, na.rm=FALSE)) %>%"
"0","  select(country, iso3c, date, everything()) %>%"
"0","  mutate(across(starts_with(""SPI.D3""),"
"0","                ~if_else(( (income=='High income')  ),1,.)                )) "
"0",""
"0",""
"0",""
"0","#Create overall subscores corresponding to John's framework"
"0","  spi_index_df_dim3_alt2 <- spi_index_df_dim3_alt2 %>%"
"0","    mutate(INDEX.SPI.D2.1=rowMeans(across(starts_with('SPI.D2.1'))),"
"0","         INDEX.SPI.D2.2=SPI.D2.2.Openness.subscore,"
"0","         INDEX.SPI.D2.4=SPI.D2.4.NADA,"
"0","         INDEX.SPI.D3.1=rowMeans(across(c(""SPI.D3.1.POV"","
"0","                                            ""SPI.D3.2.HNGR"","
"0","                                            ""SPI.D3.3.HLTH"","
"0","                                            ""SPI.D3.4.EDUC"","
"0","                                            ""SPI.D3.5.GEND"","
"0","                                            ""SPI.D3.6.WTRS""))),"
"0","         INDEX.SPI.D3.2=rowMeans(across(c(""SPI.D3.7.ENRG"","
"0","                                            ""SPI.D3.8.WORK"","
"0","                                            ""SPI.D3.9.INDY"","
"0","                                            ""SPI.D3.10.NEQL"","
"0","                                            ""SPI.D3.11.CITY"","
"0","                                            ""SPI.D3.12.CNSP""))),         "
"0","         INDEX.SPI.D3.3=rowMeans(across(c(""SPI.D3.13.CLMT"","
"0","                                            ""SPI.D3.15.LAND"" ))),"
"0","         INDEX.SPI.D3.4=rowMeans(across(c(""SPI.D3.16.INST"","
"0","                                            ""SPI.D3.17.PTNS"" ))),"
"0","         INDEX.SPI.D4.1=rowMeans(across(starts_with('SPI.D4.1'))),"
"0","         INDEX.SPI.D4.2=rowMeans(across(starts_with('SPI.D4.2'))),"
"0","         INDEX.SPI.D4.3=rowMeans(across(starts_with('SPI.D4.3'))),"
"0","         #INDEX.SPI.D5.1=rowMeans(across(starts_with('SPI.D5.1'))),"
"0","         INDEX.SPI.D5.2=rowMeans(across(starts_with('SPI.D5.2'))),"
"0","         #INDEX.SPI.D5.5=rowMeans(across(starts_with('SPI.D5.5')))"
"0","                 ) %>%"
"0","  mutate("
"0","         SPI.INDEX.DIM1=rowMeans(across(starts_with(""SPI.D1.5"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM2=rowMeans(across(starts_with(""INDEX.SPI.D2"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM3.ALT2=(6*INDEX.SPI.D3.1 + 6*INDEX.SPI.D3.2 + 2*INDEX.SPI.D3.3 + 2*INDEX.SPI.D3.4)/16,"
"0","         SPI.INDEX.DIM4=rowMeans(across(starts_with(""INDEX.SPI.D4"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM5=rowMeans(across(starts_with(""INDEX.SPI.D5"")), na.rm=FALSE),"
"0","         SPI.INDEX.ALT2=rowMeans(across(c('SPI.INDEX.DIM1',"
"0","                                     'SPI.INDEX.DIM2',"
"0","                                     'SPI.INDEX.DIM3.ALT2',"
"0","                                     'SPI.INDEX.DIM4',"
"0","                                     'SPI.INDEX.DIM5')), na.rm=FALSE)"
"0","         ) %>% #"
"0","  mutate(across(starts_with('SPI.INDEX'),~100*.)) %>%"
"0","  arrange(-date, -SPI.INDEX.ALT2) %>%"
"0","  select(country, iso3c, date, SPI.INDEX.ALT2,SPI.INDEX.DIM3.ALT2) %>%"
"0","    mutate(weights=1) %>%"
"0","    filter(date>=2016) #2016 is first year with complete data"
"0"," "
"0","#merge the two indices and compare  "
"0","index_compare <- spi_index_df_dim3_alt %>%"
"0","  transmute("
"0","    country=country,"
"0","    iso3c=iso3c,"
"0","    date=date,"
"0","    SPI.INDEX.ALT=SPI.INDEX.ALT"
"0","  ) %>%"
"0","  filter(date==2019) %>%"
"0","  filter(!is.na(SPI.INDEX.ALT)) %>%"
"0","  left_join(select(spi_index_df, country, date, SPI.INDEX) ) %>%"
"0","  left_join(spi_index_df_dim3_alt2) %>%"
"0","  select(-SPI.INDEX.DIM3.ALT2)"
"0",""
"0","    spi_groups_quantiles <- quantile(index_compare$SPI.INDEX, probs=c(1,2,3,4)/5,na.rm=T)"
"0","    spi_alt_groups_quantiles <- quantile(index_compare$SPI.INDEX.ALT, probs=c(1,2,3,4)/5,na.rm=T)"
"0","    spi_alt2_groups_quantiles <- quantile(index_compare$SPI.INDEX.ALT2, probs=c(1,2,3,4)/5,na.rm=T)"
"0",""
"0","    index_compare <- index_compare %>%"
"0","      mutate(spi_groups=case_when("
"0","        between(SPI.INDEX, spi_groups_quantiles[4],100) ~ ""Top 20%"","
"0","        between(SPI.INDEX, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ ""4th Quintile"","
"0","        between(SPI.INDEX, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ ""3rd Quintile"","
"0","        between(SPI.INDEX, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ ""2nd Quintile"","
"0","        between(SPI.INDEX, 0,spi_groups_quantiles[1]) ~ ""Bottom 20%"""
"0","      )) %>%"
"0","      mutate(spi_groups=factor(spi_groups, "
"0","                               levels=c(""Top 20%"",""4th Quintile"",""3rd Quintile"",""2nd Quintile"",""Bottom 20%"" )))  %>%"
"0","      mutate(spi_alt_groups=case_when("
"0","        between(SPI.INDEX.ALT, spi_alt_groups_quantiles[4],100) ~ ""Top 20%"","
"0","        between(SPI.INDEX.ALT, spi_alt_groups_quantiles[3],spi_alt_groups_quantiles[4]) ~ ""4th Quintile"","
"0","        between(SPI.INDEX.ALT, spi_alt_groups_quantiles[2],spi_alt_groups_quantiles[3]) ~ ""3rd Quintile"","
"0","        between(SPI.INDEX.ALT, spi_alt_groups_quantiles[1],spi_alt_groups_quantiles[2]) ~ ""2nd Quintile"","
"0","        between(SPI.INDEX.ALT, 0,spi_alt_groups_quantiles[1]) ~ ""Bottom 20%"""
"0","      )) %>%"
"0","      mutate(spi_alt_groups=factor(spi_alt_groups, "
"0","                               levels=c(""Top 20%"",""4th Quintile"",""3rd Quintile"",""2nd Quintile"",""Bottom 20%"" ))) %>%"
"0","      mutate(spi_alt2_groups=case_when("
"0","        between(SPI.INDEX.ALT2, spi_alt2_groups_quantiles[4],100) ~ ""Top 20%"","
"0","        between(SPI.INDEX.ALT2, spi_alt2_groups_quantiles[3],spi_alt2_groups_quantiles[4]) ~ ""4th Quintile"","
"0","        between(SPI.INDEX.ALT2, spi_alt2_groups_quantiles[2],spi_alt2_groups_quantiles[3]) ~ ""3rd Quintile"","
"0","        between(SPI.INDEX.ALT2, spi_alt2_groups_quantiles[1],spi_alt2_groups_quantiles[2]) ~ ""2nd Quintile"","
"0","        between(SPI.INDEX.ALT2, 0,spi_alt2_groups_quantiles[1]) ~ ""Bottom 20%"""
"0","      )) %>%"
"0","      mutate(spi_alt2_groups=factor(spi_alt2_groups, "
"0","                               levels=c(""Top 20%"",""4th Quintile"",""3rd Quintile"",""2nd Quintile"",""Bottom 20%"" ))) %>%"
"0","      mutate(weights=1)"
"0",""
"0",""

"0",""
"0","leave_out_fun <-  function(variables) {"
"0","  "
"0","spi_index_df_alt <- spi_index_df_temp %>%"
"0","  arrange(country, date) %>%"
"0","  group_by(country) %>%"
"0","  mutate(across(starts_with(""SPI""), na.locf, na.rm=FALSE)) %>%"
"0","  mutate(across(starts_with(variables),~as.numeric(NA))) %>% #convert selected variable to missing values then begin calculation without them"
"0","  select(country, iso3c, date, everything())"
"0",""
"0",""
"0",""
"0","#Create overall subscores corresponding to John's framework"
"0","spi_index_df_alt <- spi_index_df_alt %>%"
"0","  mutate(INDEX.SPI.D2.1=rowMeans(across(starts_with('SPI.D2.1'))),"
"0","         INDEX.SPI.D2.2=SPI.D2.2.Openness.subscore,"
"0","         INDEX.SPI.D2.4=SPI.D2.4.NADA,"
"0","         INDEX.SPI.D3.1=rowMeans(across(c(""SPI.D3.1.POV"","
"0","                                          ""SPI.D3.2.HNGR"","
"0","                                          ""SPI.D3.3.HLTH"","
"0","                                          ""SPI.D3.4.EDUC"","
"0","                                          ""SPI.D3.5.GEND"","
"0","                                          ""SPI.D3.6.WTRS"")), na.rm=TRUE),"
"0","         INDEX.SPI.D3.2=rowMeans(across(c(""SPI.D3.7.ENRG"","
"0","                                          ""SPI.D3.8.WORK"","
"0","                                          ""SPI.D3.9.INDY"","
"0","                                          ""SPI.D3.10.NEQL"","
"0","                                          ""SPI.D3.11.CITY"","
"0","                                          ""SPI.D3.12.CNSP"")), na.rm=TRUE),         "
"0","         INDEX.SPI.D3.3=rowMeans(across(c(""SPI.D3.13.CLMT"","
"0","                                          ""SPI.D3.15.LAND"" )), na.rm=TRUE),"
"0","         INDEX.SPI.D3.4=rowMeans(across(c(""SPI.D3.16.INST"","
"0","                                          ""SPI.D3.17.PTNS"" )), na.rm=TRUE),"
"0","         INDEX.SPI.D4.1=rowMeans(across(starts_with('SPI.D4.1')), na.rm=TRUE),"
"0","         INDEX.SPI.D4.2=rowMeans(across(starts_with('SPI.D4.2')), na.rm=TRUE),"
"0","         INDEX.SPI.D4.3=rowMeans(across(starts_with('SPI.D4.3')), na.rm=TRUE),"
"0","         #INDEX.SPI.D5.1=rowMeans(across(starts_with('SPI.D5.1'))),"
"0","         INDEX.SPI.D5.2=rowMeans(across(starts_with('SPI.D5.2')), na.rm=TRUE),"
"0","         #INDEX.SPI.D5.5=rowMeans(across(starts_with('SPI.D5.5')))"
"0","  ) %>%"
"0","  mutate("
"0","    SPI.INDEX.DIM1=rowMeans(across(starts_with(""SPI.D1.5"")), na.rm=TRUE),"
"0","    SPI.INDEX.DIM2=rowMeans(across(starts_with(""INDEX.SPI.D2"")), na.rm=TRUE),"
"0","    SPI.INDEX.DIM3=(6*INDEX.SPI.D3.1 + 6*INDEX.SPI.D3.2 + 2*INDEX.SPI.D3.3 + 2*INDEX.SPI.D3.4)/16,"
"0","    SPI.INDEX.DIM4=rowMeans(across(starts_with(""INDEX.SPI.D4"")), na.rm=TRUE),"
"0","    SPI.INDEX.DIM5=rowMeans(across(starts_with(""INDEX.SPI.D5"")), na.rm=TRUE),"
"0","    SPI.INDEX.ALT=rowMeans(across(c('SPI.INDEX.DIM1',"
"0","                                    'SPI.INDEX.DIM2',"
"0","                                    'SPI.INDEX.DIM3',"
"0","                                    'SPI.INDEX.DIM4',"
"0","                                    'SPI.INDEX.DIM5')), na.rm=TRUE)"
"0","  ) %>% #"
"0","  mutate(across(starts_with('SPI.INDEX'),~100*.)) %>%"
"0","  arrange(-date, -SPI.INDEX.ALT) %>%"
"0","  select(country, iso3c, date, SPI.INDEX.ALT) %>%"
"0","  filter(date>=2016) #2016 is first year with complete data"
"0",""
"0","  #form database with both measures"
"0","  spi_index_df %>%"
"0","    select(country, iso3c, date, SPI.INDEX) %>%"
"0","    left_join(spi_index_df_alt) %>%"
"0","    ungroup() %>%"
"0","    summarise(mean_abs_diff=mean(abs(SPI.INDEX-SPI.INDEX.ALT), na.rm=T))"
"0",""
"0","  "
"0","}"
"0",""
"0","leave_out_df <- metadata_full %>%"
"0","  filter(!grepl('SPI.INDEX|RAW.',source_id)) %>%"
"0","  nest(source_id) %>%"
"0","  mutate("
"0","    ABS.DIFF=map("
"0","      data,"
"0","      ~leave_out_fun(.x$source_id)"
"0","    )"
"0","  ) %>%"
"0","  unnest(ABS.DIFF)"
"0",""
"0",""

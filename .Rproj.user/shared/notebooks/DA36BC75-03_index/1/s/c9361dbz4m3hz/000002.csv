"0","#get a list of oecd countries"
"0","oecd_country_query <-  GET(url = ""https://api.worldbank.org/v2/country?region=OED&format=json"") %>%"
"0","  content( as = ""text"", encoding = ""UTF-8"") %>%"
"0","  jsonlite::fromJSON( flatten = TRUE) "
"0",""
"0","#do some conversion to produce a dataframe"
"0","oecd_country_df <- oecd_country_query[[2]] %>%"
"0","  as_tibble() "
"0","  "
"0","country_mod_list <- oecd_country_df$name  #fill in the missing values for OECDs with 1s because by participating in OECD these countries have this"
"0","country_mod_list <- c(country_mod_list, 'Singapore')"
"0","# create index dataset"
"0","spi_index_df_temp <- spi_df_final %>%"
"0","  select(country, iso3c, date, starts_with(""SPI""), income, region, weights, population) %>%"
"0","  arrange(-date,country)"
"0",""
"0","#Drop certain indicators that don't make cut because of imcomplete coverage usually"
"0","spi_index_df_temp <- spi_index_df_temp %>%"
"0","  select( -SPI.D5.3.DISK, -SPI.D4.3.GEO.second.admin.level,, -SPI.D4.2.1.SPL, -SPI.D4.2.4.LBR) "
"0",""
"0",""
"0",""
"0",""
"0",""
"0","#first index "
"0","# just take a simple numeric average acorss all indicators"
"0","# I will forward fill all indicators if they are missing"
"0","spi_index_simple <- spi_index_df_temp %>%"
"0","  arrange(country, date) %>%"
"0","  group_by(country) %>%"
"0","  select(-starts_with(""SPI.D1"")) %>%"
"0","  mutate(across(starts_with(""SPI""), na.locf, na.rm=FALSE)) %>%"
"0","  mutate(across(c(""SPI.D2.1.GDDS"",""SPI.D2.4.NADA"",""SPI.D4.1.1.POPU"",""SPI.D4.1.2.AGRI"",""SPI.D4.1.3.BIZZ"",""SPI.D4.1.4.HOUS"",""SPI.D4.1.5.AGSVY"","
"0","                  ""SPI.D4.1.6.LABR"",""SPI.D4.1.7.HLTH"",""SPI.D4.1.8.BZSVY"","
"0","                  ""SPI.D5.2.1.SNAU"", ""SPI.D5.2.2.NABY"", ""SPI.D5.2.1.SNAU"",""SPI.D5.2.2.NABY"",                "
"0","                  ""SPI.D5.2.3.CNIN"", ""SPI.D5.2.4.CPIBY"", ""SPI.D5.2.5.HOUS"", ""SPI.D5.2.6.EMPL"",""SPI.D5.2.7.CGOV"", ""SPI.D5.2.8.FINA"","
"0","                  ""SPI.D5.2.9.MONY"", ""SPI.D5.2.10.GSBP"" ),"
"0","                ~if_else(( (income=='High income') & (country %in% country_mod_list)),1,.)                )) %>% "
"0","  mutate(SPI.INDEX=rowMeans(across(starts_with(""SPI"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM2=rowMeans(across(starts_with(""SPI.D2"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM3=rowMeans(across(starts_with(""SPI.D3"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM4=rowMeans(across(starts_with(""SPI.D4"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM5=rowMeans(across(starts_with(""SPI.D5"")), na.rm=FALSE)"
"0","         ) %>% #"
"0","  arrange(-date, -SPI.INDEX) %>%"
"0","  select(country, iso3c, date, starts_with('SPI.INDEX'), everything())"
"0",""
"0",""
"0","#################"
"0","# Nested Index"
"0","################"
"0","  spi_index_df <- spi_index_df_temp %>%"
"0","  arrange(country, date) %>%"
"0","  group_by(country) %>%"
"0","  mutate(across(starts_with(""SPI""), na.locf, na.rm=FALSE)) %>%"
"0","  mutate(across(c(""SPI.D1.5.POV"","
"0","                  ""SPI.D2.1.GDDS"",""SPI.D2.4.NADA"",""SPI.D4.1.1.POPU"",""SPI.D4.1.2.AGRI"",""SPI.D4.1.3.BIZZ"",""SPI.D4.1.4.HOUS"",""SPI.D4.1.5.AGSVY"","
"0","                  ""SPI.D4.1.6.LABR"",""SPI.D4.1.7.HLTH"",""SPI.D4.1.8.BZSVY"","
"0","                  ""SPI.D5.2.1.SNAU"", ""SPI.D5.2.2.NABY"", ""SPI.D5.2.1.SNAU"",""SPI.D5.2.2.NABY"",                "
"0","                  ""SPI.D5.2.3.CNIN"", ""SPI.D5.2.4.CPIBY"", ""SPI.D5.2.5.HOUS"", ""SPI.D5.2.6.EMPL"",""SPI.D5.2.7.CGOV"", ""SPI.D5.2.8.FINA"","
"0","                  ""SPI.D5.2.9.MONY"", ""SPI.D5.2.10.GSBP"" ),"
"0","                ~if_else(( (income=='High income') & (country %in% country_mod_list)),1,.)                )) %>% "
"0","  select(country, iso3c, date, everything())"
"0",""
"0",""
"0",""
"0","#Create overall subscores corresponding to John's framework"
"0","  spi_index_df <- spi_index_df %>%"
"0","    mutate(INDEX.SPI.D2.1=rowMeans(across(starts_with('SPI.D2.1'))),"
"0","         INDEX.SPI.D2.2=SPI.D2.2.Openness.subscore,"
"0","         INDEX.SPI.D2.4=SPI.D2.4.NADA,"
"0","         INDEX.SPI.D3.1=rowMeans(across(c(""SPI.D3.1.POV"","
"0","                                            ""SPI.D3.2.HNGR"","
"0","                                            ""SPI.D3.3.HLTH"","
"0","                                            ""SPI.D3.4.EDUC"","
"0","                                            ""SPI.D3.5.GEND"","
"0","                                            ""SPI.D3.6.WTRS""))),"
"0","         INDEX.SPI.D3.2=rowMeans(across(c(""SPI.D3.7.ENRG"","
"0","                                            ""SPI.D3.8.WORK"","
"0","                                            ""SPI.D3.9.INDY"","
"0","                                            ""SPI.D3.10.NEQL"","
"0","                                            ""SPI.D3.11.CITY"","
"0","                                            ""SPI.D3.12.CNSP""))),         "
"0","         INDEX.SPI.D3.3=rowMeans(across(c(""SPI.D3.13.CLMT"","
"0","                                            ""SPI.D3.15.LAND"" ))),"
"0","         INDEX.SPI.D3.4=rowMeans(across(c(""SPI.D3.16.INST"","
"0","                                            ""SPI.D3.17.PTNS"" ))),"
"0","         INDEX.SPI.D4.1=rowMeans(across(starts_with('SPI.D4.1'))),"
"0","         INDEX.SPI.D4.2=rowMeans(across(starts_with('SPI.D4.2'))),"
"0","         INDEX.SPI.D4.3=rowMeans(across(starts_with('SPI.D4.3'))),"
"0","         #INDEX.SPI.D5.1=rowMeans(across(starts_with('SPI.D5.1'))),"
"0","         INDEX.SPI.D5.2=rowMeans(across(starts_with('SPI.D5.2'))),"
"0","         #INDEX.SPI.D5.5=rowMeans(across(starts_with('SPI.D5.5')))"
"0","                 ) %>%"
"0","  mutate("
"0","         SPI.INDEX.DIM1=rowMeans(across(starts_with(""SPI.D1.5"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM2=rowMeans(across(starts_with(""INDEX.SPI.D2"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM3=rowMeans(across(starts_with(""INDEX.SPI.D3"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM4=rowMeans(across(starts_with(""INDEX.SPI.D4"")), na.rm=FALSE),"
"0","         SPI.INDEX.DIM5=rowMeans(across(starts_with(""INDEX.SPI.D5"")), na.rm=FALSE),"
"0","         SPI.INDEX=rowMeans(across(c('SPI.INDEX.DIM1',"
"0","                                     'SPI.INDEX.DIM2',"
"0","                                     'SPI.INDEX.DIM3',"
"0","                                     'SPI.INDEX.DIM4',"
"0","                                     'SPI.INDEX.DIM5')), na.rm=FALSE)"
"0","         ) %>% #"
"0","  arrange(-date, -SPI.INDEX) %>%"
"0","  select(country, iso3c, date, starts_with('SPI.INDEX'), everything()) %>%"
"0","    filter(date>=2016) #2016 is first year with complete data "
"0",""
"0","  "
"0","#display top 25"
"0","index_disp <- spi_index_df %>%"
"0","  ungroup() %>%"
"0","  filter(date==2019) %>%"
"0","  arrange(-SPI.INDEX) %>%"
"0","  mutate(across(starts_with('SPI.INDEX'),~100*.),"
"0","         across(starts_with('SPI.INDEX'),round,1)) %>%"
"0","  select(country, iso3c, date, starts_with('SPI.INDEX'))"
"0",""
"0",""
"0","spi_index_df %>%"
"0","  write_excel_csv(path=paste(output_dir, 'SPI_index.csv', sep=""/""))"
"0",""
"0",""
"0",""
"0",""
"0",""

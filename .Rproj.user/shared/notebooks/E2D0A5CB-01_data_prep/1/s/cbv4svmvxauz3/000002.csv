"0",""
"0","#Read in data from UN Inter-agency Group for Child Mortality Estimation"
"0",""
"0",""
"0",""
"0","D3.3.AKI.MORT <- read_csv(file=paste(raw_dir, '1.5_DUIO/UN IGME Child Mortality and Stillbirth Estimates.csv', sep=""/"")) %>%"
"0","  as_tibble(.name_repair = 'universal') %>%"
"0","  filter(Indicator=='Under-five mortality rate' & Sex=='Total') %>% #keep just observations for under 5 child mortality and for both sexes"
"0","  filter(Observation.Status=='Included in IGME') %>% # Also keep only surveys that met IGME criteria for inclusion as a nationally representative statistic"
"0","  mutate(date=as.numeric(str_extract(Series.Year, ""^.{4}"")),"
"0","         country=Geographic.area,"
"0","         D3.CHLD.MORT=OBS_VALUE)"
"0",""
"0","#Now loop from 2016 and 2019, keeping just data inside last 5 years."
"0","for (reference_year in 2004:2019) {"
"0","  "
"0","  "
"0","      #extend the window for more recent years.  For instance, 2019 surveys are reported with a lag, so give them two year grace period"
"0","  if (reference_year==2019) {"
"0","    rec_window=7"
"0","  } else if (reference_year==2018) {"
"0","    rec_window=6"
"0","  } else {"
"0","    rec_window=5"
"0","  }"
"0"," "
"0","  "
"0","  temp_5 <-D3.3.AKI.MORT %>%"
"0","          mutate(frequency=((reference_year-as.numeric(date))<=rec_window) & (reference_year>=as.numeric(date))) %>%"
"0","          mutate(SPI.FREQ.D1.5.CHLD.MORT=if_else(frequency==TRUE,1,0)) %>% #create 0,1 variable for whether data point exists for country"
"0","          group_by(country) %>%"
"0","          summarise(SPI.FREQ.D1.5.CHLD.MORT=sum(SPI.FREQ.D1.5.CHLD.MORT, na.rm=T)) %>%"
"0","          mutate(SPI.FREQ.D1.5.CHLD.MORT=case_when("
"0","            SPI.FREQ.D1.5.CHLD.MORT>=2 ~ 1,"
"0","            TRUE ~ 0"
"0","          )) %>%"
"0","          mutate(SPI.D1.5.CHLD.MORT_5=SPI.FREQ.D1.5.CHLD.MORT) %>%"
"0","          mutate(date=reference_year) %>%"
"0","          select( country, date, starts_with('SPI.')) %>%"
"0","          select(-SPI.FREQ.D1.5.CHLD.MORT)"
"0",""
"0","  temp_10 <-D3.3.AKI.MORT %>%"
"0","          mutate(frequency=((reference_year-as.numeric(date))<=rec_window) & (reference_year>=as.numeric(date))) %>%"
"0","          mutate(SPI.FREQ.D1.5.CHLD.MORT=if_else(frequency==TRUE,1,0)) %>% #create 0,1 variable for whether data point exists for country"
"0","          group_by(country) %>%"
"0","          summarise(SPI.FREQ.D1.5.CHLD.MORT=sum(SPI.FREQ.D1.5.CHLD.MORT, na.rm=T)) %>%"
"0","          mutate(SPI.FREQ.D1.5.CHLD.MORT=case_when("
"0","            SPI.FREQ.D1.5.CHLD.MORT>=2 ~ 1,"
"0","            TRUE ~ 0"
"0","          )) %>%"
"0","          mutate(SPI.D1.5.CHLD.MORT_10=SPI.FREQ.D1.5.CHLD.MORT) %>%"
"0","          mutate(date=reference_year) %>%"
"0","          select( country, date, starts_with('SPI.')) %>%"
"0","          select(-SPI.FREQ.D1.5.CHLD.MORT)"
"0","  "
"0","  temp <- temp_5 %>%"
"0","    left_join(temp_10) %>%"
"0","    mutate(SPI.D1.5.CHLD.MORT=case_when("
"0","      SPI.D1.5.CHLD.MORT_5==1 ~ 1,"
"0","      SPI.D1.5.CHLD.MORT_10==1 ~ 0.5,"
"0","      TRUE ~ 0"
"0","    )) %>%"
"0","    select(-SPI.D1.5.CHLD.MORT_5,-SPI.D1.5.CHLD.MORT_10)"
"0","  "
"0","  assign(paste(""D3.3.AKI"",reference_year,sep=""_""), temp)"
"0","}"
"0",""
"0","#now append together and save"
"0","for (i in c(2004:2019)) {"
"0","  "
"0","  temp<-get(paste('D3.3.AKI_',i, sep=""""))"
"0","  "
"0","  if (!exists('D3.3.AKI')) {"
"0","    D3.3.AKI<-temp"
"0","  } else {"
"0","    D3.3.AKI<-D3.3.AKI %>%"
"0","      bind_rows(temp) %>%"
"0","      arrange(-date, country)"
"0","  }"
"0","}"
"0",""
"0",""

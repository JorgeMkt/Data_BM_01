---
title: "Country Report"
author: "Brian Stacy"
date: "`r Sys.Date()`"
output: bookdown::word_document2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 6, fig.cap = "", dpi=250)
library(tidyverse)
library(flextable)
library(here)
library(patchwork)
library(colorspace)
#set directories
dir <- here()

raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")

#weights (either unity (1) or population)
wgt <- 1

#set the country and year for the report
cntry <- "United Kingdom"
yr <- 2019
```


```{r load, include=FALSE}

#add in population
pop_df <- wbstats::wb_data(country="all",
             indicator='SP.POP.TOTL',
             start_date=2004,
             end_date=2019) %>%
  mutate(date=as.numeric(date)) %>%
  mutate(population=SP.POP.TOTL) %>%
  select(country, date, population) 

#import data
SPI <- read_csv(paste(output_dir, 'SPI_index.csv', sep="/")) %>%
    left_join(pop_df) %>%
  mutate(weights=wgt)  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.

spi_index_df <- SPI



#read in the SPI dataset
spi_df_final <- read_csv( file = paste(output_dir, 'SPI_data.csv', sep="/")) %>%
  left_join(pop_df) %>%
  mutate(weights=wgt)  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.



#metadata 
metadata <- read_csv(paste(raw_dir, '/metadata/SPI_dimensions_sources.csv', sep=""))

metadata_full <- read_csv(paste(raw_dir, '/metadata/SPI_index_sources.csv', sep="")) %>%
  rename(source_name=descript) %>%
  bind_rows(metadata)

#get list of country info
country_list <- wbstats::wb_countries()


SPI_2019 <- SPI %>%
  filter(date==2019) %>%
  filter(!is.na(SPI.INDEX) & !is.na(weights)) %>%
  mutate(ISO_A3_EH=iso3c) 

#read in TopoJSON from World Bank
#countries <- geojsonio::geojson_read("WB_countries_Admin0_lowres.geojson",
#                                     what = "sp")

```

```{r spi_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}

#For mapping the result
# quality = "high"
# maps <- wbgmaps::wbgmaps[[quality]]
#load world bank map data
load(paste0(raw_dir, '/misc/maps.Rdata'))
standard_crop_wintri <- function() {
  l <- list(
    left=-12000000, right=16396891,
    top=9400000, bottom=-6500000
  )
  l$xlim <- c(l$left, l$right)
  l$ylim <- c(l$bottom, l$top)
  l
}


country_metadata <- wbstats::wbcountries()

data = SPI_2019



spi_mapper <- function(data, indicator, title) {
  
 indicator<-indicator

   map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))     


  spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)
  
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      between(data_available, spi_groups_quantiles[4],100) ~ "Top 20%",
      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
      between(data_available, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Top 20%","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
  

  #set color pallete
  col_pal <- c("#2ec4b6","#acece7","#f1dc76","#ffbf69","#ff9f1c")  
  names(col_pal) <- c("Top 20%","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )
  
  p1<-ggplot() +
    geom_map(data = SPI_map, aes(map_id = iso3c, fill = spi_groups), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
    geom_path(data = maps$boundaries,
              aes(long, lat, group = group),
              color = "white",
              size = 0.4,
              lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
    scale_fill_manual(
      name='SPI Score',
      values=col_pal,
      na.value='grey'
    ) +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap(title,100),
      caption = 'Source: World Bank. Statistical Performance Indicators'
    ) +
    theme(
      text=element_text(size=14)
    )
 print(p1)
}

spi_charts  <- function(data, indicator, title) {
  
 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  #add histogram by region 
  p2 <- map_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Region', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
    theme(
      text=element_text(size=14)
    )
  
  #by income
    income <- c("Low income", "Lower middle income","Upper middle income","High income")

    p3 <- map_df %>%
    group_by(income) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=wtd.mean(data_available, weights=weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=income, fill=income)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = income) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
    theme(
      text=element_text(size=14)
    )
    
  # #add line graph over time
  p4 <- get(data)  %>%
    rename(data_available=!! indicator) %>%
    # right_join(spi_df_empty) %>%
    group_by( date) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available))) %>%
    mutate(Percentage=mean(data_available, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ungroup() %>%
    ggplot(aes(y=Percentage, x=date)) +
      geom_point() +
      geom_line(fill='blue') +
      # geom_text_repel(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Date', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data'
      ) +
    
      expand_limits(y=c(0,100)) +
      theme_bw() +
    theme(
      text=element_text(size=14)
    )
      
 (p2 / p3) 
    
}


spi_country_charts  <- function(data, indicator, title) {
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    filter(region!="Aggregates") %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  
   spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)
  
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      between(data_available, spi_groups_quantiles[4],100) ~ "Top 20%",
      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
      between(data_available, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Top 20%","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
  
  #set color pallete
  col_pal <- c("#2ec4b6","#acece7","#f1dc76","#ffbf69","#ff9f1c")  
  names(col_pal) <- c("Top 20%","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )
  

  p2_alt <- SPI_map %>%
    ungroup() %>%
    ggplot(aes(x=data_available, y=region, color=spi_groups)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Country', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      xlab('Score') +
      expand_limits(x=c(0,100)) +
      scale_color_manual(
        name='SPI Score',
        values=col_pal,
        na.value='grey'
      ) +
      theme_bw() +
      theme(legend.position = 'top',
            text=element_text(size=14)
            ) 
p2_alt

}


income_charts <- function(data, indicator, title) { 


 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  
  income <- c("Low income", "Lower middle income","Upper middle income","High income")

  p2_alt3 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=(data_available),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=income, color=income)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = income) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top',
            text=element_text(size=14) )
   
p2_alt3 
  
 
}

spi_income_aggregates <- function(data, indicator, title) {
   indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))   
  
    income <- c("Low income", "Lower middle income","Upper middle income","High income")

    p3 <- map_df %>%
    group_by(income) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=wtd.mean(data_available, weights=weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=income, fill=income)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = income) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
    theme(
      text=element_text(size=14)
    )
    
    p3
}


lending_charts <- function(data, indicator, title) { 


 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  p2_alt3 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=(data_available),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=lending, color=lending)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top',
            text=element_text(size=14) )
   
p2_alt3 
  
 
}

lending_chart_aggregate <- function(data, indicator, title) { 


 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  

  p2_alt3 <- map_df %>%
    group_by(lending) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=lending, fill=lending)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top',
            text=element_text(size=14) )
   
p2_alt3 
  
 
}



fcs_charts <- function(data, indicator, title) { 
  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")

  p2_alt2 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=(data_available),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=fcs, color=fcs)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top',
            text=element_text(size=14)) 
   
p2_alt2 
  
 
}


fcs_chart_aggregate <- function(data, indicator, title) { 
  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")

  p2_alt2 <- map_df %>%
    group_by(fcs) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=fcs, fill=fcs)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top',
            text=element_text(size=14)) 
  
  
  
p2_alt2 
  
 
}


FitFlextableToPage <- function(ft, pgwidth = 6){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

#add equations to plots
eq_plot_txt <- function(data) {
  eq <- lm_robust(SPI.INDEX ~ value, data=data, se_type='HC2')
  coef <- coef(eq)
  std_err <- sqrt(diag(vcov(eq)))
  r_2<- summary(eq)$r.squared
  glue::glue("y = {round(coef[1],3)} + {round(coef[2],3)} x, R<sup>2</sup> = {round(r_2[1],3)} <br> &nbsp;   &nbsp;  	&nbsp; 	&nbsp;   ({round(std_err[1],3)}) &nbsp;   &nbsp;  ({round(std_err[2],3)})" )
}

```



# Introduction

```{r textnum}

country_dta <- SPI %>%
  filter(country==cntry) %>%
  filter(date==yr) %>%
  mutate(across(starts_with("SPI."),round,1))

```


`r cntry` received a score of `r country_dta$SPI.INDEX` out of 100 for `r yr` on the World Bank’s SPI overall score, which measures a country’s statistical performance around 5 pillars.  These 5 pillars are described below.

## Pillar 1: Data use

The data use (outcome) pillar is segmented by five types of users: (i) the legislature, (ii) the executive branch, (iii) civil society (including sub-national actors), (iv) academia and (v) international bodies.  Each dimension would have associated indicators to measure performance. A mature system would score well across all dimensions whereas a less mature one would have weaker scores along certain dimensions. The gaps would give insights into prioritization among user groups and help answer questions as to why the existing services are not resulting in higher use of national statistics in a particular segment.  **`r cntry` received a score of `r country_dta$SPI.INDEX.PIL1` out of 100 for `r yr` on the World Bank’s SPI Pillar 1 score.**

##	Pillar 2: Data services

The data services (output) pillar  is segmented by four service types: (i) the quality of data releases, (ii) the richness and openness of online access, (iii) the effectiveness of advisory and analytical services related to statistics, and (iv) the availability and use of data access services such as secure microdata access. Advisory and analytical services might incorporate elements related to data stewardship services including input to national data strategies, advice on data ethics and calling out misuse of data in accordance with the Fundamental Principles of Official Statistics.  `r cntry` received a score of **`r country_dta$SPI.INDEX.PIL2` out of 100 for `r yr` on the World Bank’s SPI Pillar 2 score.**

##	Pillar 3: Data products

The data products (internal process) pillar is segmented by four topics and organized into (i) social, (ii) economic, (iii) environmental, and (iv) institutional dimensions using the typology of the Sustainable Development Goals (SDGs). This approach anchors the national statistical system’s performance around the essential data required to support the achievement of the 2030 global goals, and enables comparisons across countries so that a global view can be generated while enabling country specific emphasis to reflect the user needs of that country.  **`r cntry` received a score of `r country_dta$SPI.INDEX.PIL3` out of 100 for `r yr` on the World Bank’s SPI Pillar 3 score.**


## Pillar 4: Data sources

The data sources (input) pillar is segmented by four types of sources generated by (i) the statistical office (censuses and surveys), and sources accessed from elsewhere such as (ii)  administrative data, (iii) geospatial data, and (iv) private sector data and citizen generated data. The appropriate balance between these source types will vary depending on a country’s institutional setting and the maturity of its statistical system. High scores should reflect the extent to which the sources being utilized enable the necessary statistical indicators to be generated. For example, a low score on environment statistics (in the data production pillar) may reflect a lack of use of (and low score for) geospatial data (in the data sources pillar). This type of linkage is inherent in the data cycle approach and can help highlight areas for investment required if country needs are to be met. **`r cntry` received a score of `r country_dta$SPI.INDEX.PIL4` out of 100 for `r yr` on the World Bank’s SPI Pillar 4 score.**

## Pillar 5: Data infrastructure

The data infrastructure (capability) pillar includes hard and soft infrastructure segments, itemizing essential cross cutting requirements for an effective statistical system. The segments are: (i) legislation and governance covering the existence of laws and a functioning institutional framework for the statistical system; (ii) standards and methods addressing compliance with recognized frameworks and concepts; (iii) skills including level of skills within the statistical system and among users (statistical literacy); (iv) partnerships reflecting the need for the statistical system to be inclusive and coherent; and (v) finance mobilized both domestically and from donors. **`r cntry` received a score of `r country_dta$SPI.INDEX.PIL5` out of 100 for `r yr` on the World Bank’s SPI Pillar 5 score.**

##  SPI Dimensions and Indicators

Each dimension of the five pillars incorporates several indicators. These Statistical Performance Indicators embody the granular measures of performance. They can be aggregated to levels of dimensions and pillars, and finally to an overall performance score to get a higher level or a more general perspective of a country’s performance.

The indicators are designed to act as proxy measures of performance for each dimension. While not comprehensive, they should add value in assessing country performance along that dimension. The intention is for the pillars and dimensions to be the focus rather than the specific indicators. 
The indicators for the SPI are selected following these principles: (i) use of publicly accessible data; (ii) transparent methodology; (iii) easy replicability; (iv) a time series to track performance; (v) clear portrayal of outcomes and their supporting elements; (vi) being reflective of the SDGs; (vii) enable at-a-glance comparisons on a global scale.

Benefitting from large scale data collection efforts by organizations such as the World Bank, IMF, Open Data Watch, PARIS21, the ILO, WHO, UNESCO, IHSN, and the UN, among others, 51 indicators covering 14 out of the 22 dimensions for the dashboard have been compiled. These 51 indicators provide data for each of the five pillars on data use, data services, data products, data sources, and data infrastructure. Yet, there remain major gaps in several pillars because indicators to assess performance still need to be developed, and in some cases, indicators have limited data coverage.  This data availability challenge impedes efforts to measure the performance of statistical systems in certain areas and going forward countries and their international partners must work together to fill these gaps. 

Below is a brief description of the indicators (or lack thereof) we have available for the 22 dimensions in the SPI framework. A detailed description of the indicators is also available in the annex. For as many as eight dimensions there was no indicator with a developed methodology, or the data collection for that measure was incomplete. 

  * **Dimension 1.1: Data use by national legislature:** Not included because of lack of established methodology. In principle it may be possible to utilize websites of national legislatures but this will require further work and assessment. 

  * **Dimension 1.2: Data use by national executive branch:** Not included because of lack of established methodology. There are some usable data sources (as used by PARIS21) but gaps in data across countries have prevented full adoption.

  * **Dimension 1.3: Data use by civil society:** Not included because of lack of established methodology. There are some usable data sources with good coverage, for example from social media but more data is required to help assess and allow for likely biases between and within countries.

  * **Dimension 1.4: Data use by academia:** Not included because of lack of established methodology. We have not been able to find usable data sources with global coverage on which a new methodology could be developed.

  * **Dimension 1.5: Data use by international organizations:** Five measures of usefulness or reliability of country produced measures for international organizations have been included. First, on comparability of poverty estimates for the World Bank reporting on international poverty using  [Povcalnet](http://iresearch.worldbank.org/PovcalNet). Second on usable surveys for statistics on child mortality for the [UN Inter-agency Group for Child Mortality Estimation](https://childmortality.org/). Third on accuracy of debt reporting as classified by the World Bank (Source: World Bank WDI metadata).  Fourth, on availability of safely managed drinking water data for use by [WHO/UNICEF Joint Monitoring Programme](https://washdata.org/).  Fifth, on labor force participation data for use by [ILO](https://www.ilo.org/ilostat-files/Documents/TEM.pdf). While these data sources provide only a partial coverag of data used by international organizations, they do provide an indication of the performance of the national statistical system.  **`r cntry` received a score of `r country_dta$SPI.DIM1.5.INDEX` out of 1 for `r yr` on this dimension.**


  * **Dimension 2.1: Data Releases:** SDDS/e-GDDS subscription. This indicator is based on whether the country subscribes to IMF SDDS+, SDDS, or e-GDDS standards. The source is the IMF Dissemination Standards Bulletin Board. This is a reliable data source but we recognize that it is a proxy for the concept we are seeking to capture rather than a direct measurement.  **`r cntry` received a score of `r country_dta$SPI.DIM2.1.INDEX` out of 1 for `r yr` on this dimension.**

  * **Dimension 2.2: Online access:** ODIN Open Data Openness score (Crowell et al). This is a well-established data source with good country coverage, which scores countries based on whether indicators are available online in a format that is machine readable, in a non-proprietary format, downloadable, with metadata available and terms of use. Scores range from 0-1. For more details, consult the [ODIN technical documentation](https://docs.google.com/document/d/1MBK0hN6MoQrii7_E1bmRXmsUcE8Fbb-Q32nxm8d8qTw/edit). **`r cntry` received a score of `r country_dta$SPI.DIM2.2.INDEX` out of 1 for `r yr` on this dimension.**

  * **Dimension 2.3: Advisory/ Analytical Services:** Not included because of lack of established methodology. This could be a new indicator of the number of non-recurring products on NSO website (ad hoc/experimental rather than regular releases). The indicator is the number of products found. No established source exists for this indicator.

  * **Dimension 2.4: Data access services:** NADA metadata. This indicator checks whether NADA microdata cataloging is available for surveys produced by NSO. NADA is an open source microdata cataloging system, compliant with the Data Documentation Initiative (DDI) and Dublin Cores RDF metadata standards. Source: NSO websites. **`r cntry` received a score of `r country_dta$SPI.DIM2.4.INDEX` out of 1 for `r yr` on this dimension.**

  * **Dimension 3.1: Social Statistics:** Availability of indicators for the Sustainable Development Goals 1-6, measured by an average score. The primary data source is the UN SDG database. While this is a database with comprehensive coverage that all countries have signed up to, many countries are not yet submitting all their available national data. For this reason, scores for some countries thus may not fully capture their performance in calculating the indicators. For OECD countries, we supplement the UN SDG database with comparable data submitted to the OECD following the methodology in [Measuring Distance to the SDG Targets 2019: An Assessment of Where OECD Countries Stand](https://www.oecd.org/sdd/measuring-distance-to-the-sdg-targets-2019-a8caf3fa-en.htm). **`r cntry` received a score of `r country_dta$SPI.DIM3.1.INDEX` out of 1 for `r yr` on this dimension.**

  * **Dimension 3.2: Economic Statistics:** Availability of Goal 7-12 indicators, measured by an average score. See 3.1. **`r cntry` received a score of `r country_dta$SPI.DIM3.2.INDEX` out of 1 for `r yr` on this dimension.**

  * **Dimension 3.3: Environmental Statistics:** Availability of Goal 13 & 15 indicators, measured by an average score. Goal 14 - Life on Water - is not included because land-locked countries do not report on these indicators. See 3.1. **`r cntry` received a score of `r country_dta$SPI.DIM3.3.INDEX` out of 1 for `r yr` on this dimension.**

  * **Dimension 3.4: Institutional Statistics:** Availability of Goal 16-17 indicators measured by an average score. See 3.1.  **`r cntry` received a score of `r country_dta$SPI.DIM3.4.INDEX` out of 1 for `r yr` on this dimension.**

  * **Dimension 4.1: Censuses and Surveys:** Availability of recent censuses and surveys covering broad areas. The following censuses and surveys are considered: Population & Housing census, Agriculture census, Business/establishment census, Household Survey on income/ consumption/ expenditure/ budget/ Integrated Survey, Agriculture survey, Labor Force Survey, Health/Demographic survey, Business/establishment survey. Source: NSO websites, World Bank microdata library, ILO microdata library, IHSN microdata library. **`r cntry` received a score of `r round((country_dta$SPI.DIM4.1.CEN.INDEX+country_dta$SPI.DIM4.1.SVY.INDEX)/2,1)` out of 1 for `r yr` on this dimension.**

  * **Dimension 4.2: Administrative Data:** Availability of Civil Registration and Vital Statistics (CRVS) indicator. An ideal indicator for this dimension would include a score based on the density of administrative data available in sectors including social protection, education, labor, and health. However, social protection, education, health, and labor admin data indicators are not included because of lack of established methodology. While several promising sources for administrative data from the World Bank’s ASPIRE team, WHO, UNESCO, and ILO have been identified, these were not included due to incomplete coverage across countries. Further research and data collection effort would be needed to fill in this information, so that a more comprehensive picture of administrative data availability can be produced. **`r cntry` received a score of `r country_dta$SPI.DIM4.2.INDEX` out of 1 for `r yr` on this dimension.**

  * **Dimension 4.3: Geospatial Data:** Geospatial data available at 1st Admin Level. This data source from Open Data Watch focuses on data availability at the sub-national level and provides a partial understanding of a country’s ability to produce geospatial data. A research and data collection effort is needed to develop a more comprehensive global database of the availability of key geospatial indicators. **`r cntry` received a score of `r country_dta$SPI.DIM4.3.INDEX` out of 1 for `r yr` on this dimension.**

  * **Dimension 4.4: Private/citizen generated data:** Not included because of lack of established methodology. Currently no comprehensive source exists to measure the use of private and citizen generated data in national statistical systems, and this should be another area where more data collection is needed by the international community.

  * **Dimension 5.1: Legislation and governance:** This indicator is based on PARIS21 indicators on SDG 17.18.2 (national statistical legislation compliance with UN Fundamental Principles of Official Statistics), existence of National Statistical Council, national statistical strategy generation, national statistical plan. Limited country coverage makes cross country comparison limited. As a result, this is included in the dashboard, but not in the overall SPI score or index.

  * **Dimension 5.2: Standards and Methods:** This set of indicators is based on countries’ use of internationally accepted and recommended methodologies, classifications and standards regarding data integration. These indicators help facilitate data exchange and provide the foundation for the preparation of relevant statistical indicators. The following methods and standards are considered: System of national accounts in use, National Accounts base year, Classification of national industry, CPI base year, Classification of household consumption, Classification of status of employment, Central government accounting status, Compilation of government finance statistics, Compilation of monetary and financial statistics, Business process. Further work could improve the validity of this indicator and reduce the risk that countries may be incentivized to adopt only traditional standards and methods and neglect innovative solutions that may be more valid in the current context. **`r cntry` received a score of `r country_dta$SPI.DIM5.2.INDEX` out of 1 for `r yr` on this dimension.**

  * **Dimension 5.3: Skills:** Not included because of lack of established methodology or suitable data sources. A new indicator drawing on PARIS21 indicators such as statistical society presence and data literacy could be developed and is an area of future work.

  * **Dimension 5.4: Partnerships:** Not included because of lack of established methodology or suitable data sources. A new indicator based on textual analysis of NSS reports/websites for references to partner organizations could be developed. This is an area of future work.

  * **Dimension 5.5: Finance:** The indicator is based on PARIS21 SDG indicators (SDG 17.18.3 (national statistical plan that is fully funded and under implementation). It is included in dashboard, but not in the overall SPI score or index because of insufficient country coverage. 



## Line and Tile Chart

```{r line}

line_chart <- function(trend_var) {

  df_trends <- SPI %>%
    left_join(country_metadata) %>%
    select(iso3c, country, region, lending,  income, date, trend_var, population) %>%
    rename(Score=!! trend_var) %>%
    mutate(ISO_A3_EH=iso3c) %>%
    filter(between(date,2016,2019))
  
  #need to get the aggregates for the income group and region
  country_select_info <- country_metadata %>%
    filter(country==cntry)
  
  region_name<-country_select_info$region
  income_name<-country_select_info$income
  lending_name<-country_select_info$lending
  
  
  #produce aggregation
  region_agg <- df_trends %>%
    filter(region==region_name) %>%
    group_by(date) %>%
    summarise(across(starts_with('Score'),~round(mean(as.numeric(.), na.rm=T),2))) %>%
    mutate(country=region_name)
  
  income_agg <- df_trends %>%
    filter(income==income_name) %>%
    group_by(date) %>%
    summarise(across(starts_with('Score'),~round(mean(as.numeric(.), na.rm=T),2))) %>%
    mutate(country=income_name)
  
  lending_agg <- df_trends %>%
    filter(lending==lending_name) %>%
    group_by(date) %>%
    summarise(across(starts_with('Score'),~round(mean(as.numeric(.), na.rm=T),2))) %>%
    mutate(country=lending_name)
  
  
  
  df_trends <- df_trends %>%
    filter(country==cntry) %>%
    bind_rows(region_agg) %>%
    #bind_rows(income_agg) %>%
    bind_rows(lending_agg) %>%
    filter(!is.na(Score))%>%
    mutate(Score=round(Score, 1),
           country=factor(country, levels=unique(country)))
  
  ggplot(df_trends, aes(x=date,y=Score, color=country, label=Score)) +
    geom_line(size=1.5) +
    geom_point(size=4) +
    geom_text(vjust=2) +
    theme_bw() +
    theme(
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_blank(),
      #axis.text.y=element_text(size=14),
      legend.text = element_text(size=14),
      plot.title = element_text(size=18),
      legend.title = element_blank(),
      legend.position = 'top'
    ) +
    expand_limits(y=c(0,100)) +
    xlab("Year") +
    ylab("Score")
}



```

```{r tiles}


tile_chart <- function(indicators) {
    tile_df <- SPI %>%
      relocate(SPI.D3.13.CLMT, .after = SPI.D3.12.CNSP) %>%
      filter(country==cntry) %>%
      filter(between(date,2016,2019)) %>%
      select(date, starts_with(indicators)) %>%
      pivot_longer(
        cols=starts_with(indicators),
        names_to = 'source_id',
        values_to = 'Score'
      ) %>%
      left_join(metadata) %>%
      filter(!is.na(source_name)) %>%
      mutate(source_name=str_wrap(source_name, 30),
             Score=round(Score,2)) %>%
      mutate(source_name=factor(source_name, levels=unique(source_name))) 
      
    # tileplot 
    ggplot(tile_df, aes(x=date, y=source_name, fill= Score)) + 
      geom_tile(color = "white") +
      geom_text(aes(label=Score), color='white') +
      ylab('Indicator') +
      theme_bw() +
      #scale_fill_binned(guide = guide_coloursteps(show.limits = TRUE)) +
      scale_y_discrete(limits = rev(levels(tile_df$source_name))) +
        theme(
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          axis.text.y=element_text(size=12),
          #legend.text = element_text(size=14),
          plot.title = element_text(size=16)
          
        )
}




```


```{r lollifun}


      df_lolli <- SPI %>%
        left_join(country_metadata) %>%
        select(iso3c, country, region,lending,  income, date, starts_with('SPI'), population) %>%
        filter(date==yr) %>%
        mutate(ISO_A3_EH=iso3c) 
      
      #need to get the aggregates for the income group and region
      country_select_info <- country_metadata %>%
        filter(country==cntry)
      
      region_name<-country_select_info$region
      income_name<-country_select_info$income
      lending_name<-country_select_info$lending
      
      #produce aggregation
      region_agg <- df_lolli %>%
        filter(region==region_name) %>%
        summarise(across(starts_with('SPI'),~round(mean(as.numeric(.), na.rm=T),2))) %>%
        mutate(country=region_name)
      
      income_agg <- df_lolli %>%
        filter(income==income_name) %>%
        summarise(across(starts_with('SPI'),~round(mean(as.numeric(.), na.rm=T),2))) %>%
        mutate(country=income_name)

      lending_agg <- df_lolli %>%
        filter(lending==lending_name) %>%
        summarise(across(starts_with('SPI'),~round(mean(as.numeric(.), na.rm=T),2))) %>%
        mutate(country=lending_name)      
      
      #lollipop chart data
        
    lolli_df <- df_lolli %>%
          filter(country==cntry) %>%
          bind_rows(region_agg) %>%
          bind_rows(lending_agg) 
        

      
      
      
    
  
    #################
    # Functions
    #################
    
    country_report_lolli_fn <- function(variables) {
      
      #set up data
      lollip_df_temp <- lolli_df %>%
        select(country, starts_with(variables)) %>%
        pivot_longer(
          cols = starts_with(variables),
          names_to = 'source_id',
          values_to = 'values'
        ) %>% 
        left_join(metadata_full) %>%
        filter(!is.na(source_name)) %>%
        mutate(source_name=str_wrap(source_name, 30),
               values=round(values,2)) %>%
        mutate(source_name=factor(source_name, levels=unique(source_name)),
               country=factor(country, levels=unique(country))) 
        
      #now use ggplot
        lollip <- ggplot(lollip_df_temp,
               aes(x=source_name, y=values, fill=country,label=values)) +
        geom_bar(stat='identity',
                 position='dodge') +
        geom_text( position=position_dodge(width = 1),hjust=-0.2) +
        #geom_segment( aes(x=source_name ,xend=source_name, y=0, yend=values), color="grey") +
        #geom_point(size=4) +
        coord_flip() +
        theme_bw() +
        scale_x_discrete(limits = rev(levels(lollip_df_temp$source_name))) +
        theme(
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          axis.text.y=element_text(size=14),
          legend.text = element_text(size=14),
          plot.title = element_text(size=18),
          legend.title = element_blank(),
          legend.position = 'top'
        ) +
        xlab("") +
        ylab("Indicator")
      
      lollip
    }
    
    
   
    
```



```{r line_charts}

line_chart('SPI.INDEX') +
  ggtitle(paste0("SPI Overall Score for ", cntry, " in ", yr))










  
```

```{r overall}
country_report_lolli_fn('SPI.INDEX') +
  ggtitle(str_wrap(paste0('SPI Overall Scores for ',cntry,' in ',yr,"."),50))
     

```


## Pillar 1: Data Use
```{r D1}

line_chart('SPI.INDEX.PIL1') +
  ggtitle(paste0("SPI Pillar 1 - Data Use - Score for ", cntry, " in ", yr))


```

```{r D1tile, fig.width = 9, fig.height = 7}
tile_chart("SPI.D1") +
  ggtitle(paste0("Pillar 1 - Data Use - Indicators for ", cntry, " over time"))

```

## Pillar 2: Data Services
```{r D2}

line_chart('SPI.INDEX.PIL2') +
  ggtitle(paste0("SPI Pillar 2 - Data Services - Score for ", cntry, " in ", yr))


```

```{r D2tile, fig.width = 9, fig.height = 7}
tile_chart("SPI.D2") +
  ggtitle(paste0("Pillar 2 - Data Services - Indicators for ", cntry, " over time"))

```

# Pillar 3: Data Products
```{r D3}

line_chart('SPI.INDEX.PIL3') +
  ggtitle(paste0("SPI Pillar 3 - Data Products - Score for ", cntry, " in ", yr))


```

```{r D3tile, fig.width = 9, fig.height = 9}
tile_chart("SPI.D3") +
  ggtitle(paste0("Pillar 3 - Data Products - Indicators for ", cntry, " over time"))

```


```{r D4}

line_chart('SPI.INDEX.PIL4') +
  ggtitle(paste0("SPI Pillar 4 - Data Sources - Score for ", cntry, " in ", yr))


```

```{r D4tile, fig.width = 9, fig.height = 9}
tile_chart("SPI.D4") +
  ggtitle(paste0("Pillar 4 - Data Sources - Indicators for ", cntry, " over time"))

```

```{r D5}


line_chart('SPI.INDEX.PIL5') +
  ggtitle(paste0("SPI Pillar 5 - Data Infrastructure - Score for ", cntry, " in ", yr))


```

```{r D5tile, fig.width = 9, fig.height = 9}
tile_chart("SPI.D5") +
  ggtitle(paste0("Pillar 5 - Data Infrastructure - Indicators for ", cntry, " over time"))

```

# By Indicator



```{r lolliplot1, fig.height=7, fig.width=10}

  
country_report_lolli_fn('SPI.D1') +
  ggtitle(str_wrap(paste0(' Dimension 1 - Data Use - Indicator Data for ',cntry,' in ',yr,"."),50))
      

```

```{r lolliplot2, fig.height=5, fig.width=10}

  
country_report_lolli_fn('SPI.D2') +
  ggtitle(str_wrap(paste0(' Dimension 2 - Data Services - Indicator Data for ',cntry,' in ',yr,"."),50)) 
      

```

```{r lolliplot3, fig.height=9, fig.width=10 }

  
country_report_lolli_fn('SPI.D3') +
  ggtitle(str_wrap(paste0(' Dimension 3 - Data Products - Indicator Data for ',cntry,' in ',yr,"."),50)) 

```

```{r lolliplot4, fig.height=8, fig.width=10}

  
country_report_lolli_fn('SPI.D4') +
  ggtitle(str_wrap(paste0(' Dimension 4 - Data Sources - Indicator Data for ',cntry,' in ',yr,"."),50))
      

```

```{r lolliplot5, fig.height=8, fig.width=10}

  
country_report_lolli_fn('SPI.D5') +
  ggtitle(str_wrap(paste0(' Dimension 5 - Data Infrastructure - Indicator Data for ',cntry,' in ',yr,"."),50))
      

```

# Table of Raw Indicators and Scores

```{r}
#create a dataset that contains data for just one country (e.g. China) and then reshapes to show the raw (unscored) data and the scored data

country_df_raw <- spi_df_final %>%
  filter(country==cntry) %>% #select the country
  filter(date==yr) #select the year

country_df <- country_df_raw %>%
  mutate(across(contains(".D"),as.character)) %>%
  pivot_longer(
    cols = contains(".D"),
    names_to='indicator',
    values_to='value'
    ) %>%
  mutate( #create two groups (scored and raw) and rename accordingly
    type=case_when(
      grepl('SPI',indicator) ~ "Scored",
      grepl('RAW',indicator) ~ "Raw"
    ),
    indicator=str_replace(indicator,'RAW.',''),
    indicator=str_replace(indicator,'SPI.','')
  ) %>%
  filter( #drop some extraneous variables
    !grepl("_nada|IMF|text|BRTH90|DETH75|.WDI",indicator)
  ) %>%
  pivot_wider(
    names_from='type',
    values_from='value'
  )

#prepare metadata for merge
metadata_merge <- metadata %>%
  filter(grepl('SPI.', source_id)) %>%
  mutate(indicator=str_replace(source_id, "SPI.","")) %>%
  select(indicator, source_name, spi_indicator_description)

country_disp <- country_df %>%
  select(indicator, Scored, Raw) %>%
  left_join(metadata_merge) %>%
  filter(!is.na(spi_indicator_description)) %>%
  mutate(Raw=if_else(is.na(Raw),'Not Applicable/Available',Raw))

```


# Censuses and Surveys
```{r cs_reports_table}

country_disp %>%
  filter(grepl('D4.1',indicator)) %>%
  select(source_name, Scored, Raw) %>%
  flextable() %>%
    add_header_lines(paste0(cntry, ' SPI Indicator Data in ',yr,".")) %>%
    set_header_labels(values=list(
                       source_name="Indicator", 
                       Scored="Scored Value", 
                       Raw="Census/Survey Dates"
                                   )) %>%
  FitFlextableToPage() %>%
  width(width=1.6) %>%
  align( align = "left", part = "body")

```


# Methods Standard

```{r msc_reports_table}

country_disp %>%
  filter(grepl('D5.2',indicator)) %>%
  select(source_name, Scored, Raw) %>%
  flextable() %>%
    add_header_lines(paste0(cntry, ' SPI Indicator Data in ',yr,".")) %>%
    set_header_labels(values=list(
                       source_name="Indicator", 
                       Scored="Scored Value", 
                       Raw="Method, Standard, or Classification"
                                   )) %>%
  FitFlextableToPage() %>%
  width(width=1.6) %>%
  align( align = "left", part = "body")

```


```{r reports_table, eval=FALSE, include=FALSE}
country_disp %>%
select(source_name, Scored, Raw, spi_indicator_description) %>%
flextable() %>%
    add_header_lines(paste0(cntry, ' SPI Indicator Data in ',yr,".")) %>%
    set_header_labels(values=list(
                       source_name="ID", 
                       Scored="Scored Value", 
                       Raw="Raw Information",
                       spi_indicator_description="Brief Description"
                                   )) %>%
  FitFlextableToPage() %>%
  width(width=1.6) %>%
  align( align = "left", part = "body")

```


---
title: "Statistical Performance Indicators - MENA"
author: "SPI Team"
institute: "World Bank, Development Data Group"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    fig_width: 5
    fig_height: 4
    fig_caption: true
    background-size: contain;
    css: xaringan-themer.css
---

<style>

.center2 {
  margin: 0;
  position: absolute;
  top: -80px;
  right: 0;  
  width: 800px;
  height: 800px;
}
.center3 {
  margin: 0;
  position: absolute;
  top: -20px;
  right: 20px;  
  width: 800px;
  height: 800px;
}
.reduced{
   font-size: 0.5em;
}
</style>

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE, fig.retina = 2)
library(tidyverse)
library(kableExtra)
library(leaflet)
library(xaringanthemer)
library(wbggeo)
library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(plotly)
library(here)
library(patchwork)
library(ggpmisc)
library(leaflet)
library(DT)
style_mono_accent(base_color = "#009FDA",
                  title_slide_background_color = 'white',
                  title_slide_text_color = '#002244',
                  title_slide_background_image = 'WB_logo.png',
                  title_slide_background_size = '7',
                  title_slide_background_position = 'bottom 25px right 25px;',
                  text_font_google = google_font('Roboto'),
                  text_font_size = '24px',
                  )

#set directories
dir <- here()

raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")

#weights (either unity (1) or population)
wgt <- 1

```

```{r load, include=FALSE}

#add in population
pop_df <- wbstats::wb(country="all",
             indicator='SP.POP.TOTL',
             startdate=2004,
             enddate=2019) %>%
  mutate(date=as.numeric(date)) %>%
  mutate(population=value) %>%
  select(country, date, population) 

#import data
SPI <- read_csv(paste(output_dir, 'SPI_index.csv', sep="/")) %>%
    left_join(pop_df) %>%
  mutate(weights=wgt)  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.






#metadata 
metadata2 <- data.frame(
  series = c('SPI.INDEX', 'SPI.INDEX.DIM1', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5'),
  indicator_name = c('SPI Overall Score', 'Dimension 1: Data Use', 'Dimension 2: Data Services', 'Dimension 3: Data Products', 'Dimension 4: Data Sources', 'Dimension 5: Data Infrastructure')
)

metadata  <- read_csv(paste(raw_dir, '/metadata/SPI_dimensions_sources.csv', sep="")) %>%
  rename(series=source_id,
         indicator_name=source_name) %>%
  bind_rows(metadata2)

#get list of country info
country_list <- wbstats::wbcountries()


SPI_2019 <- SPI %>%
  filter(date==2019) %>%
  filter(!is.na(SPI.INDEX) & !is.na(weights)) %>%
  mutate(ISO_A3_EH=iso3c) %>%
  mutate(across(contains("SPI"),~1*.))

#read in TopoJSON from World Bank
#countries <- geojsonio::geojson_read("WB_countries_Admin0_lowres.geojson",
#                                     what = "sp")

```

# Introduction

- World Bank Development Data Group (DECDG) will be releasing new set of Statistical Performance Indicators along with WDR

- Will be major overhaul of Statistical Capacity Index

- Statistical Performance Indicators are tool for countries/donors to assess statistical system

Based on feedback, goal was for SPI framework to:  
  - Be forward looking (relevant at least 15 years)   
  - Measure less advanced systems, as well as more advanced systems
  - Cover entire national statistical system, not just NSO   
  - Give countries incentives to build modern statistical system



---
# Building on SCI

- Statistical Performance Indicators build on the Statistical Capacity Index

The SCI (in use since 2004) has three dimensions:   
  1. Methodology (Balance of payments manual in use, CPI base year, SDDS, etc.)   
  2. Source Data (Agriculture Census, Health Surveys, etc)    
  3. Periodicity (values for indicators: access to water, child malnutrition, poverty, etc)   

--

Based on comments, Statistical Performance Indicators build on this:
  - Includes same (or similar) indicators   
  - But also expands into new areas    
  - Open Data and Open Code   
  - Still will provide time series (minimum 3 years) for indicators   

---
# Framework Overview

- SPI framework covers five dimensions:   
  1. Data Use
      * Indicators that capture demand side of statistical system 

---
# Framework Overview

- SPI framework covers five dimensions:
  1. Data Use
      * Indicators that capture demand side of statistical system   
  2. Data Services
      * Information on data releases, online access, advisory/analytical services, and other data services

---
# Framework Overview

- SPI framework covers five dimensions:
  1. Data Use
      * Indicators that capture demand side of statistical system  
  2. Data Services
      * Information on data releases, online access, advisory/analytical services, and other data services    
  3. Data Products
      * Whether the country is able to produce relevant indicators, primarily related to SDGs

---
# Framework Overview

- SPI framework covers five dimensions:
  1. Data Use
      * Indicators that capture demand side of statistical system   
  2. Data Services
      * Information on data releases, online access, advisory/analytical services, and other data services    
  3. Data Products
      * Whether the country is able to produce relevant indicators, primarily related to SDGs    
  4. Data Sources
      * Censuses and surveys, admin data, geospatial, private/citizen generated data    

---
 # Framework  Overview

- SPI framework covers five dimensions:
  1. Data Use
      * Indicators that capture demand side of statistical system  
  2. Data Services
      * Information on data releases, online access, advisory/analytical services, and other data services    
  3. Data Products
      * Whether the country is able to produce relevant indicators, primarily related to SDGs    
  4. Data Sources
      * Censuses and surveys, admin data, geospatial, private/citizen generated data      
  5. Data Infrastructure
      * Legislation and governance, standards & methods, skill, partnerships, and finance



---
# SPI Framework

.center[![unchanged image](SPI_dashboard.png)]

---


```{r overall_sumstats, message=FALSE, warning=FALSE, include=FALSE}
        #add function to produce weighted summary stats
        
        indicators<-c("SPI.D1.5.POV","SPI.D1.5.DT.TDS.DPPF.XP.ZS",
                      "SPI.D2.1.GDDS","SPI.D2.2.Openness.subscore",
                      "SPI.D3.1.POV","SPI.D3.8.WORK",
                      "SPI.D4.1.1.POPU", "SPI.D4.1.4.HOUS","SPI.D4.2.3.CRVS", "SPI.D4.3.GEO.first.admin.level",
                      "SPI.D5.2.1.SNAU", "SPI.D5.2.4.CPIBY")

        #produce by region
        sumstats<- SPI_2019 %>%
            group_by(region) %>%
            filter(!is.na(region)) %>%
            select(region,  all_of(indicators), weights) %>%
            summarise_at( all_of(indicators),~round(wtd.mean(as.numeric(.),as.numeric(weights), na.rm=T),2)) 
        
        #produce global number
        sumstats_gl<- SPI_2019 %>%
            mutate(region='Global') %>%
            group_by(region) %>%
            select(region,  all_of(indicators), weights) %>%
            summarise_at( all_of(indicators),~round(wtd.mean(as.numeric(.),as.numeric(weights), na.rm=T),2)) 
        
        
        #transpose data
        sumstats_df_long <-sumstats_gl %>%
            bind_rows(sumstats) 
        
        sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-region)))
        colnames(sumstats_df) = sumstats_df_long$region 
        
        
        sumstats_df <- sumstats_df %>%
            rownames_to_column() %>%
            rename(series=rowname)
        
        
        #create labels df
        metadata_tab2_overall <- metadata %>% 
            janitor::clean_names() %>%
            filter(series %in%  all_of(indicators)) %>%
            select(series, indicator_name)
        
        
        #add variable label
        sumstats_df <- sumstats_df %>%
            left_join(metadata_tab2_overall) %>%
            rename(Series=series,
                   Label=indicator_name) %>%
          select(Label, everything()) %>%
          select(-Series)
        

  
```

.center3[
```{r spi_plot_region, eval=FALSE, fig.height=11, fig.width=14, message=FALSE, warning=FALSE, include=FALSE, dpi=300}


SPI_2019_plot_region <- sumstats_df_long %>%
  pivot_longer(cols=c("SPI.INDEX", "SPI.INDEX.DIM2",   "SPI.INDEX.DIM3",    "SPI.INDEX.DIM4",   "SPI.INDEX.DIM5"),
               names_to='series',
               values_to='value') %>%
  left_join(metadata_tab2_overall)


  p1<-ggplot(SPI_2019_plot_region, aes(x=indicator_name, y= value, fill=region)) + #now plot the output in a bar graph
    geom_col( position="dodge") +
    geom_text(aes(x=indicator_name, y=value, label=value), 
              position = position_dodge(width = 0.8), size = 3, hjust = 1) +
    geom_text( aes(x=indicator_name, y=0, label=region), 
              position = position_dodge(width = 0.8), size = 3, hjust = 0) +
  xlab(str_wrap("Indicator", width=75))+
  ylab(str_wrap("SPI Score",35)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 23))  +
  scale_fill_discrete(name="Region") +

  coord_flip() +
  expand_limits(y=0:100) +
    theme_bw() +
    ggtitle(str_wrap("Statistical Performance Measures by Region", 50)) +
      theme(
    legend.position="none"
  ) 
p1
  


```

]

<!-- --- -->
<!-- # Mean by Region -->

.reduced[

```{r sumstats_table, echo=FALSE, out.height=12, out.width=10}

kable(sumstats_df,
      digits=2,
      caption="Statistical Performance Indicator Summary Statistics for 2019",
      format='html') %>%
  column_spec(2,  background = "#e9c46a") %>%
  column_spec(6,  color='white', background = "#264653") %>%
  kable_styling(bootstrap_options = c('hover', 'striped')) %>%
  pack_rows(start_row=1,end_row=2, group_label='Dimension 1: Data Use') %>%
  pack_rows(start_row=3,end_row=4, group_label='Dimension 2: Data Services') %>%
  pack_rows(start_row=5,end_row=6, group_label='Dimension 3: Data Products') %>%
  pack_rows(start_row=7,end_row=10, group_label='Dimension 4: Data Sources') %>%
  pack_rows(start_row=11,end_row=12, group_label='Dimension 5: Data Infrastructure') 
  
  
```
]

    
---
class: inverse, middle, center

Overall Scores Across Countries


---
# Overview Summary of Results

  * Next, we will provide overall index
  * Will present aggregate scores overall and for each dimension    
  * Special highlight on MENA countries

  * Given imprecision inherent in calculations, we recommend color coding providing subdivisions of maturity
  
Countries are grouped into five groups:   

* **Top 20%**:    Shading in <span style="color:#1A9850">green</span>.    
* **4th Quantile**:  Shading in <span style="color:#BFCF28"> light green</span>.    
* **3rd Quantile**:   Shading in <span style="color:#E7BB25"> yellow</span>.  
* **2nd Quantile**:   Shading in <span style="color:#DE7B2B"> orange</span>.  
* **Bottom 20%**:   Shading in <span style="color:#D73027"> red </span>.     





```{r spi_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14, dpi=300}

#Now map the result
quality = "high"
maps <- wbgmaps::wbgmaps[[quality]]

country_metadata <- wbstats::wbcountries()


data = SPI_2019

mna_list <- country_metadata %>%
  filter(region=="Middle East & North Africa")

mna_list <- mna_list$country

spi_mapper <- function(data, indicator, title) {
  
 indicator<-indicator

   map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))     


  spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)
  
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      between(data_available, spi_groups_quantiles[4],100) ~ "Top 20%",
      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
      between(data_available, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Top 20%","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  %>%
    mutate(mna=if_else(country %in% mna_list, 1,0.5))
  
  #set color pallete
  col_pal <- c("#1A9850",  "#BFCF28", "#E7BB25", "#DE7B2B",  "#D73027" )
  names(col_pal) <- c("Top 20%","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )
  
p1<-ggplot() +
  geom_map(data = SPI_map, aes(map_id = iso3c, fill = spi_groups, alpha=mna), map = maps$countries) + 
  geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
  geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
  geom_path(data = maps$boundaries,
            aes(long, lat, group = group),
                color = "white",
            size = 0.1,
            lineend = maps$boundaries$lineend,
            linetype = maps$boundaries$linetype) +
  scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
  scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
  scale_color_manual(
    values=c('black'='black',
             'white'='white'),
    guide=FALSE
  ) +
  scale_fill_manual(
    name='SPI Score',
    values=col_pal,
    na.value='grey'
  ) +
  scale_alpha(
    range=c(0.3,1)
  ) +
    #coord_fixed(xlim = c(-20*100000, 80*100000), ylim = c(05*100000, 50*100000), expand = FALSE) +
    coord_fixed() +
    theme_map(base_size=12) +
    guides(
      alpha='none'
    ) +
    labs(
      title=str_wrap(title,100),
      caption = 'Source: World Bank. Statistical Performance Indicators'
    )
 print(p1)
}

spi_charts  <- function(data, indicator, title) {
  
 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  #add histogram by region 
  p2 <- map_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Region', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      expand_limits(x=c(0,100)) +
      theme_bw()
  
  #by income
    income <- c("Low income", "Lower middle income","Upper middle income","High income")

    p3 <- map_df %>%
    group_by(income) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=wtd.mean(data_available, weights=weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=income, fill=income)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = income) +
      expand_limits(x=c(0,100)) +
      theme_bw()
    
  # #add line graph over time
  p4 <- get(data)  %>%
    rename(data_available=!! indicator) %>%
    # right_join(spi_df_empty) %>%
    group_by( date, region) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available))) %>%
    mutate(Percentage=mean(data_available, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ungroup() %>%
    ggplot(aes(y=Percentage, x=date, color=region, 
               size=if_else(region=="Middle East & North Africa",1,0),
               alpha=if_else(region=="Middle East & North Africa",1,0)
               )) +
      geom_point() +
      geom_line(fill='blue') +
      # geom_text_repel(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Date', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data'
      ) +
      scale_size(
        range=c(1,2),
        guide=FALSE
      ) +
      scale_alpha(
        range=c(0.5,1),
        guide=FALSE
      ) +
      expand_limits(y=c(25,100)) +
      theme_bw()
      
(p2/p4)    
}

spi_country_charts  <- function(data, indicator, title) {
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  p2_alt <- map_df %>%
    ungroup() %>%
    ggplot(aes(x=data_available, y=region, color=region)) +
      geom_point() +
      geom_text(aes(label=country,
                    
                    alpha=if_else(region=="Middle East & North Africa",1,0)), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Country', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_alpha(
        range=c(0.5,1),
        guide=FALSE
      ) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top') 
    
   
p2_alt

}

lending_charts <- function(data, indicator, title) { 


 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  p2_alt3 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=(data_available),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=lending, color=lending)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top') 
   
p2_alt3 
  
 
}

lending_chart_aggregate <- function(data, indicator, title) { 


 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  

  p2_alt3 <- map_df %>%
    group_by(lending) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=lending, fill=lending)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top') 
   
p2_alt3 
  
 
}



fcs_charts <- function(data, indicator, title) { 
  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")

  p2_alt2 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=(data_available),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=fcs, color=fcs)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top') 
   
p2_alt2 
  
 
}


fcs_chart_aggregate <- function(data, indicator, title) { 
  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")

  p2_alt2 <- map_df %>%
    group_by(fcs) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=fcs, fill=fcs)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top') 
  
  
  
p2_alt2 
  
 
}


#spi_mapper('SPI', 'SPI.INDEX', 'Statistical Performance Indicators -  Overall Scores')



```



--- 


```{css, echo=F}
    /* Table width = 100% max-width */

    .remark-slide table{
        width: 100%;
    }

    /* Change the background color to white for shaded rows (even rows) */

    .remark-slide thead, .remark-slide tr:nth-child(2n) {
        background-color: white;
    }
```
---
.center2[
```{r overall_map1, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14, dpi=300}

spi_mapper('SPI', 'SPI.INDEX', 'Statistical Performance Indicators -  Overall Scores')

```

]


```{r overall_map, eval=FALSE, fig.height=8, fig.width=12, message=FALSE, warning=FALSE, include=FALSE, dpi=300}

#read in TopoJSON from World Bank
countries <- geojsonio::geojson_read(paste0(dir,"/SPI_data_viz/WB_countries_Admin0_lowres.geojson"),
                                     what = "sp")



spi_map_overall<-countries
        
        spi_map_overall@data <- spi_map_overall@data %>%
          mutate(iso3c=ISO_A3_EH,
                 iso3c=if_else(ISO_A3_EH==-99,WB_A3,ISO_A3_EH)) %>%
            left_join(SPI_2019) 
        
        palette_df <- SPI_2019 %>%
          select(SPI.INDEX)

        brks <- quantile(palette_df[,1], probs=c(0,1,2,3,4,5)/5,na.rm=T)
        #create pallete
        pal <- colorBin(c("#1A9850",  "#BFCF28", "#E7BB25", "#DE7B2B",  "#D73027"), 
                          bins=brks,
                          na.color='grey')
        
        
        
        ##############
        #create labels
        ##############
        
        
        labels <- sprintf(
            "<strong>%s</strong><br/> <hr size=2>
            <strong> %s: %g </strong><br/> <hr size=2>
            ",
            spi_map_overall@data$NAME_EN,
            'Indicator Value', round(select(spi_map_overall@data, SPI.INDEX)[,1], digits = 1)

        ) %>%
            lapply(htmltools::HTML)

        
        
        
        leaflet(spi_map_overall) %>%
            addProviderTiles(providers$Esri.WorldStreetMap) %>%
            addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 0.7,
                        fillColor = ~pal(select(spi_map_overall@data, SPI.INDEX)[,1]),
                        label=labels) %>%
            addLegend(pal=pal, 
                      values=~select(spi_map_overall@data, SPI.INDEX)[,1], opacity=0.7, 
                      labFormat = function(type, cuts, p) {  # Here's the trick
                        paste0( c("Bottom 20%","2nd Quintile","3rd Quintile","4th Quintile","Top 20%" ))
                      },
                      title='Indicator value', position="bottomleft") 

```

---
.center3[

```{r overall_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12,dpi=300 }
spi_charts('SPI','SPI.INDEX','Statistical Performance Indicators -  Overall Scores')

```
]
---
.center3[
```{r country_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
spi_country_charts('SPI','SPI.INDEX','Statistical Performance Indicators -  Overall Scores')

```


]



---
class: inverse, middle, center

Relationship of SPI Index to Other Outcomes


---
  


```{r comparison, include=FALSE}

#pull SCI values

Request_metadata <- httr::GET(url = "http://api.worldbank.org/v2/country/all/indicator/IQ.SCI.OVRL?format=json&date=2004:2019&per_page=5000")
Response_metadata <- httr::content(Request_metadata, as = "text", encoding = "UTF-8")

# Parse the JSON content and convert it to a data frame.
sci_df <- jsonlite::fromJSON(Response_metadata, flatten = TRUE) %>%
  data.frame() %>%
  transmute(
    iso3c=countryiso3code,
    country=country.value,
    date=as.numeric(date),
    SCI=value
  ) %>%
    select(iso3c, country, date, SCI  ) 

#read in ODIN data
  for (i in 2015:2018) {
   temp <- read_csv(paste(raw_dir, '/2.2_DSOA/','ODIN_',i,'.csv', sep=""))  %>%
        as_tibble(.name_repair = 'universal') %>%
        mutate(date=i) %>%
        filter(Data.categories=='All Categories')


    assign(paste('odin_df',i,sep="_"), temp)
  }

    #bind different years together
odin_df <- bind_rows(odin_df_2015, odin_df_2016, odin_df_2017, odin_df_2018)


odin_df <- odin_df %>%
    select(Country.Code, date, Overall.score) %>%
    rename(iso3c=Country.Code,
           ODIN_score=Overall.score) %>%
    group_by(date) %>%
    arrange(-ODIN_score) %>%
    mutate(ODIN_rank=rank(-ODIN_score, na.last='NA')) 


#read in the old SPI
SPI_v0_df <- readxl::read_excel(path='C:/Users/wb469649/OneDrive - WBG/DECIS/SPI_AKI/Data/FinalCopy of SPI SCORE 2016-2018-DW.xlsx', skip=2) %>%
  transmute(
    iso3c=Country,
    SPI_2016=as.numeric(Overall...7),
    SPI_2017=as.numeric(Overall...12),
    SPI_2018=as.numeric(Overall...17)
  ) %>%
  pivot_longer(
    cols=c('SPI_2016','SPI_2017','SPI_2018'),
    names_to="date",
    values_to = 'SPI_v0'
  ) %>%
  mutate(date=gsub('SPI_','',date),
         date=as.numeric(date))


#create one database
comparison_df <- SPI %>%
  ungroup() %>%
  filter(date %in% c(2016:2019)) %>%
  arrange(-SPI.INDEX) %>%
  mutate(across(starts_with('SPI.INDEX'),~.),
         across(starts_with('SPI.INDEX'),round,1)) %>%
  select(country, iso3c, date, income, region, SPI.INDEX) %>%
  left_join(sci_df) %>%
  left_join(odin_df) %>%
  left_join(SPI_v0_df)




```



    
```{r log_gdp, echo=FALSE, message=FALSE}

#HCI
hci_df <- wbstats::wb_data(country="countries_only", 
              indicator='HD.HCI.OVRL',
              start_date=2016,
              end_date=2019,
              return_wide = F) %>%
  left_join(select(comparison_df,iso3c,date, region,SPI.INDEX,SCI)) #merge on SPI Index data

#get the correlation for 2019
hci_df_2018 <- hci_df %>%
  filter(date==2018) 

hci_df_2018_chart <- hci_df_2018 %>%
    pivot_longer(
    cols = c('SPI.INDEX', 'SCI'),
    names_to='alt_index',
    values_to='index_values'
  ) %>%
  mutate(alt_index=if_else(alt_index=="SCI","SCI","SPI Index"))



hci_spi <- ggplot(data=hci_df_2018, aes(x=value, y=SPI.INDEX)) +
  facet_wrap(~ indicator) +
  geom_text(aes(label=iso3c, color=if_else(region=="Middle East & North Africa", "Middle East & North Africa", "Other"))) +
  geom_smooth(method='lm') +
  theme_bw() +
  ylab('Index value') +
  xlab('Human Capital Index') +
  scale_color_manual(
    values=c('Middle East & North Africa'='black',
             'Other'='grey'),
    guide = FALSE
  ) +
  stat_poly_eq(aes(label  = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     label.x.npc = "right", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4) +
    theme(legend.position = 'bottom')


hci_spi2 <- ggplot(data=hci_df_2018_chart, aes(x=value, y=index_values, color=alt_index)) +
  geom_point() +
  geom_smooth(method='lm') +
  theme_bw() +
  ylab('Index value') +
  xlab('Human Capital Index') +
  labs(
    color='Index'
  ) +
  ggtitle("SCI & SPI Index on Human Capital Index") +
  stat_poly_eq(aes(label  = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     label.x = "right", label.y = 'bottom',
                     formula = 'y~x', parse = TRUE, size = 4) +
    theme(legend.position = 'bottom')
#GDP
gdp_df <- wbstats::wb_data(
  indicator='NY.GDP.PCAP.KD',
  start_date=2016,
  end_date=2019,
  return_wide = F
    ) %>%
  left_join(select(comparison_df,iso3c,date, region,SPI.INDEX,SCI)) #merge on SPI Index data

#get the correlation for 2019
gdp_df_2019 <- gdp_df %>%
  filter(date==2019) 

gdp_df_2019_chart <- gdp_df_2019 %>%
    pivot_longer(
    cols = c('SPI.INDEX', 'SCI'),
    names_to='alt_index',
    values_to='index_values'
  ) %>%
  mutate(alt_index=if_else(alt_index=="SCI","SCI","SPI Index"))

  gdp_spi <- ggplot(data=gdp_df_2019, aes(x=value, y=SPI.INDEX)) +
  facet_wrap(~indicator) +
  geom_text(aes(label=iso3c,color=if_else(region=="Middle East & North Africa", "Middle East & North Africa", "Other"))) +
  geom_smooth(method='lm') +
  scale_x_log10(labels = scales::comma) +
  theme_bw() +
  ylab('Index value') +
  xlab('Log GDP Per Capita') +
  scale_color_manual(
    values=c('Middle East & North Africa'='black',
             'Other'='grey'),
    guide = FALSE
  ) +
  theme(legend.position = 'bottom') +
  stat_poly_eq(aes(label = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     label.x.npc = "right", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4)
  
  gdp_spi2 <- ggplot(data=gdp_df_2019_chart, aes(x=value, y=index_values, color=alt_index)) +
  geom_point() +
  geom_smooth(method='lm') +
  scale_x_log10(labels = scales::comma) +
  theme_bw() +
  ylab('Index value') +
  xlab('Log GDP Per Capita') +
  ggtitle("SCI & SPI Index on Log GDP per Capita") +
  labs(
    color='Index'
  ) +
  theme(legend.position = 'bottom') +
  stat_poly_eq(aes(label = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     label.x = "right", label.y= 'bottom',
                     formula = 'y~x', parse = TRUE, size = 4)


corr_hci_2018 <- cor(hci_df_2018$value,hci_df_2018$SPI.INDEX, use='pairwise.complete.obs')


corr_2019 <- cor(log(gdp_df_2019$value),gdp_df_2019$SPI.INDEX, use='pairwise.complete.obs')
corr_2019_nontrans <- cor(gdp_df_2019$value,gdp_df_2019$SPI.INDEX, use='pairwise.complete.obs')

```

 # Income & Human Capital Index

  * Show relationship to Log GDP per capita and Human Capital Index     
  
  * Can provide sense of whether countries are over or under performing based on income & HCI
  
  * MENA countries tend to under-perform


---

.center3[
```{r gdp_plot, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, dpi=300}

### Scatterplot log GDP SPI
(gdp_spi + hci_spi)   +
  plot_annotation(
    title='Plot of SPI Index on Human Capital Index and GDP per capita',
    caption='Source: All indicators come from the World Bank.'
    )
  

```
]

---


.center3[
```{r overperformers, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, dpi=300}

#get top 10 and bottom 10 over performers compared to gdp and hci

## GDP
#regress SPI on gdp
m_spi <- lm(SPI.INDEX ~ log(value) , data = gdp_df_2019) 

gdp_overperformers_df <- gdp_df_2019 %>%
  modelr::add_residuals(m_spi) %>%
  arrange(-resid) %>%
  head(15)

gdp_underperformers_df <- gdp_df_2019 %>%
  modelr::add_residuals(m_spi) %>%
  arrange(resid) %>%
  head(15)


gdp_overperformers_plot <-  gdp_overperformers_df %>%
  bind_rows(gdp_underperformers_df) %>%
  arrange(resid) %>%
  mutate(country=factor(country, levels=country),
         group=if_else(resid>=0, 'above','below')) %>%
  ggplot(aes(x=country, y=resid, color=group)) +
  geom_segment( aes(x=country ,xend=country, y=0, yend=resid), color="black") +
  geom_point(size=3) +
  scale_color_manual(name="GDP per Capita",
                     labels = c("Over-performers", "Under-performers"),
                     values = c('above'="#1A9850", 'below'="#D73027")) +
  coord_flip() +
  theme_bw() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = 'bottom'
  ) +
  xlab("") +
  ylab("SPI (deviation)") +
  ggtitle("GDP per capita") 

gdp_overperformers_plot <- gdp_overperformers_plot +
    theme(
      axis.text.y = element_text(face = ifelse((levels(gdp_overperformers_plot$data$country) %in% mna_list) , "bold", "plain"),
                               size = ifelse((levels(gdp_overperformers_plot$data$country) %in% mna_list) , 12, 10))
      )

### HCI


#regress SPI on hci
m_spi_hci <- lm(SPI.INDEX ~ value , data = hci_df_2018) 

hci_overperformers_df <- hci_df_2018 %>%
  modelr::add_residuals(m_spi_hci) %>%
  arrange(-resid) %>%
  head(15)

hci_underperformers_df <- hci_df_2018 %>%
  modelr::add_residuals(m_spi_hci) %>%
  arrange(resid) %>%
  head(15)

hci_overperformers_plot <-  hci_overperformers_df %>%
  bind_rows(hci_underperformers_df) %>%
  arrange(resid) %>%
  mutate(country=factor(country, levels=country),
         group=if_else(resid>=0, 'above','below')) %>%
  ggplot(aes(x=country, y=resid, color=group)) +
  geom_segment( aes(x=country ,xend=country, y=0, yend=resid), color="black") +
  geom_point(size=3) +
  scale_color_manual(name="HCI",
                     labels = c("Over-performers", "Under-performers"),
                     values = c('above'="#1A9850", 'below'="#D73027")) +
  coord_flip() +
  theme_bw() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = 'bottom'
  ) +
  xlab("") +
  ylab("SPI (deviation)") +
  ggtitle("Human Capital Index")

hci_overperformers_plot <- hci_overperformers_plot +
    theme(
      axis.text.y = element_text(face = ifelse((levels(hci_overperformers_plot$data$country) %in% mna_list) , "bold", "plain"),
                               size = ifelse((levels(hci_overperformers_plot$data$country) %in% mna_list) , 12, 10))
      )

gdp_overperformers_plot + hci_overperformers_plot +
  plot_annotation(title='Top 15 Over/Under-Performers on SPI Index Compared to GDP per capita and Human Capital Index',
                  caption=str_wrap('Over and under performers calculated for GDP per capita by using OLS regression of SPI Index in 2019 on Log GDP per capita and calculting residuals from this regression.  Over and Under performers for Human Capital Index calculated similarly.',100)
                  )
```
]



---
class: inverse, middle, center

Scores For Each Dimension Across Countries

---


.center2[
```{r dimension_1_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14, dpi=300}
spi_mapper('SPI', 'SPI.INDEX.DIM1', 'Statistical Performance Indicators - SPI Dimension 1: Data Use')

```
]

---

.center2[
```{r dimension_2_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14, dpi=300}
spi_mapper('SPI', 'SPI.INDEX.DIM2', 'Statistical Performance Indicators - SPI Dimension 2: Data Services')

```
]


---
  

.center2[
```{r dimension_3_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14, dpi=300}
spi_mapper('SPI', 'SPI.INDEX.DIM3', 'Statistical Performance Indicators - SPI Dimension 3: Data Products')

```

]

    
---


.center2[
```{r dimension_4_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14, dpi=300}
spi_mapper('SPI', 'SPI.INDEX.DIM4', 'Statistical Performance Indicators - SPI Dimension 4: Data Sources')

```
]

    
---


.center2[
```{r dimension_5_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14, dpi=300}
spi_mapper('SPI', 'SPI.INDEX.DIM5', 'Statistical Performance Indicators - SPI Dimension 5: Data Infrastructure')

```
]

---


.reduced[
```{r tab1, echo=FALSE, message=FALSE, warning=FALSE, out.height=12, out.width=10}

library(flextable)
#colors
col_palette <- c("#D73027", "#DE7B2B", "#E7BB25", "#BFCF28",  "#1A9850"  )
col_palette <- c("#1A9850",  "#BFCF28", "#E7BB25", "#DE7B2B",  "#D73027" )

#make the table
index_tab <- SPI %>%
  filter(date==2019) %>%
  select(country, SPI.INDEX,SPI.INDEX.DIM1,SPI.INDEX.DIM2,SPI.INDEX.DIM3,SPI.INDEX.DIM4,SPI.INDEX.DIM5) %>%
    mutate(across(starts_with('SPI.INDEX'),~1*.),
         across(starts_with('SPI.INDEX'),round,1)) 

 #calculate the breaks for the color coding
        brks <- quantile(index_tab$SPI.INDEX, probs=c(1,2,3,4)/5,na.rm=T)
        brks <- append(0,brks)
        brks <- append(brks,100)

        brks1 <- quantile(index_tab$SPI.INDEX.DIM1, probs=c(1,2,3,4)/5,na.rm=T)
        brks1 <- append(0,brks1)
        if (max(brks1)<100) brks1 <- append(brks1,100)
        
        brks2 <- quantile(index_tab$SPI.INDEX.DIM2, probs=c(1,2,3,4)/5,na.rm=T)
        brks2 <- append(0,brks2)
        if (max(brks2)<100) brks2 <- append(brks2,100)
        
        brks3 <- quantile(index_tab$SPI.INDEX.DIM3, probs=c(1,2,3,4)/5,na.rm=T)
        brks3 <- append(0,brks3)
        if (max(brks3)<100) brks3 <- append(brks3,100)
        
        brks4 <- quantile(index_tab$SPI.INDEX.DIM4, probs=c(1,2,3,4)/5,na.rm=T)
        brks4 <- append(0,brks4)
        if (max(brks4)<100) brks4 <- append(brks4,100)
        
        brks5 <- quantile(index_tab$SPI.INDEX.DIM5, probs=c(1,2,3,4)/5,na.rm=T)
        brks5 <- append(0,brks5)
        if (max(brks5)<100) brks5 <- append(brks5,100)
        
        #make nice looking table
        index_tab <- index_tab %>%
          filter(country %in% mna_list)
        
      #make nice looking
      index_tab <- index_tab %>%
        arrange(country) %>%
        flextable() %>%
        add_header_lines('SPI overall score in 2019 and Dimension Scores.') %>%
        set_header_labels(values=list(
                             country="Country",
                             SPI.INDEX="SPI overall score",
                             SPI.INDEX.DIM1="Dim 1: Data Use",
                             SPI.INDEX.DIM2="Dim 2: Data Services",
                             SPI.INDEX.DIM3="Dim 3: Data Products ",
                             SPI.INDEX.DIM4="Dim 4: Data Sources",
                             SPI.INDEX.DIM5="Dim 5: Data Infrastructure"
                                         )) %>%
          bg(j = c('SPI.INDEX'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.DIM1'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks1, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.DIM2'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks2, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.DIM3'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks3, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.DIM4'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks4, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.DIM5'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks5, reverse=TRUE))
      
      index_tab
      
```
]
---
class: inverse, middle, center

Supplementary Charts and Figures

---


# Data Use (5 Pillars)

  * <span style="color:grey"> Pillar 1.1: Data use by national legislature:
    * *Not included because of lack of established methodology*
  * <span style="color:grey"> Pillar 1.2: Data use by national executive branch:
    * *Researching method on use of statistics in Voluntary National Review documents*
  * <span style="color:grey">Pillar 1.3: Data use by civil society:
    * *Not included because of lack of established methodology*
  * <span style="color:grey">Pillar 1.4: Data use by academia:
    * *Not included because of lack of established methodology*
  * **Pillar 1.5: Data use by international organizations:**
    * *Reliability/Usefulness of Poverty, Child Mortality, Debt Statistics for international agencies using metadata*
---

# Data Services (4 Pillars)

  * **Pillar 2.1: Data Releases:**
    * *SDDS/e-GDDS subscription*
  * **Pillar 2.2: Online access:**
    * *ODIN Open Data Openness score*
  * <span style="color:grey"> Pillar 2.3: Advisory/ Analytical Services:
    * *Not included because of lack of established methodology*
  * **Pillar 2.4: Data services:**
    * *NADA metadata available*

---
# Data Products (4 Pillars)

For these pillars, we pull values from the UN SDG database, calculate the share of SDG indicators with a country produced value per country

  * **Pillar 3.1: Social Statistics:**
    * *Average score for Goal 1-6 indicators*
  * **Pillar 3.2: Economic Statistics:**
    * *Average score for Goal 7-12 indicators*
  * **Pillar 3.3: Environmental Statistics:**
    * *Average score for Goal 13-15 indicators*
  * **Pillar 3.4: Institutional Statistics:**
    * *Average score for Goal 16-17 indicators*
---
# Data Sources (4 Pillars)


  * **Pillar 4.1: Censuses and Surveys:**
    * *Average score of 8 Census and Survey Indicators*
  * **Pillar 4.2: Administrative Data:**
    * *Complete CRVS, <span style="color:red"> availability of SPL admin data (ASPIRE), Education admin data (UNESCO), Labor admin data (ILO) *
  * **Pillar 4.3: Geospatial Data:**
    * *Geospatial data available at 1st Admin Level according to ODIN*
  * <span style="color:grey">Pillar 4.4: Private/citizen generated data:
    * *Not included because of lack of established methodology*

---
# Data Infrastructure (5 Pillars)


  * <span style="color:red"> Pillar 5.1: Legislation and Governance:
    * *SDG 17.18.2 - National Statistical Legislation complies with UN Fundamental Principles of Statistics (PARIS21)*
  * **Pillar 5.2: Standards and Methods:**
    * *Average score for 10 Standards and Methods indicators*
  * <span style="color:grey"> Pillar 5.3: Skills:
    * *Considering PARIS21 measure of statistical literacy*
  * <span style="color:grey"> Pillar 5.4: Partnerships:
    * *Not included because of lack of established methodology*
  * <span style="color:red"> Pillar 5.5: Finance:
    * *SDG 17.18.3 - Statistical Plan fully funded (PARIS21)*



---
.center3[
```{r dim_corr, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, dpi=300}

corr_df <- SPI %>%
  ungroup() %>%
  select(starts_with('SPI.INDEX'))

#calculate correlations between teacher practices
df_corr_plot <-    round(cor(corr_df, use="complete.obs"), 2) 
colnames(df_corr_plot) <- c('SPI Dimension 1','SPI Dimension 2','SPI Dimension 3','SPI Dimension 4','SPI Dimension 5','SPI Overall')
rownames(df_corr_plot) <- c('SPI Dimension 1','SPI Dimension 2','SPI Dimension 3','SPI Dimension 4','SPI Dimension 5','SPI Overall')

#plot the correlation in a nicely formatted table
pcorr<- ggcorrplot::ggcorrplot(df_corr_plot,
                   outline.color = "white",
                   ggtheme = theme_bw(),
                   colors = c("#F8696B", "#FFEB84", "#63BE7B"),
                   legend.title = "Correlation",
                   title = "Correlation Between SPI Dimensions",
                   lab=T) + 
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 16)) +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text.x = element_text(angle=45,vjust=.5)
  ) +
  labs( )

pcorr

```
]


---
.center3[
```{r lending_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
lending_chart_aggregate('SPI','SPI.INDEX','Statistical Performance Indicators -  Overall Scores')

```
]
---
.center3[
```{r lending_charts2, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
lending_charts('SPI','SPI.INDEX','Statistical Performance Indicators -  Overall Scores')

```
]

---
.center3[
```{r fcs_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
fcs_chart_aggregate('SPI','SPI.INDEX','Statistical Performance Indicators -  Overall Scores')

```


]
---
.center3[
```{r fcs_charts2, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
fcs_charts('SPI','SPI.INDEX','Statistical Performance Indicators -  Overall Scores')

```


]
---

.center3[
```{r sci, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}

scatter_df <- comparison_df %>%
  filter(date==2018) %>%
  pivot_longer(
    cols = c('SCI','ODIN_score'),
    names_to='alt_index',
    values_to='index_values'
  ) %>%
  mutate(alt_index=if_else(alt_index=="SCI","SCI","Open Data Watch"))

### Scatterplot SCI SPI
spi_sci_plot <- ggplot(scatter_df, aes(y=SPI.INDEX,x=index_values)) +
  facet_wrap(~alt_index,
             scales='free') +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm', 
              color='blue') +
  theme_bw() + 
  stat_poly_eq(aes(label = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     color='black',
                     label.x.npc = "right", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4) +
  ylab('SPI Index value') +
  xlab('Alternate index value') +
  theme(legend.position = 'bottom') +
  ggtitle('Scatterplot of SPI Index on Open Data Watch Index & SCI')

spi_sci_plot



```
]

---
.center3[
```{r dim1_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
spi_charts('SPI','SPI.INDEX.DIM1','Statistical Performance Indicators -  Data Use Scores')

```


]
---
.center3[
```{r dim1_country_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
spi_country_charts('SPI','SPI.INDEX.DIM1','Statistical Performance Indicators -  Data Use Scores')

```


]

---
.center3[
```{r dim2_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
spi_charts('SPI','SPI.INDEX.DIM2','Statistical Performance Indicators -  Data Services Scores')

```


]
---
.center3[
```{r dim2_country_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
spi_country_charts('SPI','SPI.INDEX.DIM2','Statistical Performance Indicators -  Data Services Scores')

```
]
---
.center3[
```{r dim3_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
spi_charts('SPI','SPI.INDEX.DIM3','Statistical Performance Indicators -  Data Products Scores')

```


]

---
.center3[
```{r dim3_country_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
spi_country_charts('SPI','SPI.INDEX.DIM3','Statistical Performance Indicators -  Data Products Scores')

```


]
---


.center3[
```{r dim4_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
spi_charts('SPI','SPI.INDEX.DIM4','Statistical Performance Indicators -  Data Sources Scores')

```


]
---


.center3[
```{r dim4_country_chartss, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
spi_country_charts('SPI','SPI.INDEX.DIM4','Statistical Performance Indicators -  Data Sources Scores')

```


]
---
.center3[
```{r dim5_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
spi_charts('SPI','SPI.INDEX.DIM5','Statistical Performance Indicators -  Data Infrastructure Scores')

```


]
---
.center3[
```{r dim5_country_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, dpi=300}
spi_country_charts('SPI','SPI.INDEX.DIM5','Statistical Performance Indicators -  Data Infrastructure Scores')

```


]
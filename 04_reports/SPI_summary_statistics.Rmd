---
title: "Statistical Performance Indicators"
author: "SPI Team"
institute: "World Bank, Development Data Group"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    fig_width: 5
    fig_height: 4
    fig_caption: true
    background-size: contain;
    css: xaringan-themer.css
---

<style>

.center2 {
  margin: 0;
  position: absolute;
  top: -80px;
  right: 0;  
  width: 800px;
  height: 800px;
}
.center3 {
  margin: 0;
  position: absolute;
  top: -20px;
  right: 20px;  
  width: 800px;
  height: 800px;
}
.reduced{
   font-size: 0.5em;
}
</style>

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(tidyverse)
library(kableExtra)
library(leaflet)
library(xaringanthemer)
library(wbggeo)
library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(plotly)
library(here)
library(patchwork)
library(ggpmisc)
style_mono_accent(base_color = "#009FDA",
                  title_slide_background_color = 'white',
                  title_slide_text_color = '#002244',
                  title_slide_background_image = 'WB_logo.png',
                  title_slide_background_size = '7',
                  title_slide_background_position = 'bottom 25px right 25px;',
                  text_font_google = google_font('Roboto'),
                  text_font_size = '24px',
                  )

#set directories
dir <- here()

raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")

#weights (either unity (1) or population)
wgt <- 1

```

```{r load, include=FALSE}

#add in population
pop_df <- wbstats::wb(country="all",
             indicator='SP.POP.TOTL',
             startdate=2004,
             enddate=2019) %>%
  mutate(date=as.numeric(date)) %>%
  mutate(population=value) %>%
  select(country, date, population) 

#import data
SPI <- read_csv(paste(output_dir, 'SPI_index.csv', sep="/")) %>%
    left_join(pop_df) %>%
  mutate(weights=wgt)  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.






#metadata 
metadata <- data.frame(
  series = c('SPI.INDEX', 'SPI.INDEX.DIM1', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5'),
  indicator_name = c('SPI Overall Score', 'Dimension 1: Data Use', 'Dimension 2: Data Services', 'Dimension 3: Data Products', 'Dimension 4: Data Sources', 'Dimension 5: Data Infrastructure')
)

#get list of country info
country_list <- wbstats::wbcountries()


SPI_2019 <- SPI %>%
  filter(date==2019) %>%
  filter(!is.na(SPI.INDEX) & !is.na(weights)) %>%
  mutate(ISO_A3_EH=iso3c) %>%
  mutate(across(contains("SPI"),~1.))

#read in TopoJSON from World Bank
#countries <- geojsonio::geojson_read("WB_countries_Admin0_lowres.geojson",
#                                     what = "sp")

```

# Introduction

- World Bank Development Data Group (DECDG) will be releasing new set of Statistical Performance Indicators along with WDR

- Will be major overhaul of Statistical Capacity Index

- Statistical Performance Indicators are tool for countries/donors to assess statistical system

Based on feedback, goal was for SPI framework to:  
  - Be forward looking (relevant at least 15 years)   
  - Measure less advanced systems, as well as more advanced systems
  - Cover entire national statistical system, not just NSO   
  - Give countries incentives to build modern statistical system



---
# Framework Overview

- SPI framework covers five dimensions:   
  1. Data Use
      * Indicators that capture demand side of statistical system 

---
# Framework Overview

- SPI framework covers five dimensions:
  1. Data Use
      * Indicators that capture demand side of statistical system   
  2. Data Services
      * Information on data releases, online access, advisory/analytical services, and other data services

---
# Framework Overview

- SPI framework covers five dimensions:
  1. Data Use
      * Indicators that capture demand side of statistical system  
  2. Data Services
      * Information on data releases, online access, advisory/analytical services, and other data services    
  3. Data Products
      * Whether the country is able to produce relevant indicators, primarily related to SDGs

---
# Framework Overview

- SPI framework covers five dimensions:
  1. Data Use
      * Indicators that capture demand side of statistical system   
  2. Data Services
      * Information on data releases, online access, advisory/analytical services, and other data services    
  3. Data Products
      * Whether the country is able to produce relevant indicators, primarily related to SDGs    
  4. Data Sources
      * Censuses and surveys, admin data, geospatial, private/citizen generated data    

---
 # Framework  Overview

- SPI framework covers five dimensions:
  1. Data Use
      * Indicators that capture demand side of statistical system  
  2. Data Services
      * Information on data releases, online access, advisory/analytical services, and other data services    
  3. Data Products
      * Whether the country is able to produce relevant indicators, primarily related to SDGs    
  4. Data Sources
      * Censuses and surveys, admin data, geospatial, private/citizen generated data      
  5. Data Infrastructure
      * Legislation and governance, standards & methods, skill, partnerships, and finance



---
# SPI Framework

.center[![unchanged image](SPI_dashboard.png)]


---


# Data Infrastructure (5 Pillars) 


  * <span style="color:red"> Pillar 5.1: Legislation and Governance:     
    * *SDG 17.18.2 - National Statistical Legislation complies with UN Fundamental Principles of Statistics (PARIS21)*  
  * **Pillar 5.2: Standards and Methods:** 
    * *Average score for 10 Standards and Methods indicators*  
  * <span style="color:grey"> Pillar 5.3: Skills:  
    * *Considering PARIS21 measure of statistical literacy*    
  * <span style="color:grey"> Pillar 5.4: Partnerships:  
    * *Not included because of lack of established methodology*    
  * <span style="color:red"> Pillar 5.5: Finance:  
    * *SDG 17.18.3 - Statistical Plan fully funded (PARIS21)*   
    
---
class: inverse, middle, center

Scores Across Countries


---
# Overview Summary of Results

  * Next, we will provide overall index
  * Will present aggregate scores overall and for each dimension    

  * Given imprecision inherent in calculations, we recommend color coding providing subdivisions of maturity
  
Countries are grouped into five groups:   

* **Top 20%**:    Shading in <span style="color:#1A9850">green</span>.    
* **4th Quantile**:  Shading in <span style="color:#BFCF28"> light green</span>.    
* **3rd Quantile**:   Shading in <span style="color:#E7BB25"> yellow</span>.  
* **2nd Quantile**:   Shading in <span style="color:#DE7B2B"> orange</span>.  
* **Bottom 20%**:   Shading in <span style="color:#D73027"> red </span>.     


---


```{r spi_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}

#Now map the result
quality = "high"
maps <- wbgmaps::wbgmaps[[quality]]


country_metadata <- wbstats::wbcountries()

data = SPI_2019



spi_mapper <- function(data, indicator, title) {
  
 indicator<-indicator

   map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))     


  spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)
  
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      between(data_available, spi_groups_quantiles[4],100) ~ "Top 20%",
      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
      between(data_available, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Top 20%","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
  
  #set color pallete
  col_pal <- c("#1A9850",  "#BFCF28", "#E7BB25", "#DE7B2B",  "#D73027" )
  names(col_pal) <- c("Top 20%","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )
  
  p1<-ggplot() +
    geom_map(data = SPI_map, aes(map_id = iso3c, fill = spi_groups), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
    geom_path(data = maps$boundaries,
              aes(long, lat, group = group),
              color = "white",
              size = 0.1,
              lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
    scale_fill_manual(
      name='SPI Score',
      values=col_pal,
      na.value='grey'
    ) +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap(title,100),
      caption = 'Source: World Bank. Statistical Performance Indicators'
    )
 print(p1)
}

spi_charts  <- function(data, indicator, title) {
  
 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  #add histogram by region 
  p2 <- map_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Region', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      expand_limits(x=c(0,100)) +
      theme_bw()
  
  #by income
    income <- c("Low income", "Lower middle income","Upper middle income","High income")

    p3 <- map_df %>%
    group_by(income) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=wtd.mean(data_available, weights=weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=income, fill=income)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = income) +
      expand_limits(x=c(0,100)) +
      theme_bw()
    
  # #add line graph over time
  p4 <- get(data)  %>%
    rename(data_available=!! indicator) %>%
    # right_join(spi_df_empty) %>%
    group_by( date) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available))) %>%
    mutate(Percentage=mean(data_available, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ungroup() %>%
    ggplot(aes(y=Percentage, x=date)) +
      geom_point() +
      geom_line(fill='blue') +
      # geom_text_repel(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Date', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data'
      ) +
    
      expand_limits(y=c(0,100)) +
      theme_bw()
      
 (p2 / p3) 
    
}

spi_country_charts  <- function(data, indicator, title) {
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  p2_alt <- map_df %>%
    ungroup() %>%
    ggplot(aes(x=data_available, y=region, color=region)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Country', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top') 
   
p2_alt

}

lending_charts <- function(data, indicator, title) { 


 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  p2_alt3 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=(data_available),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=lending, color=lending)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top') 
   
p2_alt3 
  
 
}

lending_chart_aggregate <- function(data, indicator, title) { 


 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  

  p2_alt3 <- map_df %>%
    group_by(lending) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=lending, fill=lending)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top') 
   
p2_alt3 
  
 
}



fcs_charts <- function(data, indicator, title) { 
  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")

  p2_alt2 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=(data_available),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=fcs, color=fcs)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top') 
   
p2_alt2 
  
 
}


fcs_chart_aggregate <- function(data, indicator, title) { 
  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")

  p2_alt2 <- map_df %>%
    group_by(fcs) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=fcs, fill=fcs)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top') 
  
  
  
p2_alt2 
  
 
}
```


```{r standards_meta}

#pull data for several of the standards from WDI metadata

# df <- WDI_metadata
# 
# # Manipulate and clean final data
# df <- df %>%
#   filter(!is.na(Income.Group))  #keep just countries (drop aggregations)

#pull IMF country codes for merging
imf_codes <- read_csv(file=paste(raw_dir, "metadata","IMF_country_codes.csv", sep="/" ))

```

---

### 5.2.4 CPI base year

Consumer Price Index serves as indicators of inflation and reflects changes in the 
 cost of acquiring a fixed basket of goods and services by the average consumer.  
 Weights are usually derived from consumer expenditure surveys and the CPI base year 
 refers to the year the weights were derived.  It is recommended that the base year be
 changed periodically to reflect changes in expenditure structure.  
 
 1 Point. Annual chain linking. 0.5 Points. Base year in last 10 years. 0 points. Otherwise
 
```{r cpiby}

#read in csv file.
D5.2.4.CPIBY <- read_csv(file = paste(raw_dir, "5.2_DISM","D5.2.4.CPIBY.csv", sep="/" )) %>%
  mutate(SPI.D5.2.4.CPIBY=case_when(
    CPIBY=="annual chained" ~ 1, 
    (date-as.numeric(CPIBY))<=10 ~ 0.5, #within 10 years of reference period
    TRUE ~ 0 
  ),
  RAW.D5.2.4.CPIBY=CPIBY)  %>%
  select(iso3c, country, date, RAW.D5.2.4.CPIBY, SPI.D5.2.4.CPIBY  ) %>%
  arrange(date, country)

#####
# IMF Data
#####

#use alternative data source provided by the IMF

#read in data on when the weights were last updated to measure if annual chain linking is done
D5.2.4.COICOP.WGT <-   read_excel(path=paste(raw_dir, "5.2_DISM","2020.11.04_Compiled Data for World Bank.xlsx", sep="/" ),
                               sheet = "COICOP Month_Last Change",
                               skip=2
                               ) %>%
  as_tibble(.name_repair='universal') %>%  
  rename(
    IMF_code=Code,
    IMF_country=Country_revised
  ) %>%
  mutate(IMF_code=as.numeric(IMF_code)) %>%
  left_join(imf_codes)
  
  
#read in last time the CPI reference period is updated to fill in rest of info  
D5.2.4.CPI.REF <-  read_excel(path=paste(raw_dir, "5.2_DISM","2020.11.04_Compiled Data for World Bank.xlsx", sep="/" ),
                               sheet = "CPI Reference Period Review"
                               ) %>%
  as_tibble(.name_repair='universal') %>%
  rename(IMF_country=country) %>%
  left_join(D5.2.4.COICOP.WGT) #merge CPI weights
  
#now calculate whether annual chain linking is used and CPI base year from scratch using this info
D5.2.4.CPIBY.IMF.RAW <- D5.2.4.CPI.REF %>%
  filter(!is.na(iso3c)) %>%
  mutate(CPI_ref_period=str_sub(CPI.reference.period.review,1,4),
         CPI_ref_period=as.numeric(CPI_ref_period),
         CPI_weight_change=str_sub(last_change,1,4),
         CPI_weight_change=as.numeric(CPI_weight_change)) %>%
  mutate(RAW.D5.2.4.CPIBY.IMF=if_else((CPI_weight_change>=2019 & CPI_ref_period<2020), "annual chained",as.character(CPI_ref_period))) %>%
  mutate(RAW.D5.2.4.CPIBY.IMF=if_else((iso3c=='AUS' | iso3c=='NZL'),"annual chained",as.character(RAW.D5.2.4.CPIBY.IMF))) #replace Australia and New Zealand as annual chain linking.  They use quarterly cpi releases and do not show up in this dataset
  
#score from 2010 to 2019  
if (exists('D5.2.4.CPIBY.IMF')) {
    rm(D5.2.4.CPIBY.IMF)
} 

for (i in c(2015:2019)) {
  temp <- D5.2.4.CPIBY.IMF.RAW %>%
    mutate(date=i) %>%
    mutate(SPI.D5.2.4.CPIBY.IMF=case_when(
      RAW.D5.2.4.CPIBY.IMF=="annual chained" ~ 1, 
      (date-as.numeric(RAW.D5.2.4.CPIBY.IMF))<=10 ~ 0.5, #within 10 years of reference period
      TRUE ~ 0 
    )) %>%
    select(iso3c, date, RAW.D5.2.4.CPIBY.IMF, SPI.D5.2.4.CPIBY.IMF  ) %>%
    arrange(date, iso3c)
  
  if (!exists('D5.2.4.CPIBY.IMF')) {
    D5.2.4.CPIBY.IMF <- temp
  } else {
    D5.2.4.CPIBY.IMF <- D5.2.4.CPIBY.IMF %>%
      bind_rows(temp)
  }
  
}



#update based on IMF data.  Use manually collected value when other value not available
D5.2.4.CPIBY <- D5.2.4.CPIBY %>%
  full_join(D5.2.4.CPIBY.IMF) %>%
  mutate(SPI.D5.2.4.CPIBY=if_else(!is.na(SPI.D5.2.4.CPIBY.IMF),SPI.D5.2.4.CPIBY.IMF,SPI.D5.2.4.CPIBY)) %>%
  select(-country,-SPI.D5.2.4.CPIBY.IMF) 




```

.center2[
```{r map5.2.4}
spi_mapper('SPI', 'SPI.INDEX', 'Statistical Performance Indicators -  Overall Scores')



```

]
---
 
### 5.2.5 Classification of household consumption

Classification of Individual Consumption According to Purpose (COICOP) 
is used in household budget surveys, consumer price indices and international 
comparisons of gross domestic product (GDP) and its component expenditures.  
Although COICOP is not strictly linked to any particular model of consumer 
behavior, the classification is designed to broadly reflect differences in 
income elasticities.  It is an integral part of the SNA1993 and more detailed 
subdivision of the classes provide comparability between countries and between 
statistics in these different areas.    

1 Point. Follow Classification of Individual Consumption by Purpose (COICOP)	0 Points.	Otherwise

```{r hous}

#read in csv file.
D5.2.5.HOUS <- read_csv(file = paste(raw_dir, "5.2_DISM","D5.2.5.HOUS.csv", sep="/" )) %>%
  mutate(SPI.D5.2.5.HOUS=case_when(
    HOUS=="COICOP" ~ 1, 
    TRUE ~ 0 
  ),
  RAW.D5.2.5.HOUS=HOUS)  %>%
  select(iso3c, country, date, RAW.D5.2.5.HOUS, SPI.D5.2.5.HOUS  ) %>%
  arrange(date, country)

#####
# IMF Data
#####

#use alternative data source provided by the IMF

#read in data on COICOP from IMF
D5.2.5.HOUS.IMF <-   read_excel(path=paste(raw_dir, "5.2_DISM","2020.11.04_Compiled Data for World Bank.xlsx", sep="/" ),
                               sheet = "3. Household Consump Class",
                               skip=0
                               ) %>%
  as_tibble(.name_repair='universal') %>%  
  rename(
    IMF_code=Code,
    IMF_country=Country,
  ) %>%
  mutate(SPI.D5.2.5.HOUS.IMF=case_when(
    Status=="CIOCOP" ~ 1, 
    TRUE ~ 0 
  ),
  RAW.D5.2.5.HOUS.IMF=Status) %>%
  mutate(IMF_code=as.numeric(IMF_code)) %>%
  left_join(imf_codes) %>%
  select(iso3c, RAW.D5.2.5.HOUS.IMF,SPI.D5.2.5.HOUS.IMF ) %>%
  mutate(date=2019)
  
  
D5.2.5.HOUS <-  D5.2.5.HOUS %>%
  full_join(D5.2.5.HOUS.IMF) %>%
  mutate(SPI.D5.2.5.HOUS=if_else(is.na(SPI.D5.2.5.HOUS),SPI.D5.2.5.HOUS.IMF,SPI.D5.2.5.HOUS)) %>% #fill in with IMF data if missing.  This applies mostly to high income countries
  select(-country,-SPI.D5.2.5.HOUS.IMF) %>%
  arrange(date, iso3c) 
```


---

### 5.2.6 Classification of status of employment 

Classification of status of employment refers to employment data that are 
 compiled using the current international standard International Classification 
 of Status in Employment (ISCE-93).  It classifies jobs with respect to the type
 of explicit or implicit contract of employment between the job holder and the 
 economic unit in which he or she is employed.  Therefore, it aims to provide the
 basis for production of internationally comparable statistics on the employment 
 relationship, including the distinction between salaried employment and self-employment.  
 
1 Point. Follow International Labour Organization, International Classification of Status in Employment (ICSE-93) or 2012 North American Industry Classification System (NAICS). 0 Points Otherwise. 
 
```{r empl}

#read in csv file.
D5.2.6.EMPL <- read_csv(file = paste(raw_dir, "5.2_DISM","D5.2.6.EMPL.csv", sep="/" )) %>%
  mutate(SPI.D5.2.6.EMPL=case_when(
    EMPL=="ICSE-93" | EMPL=="NAICS" ~ 1, 
    TRUE ~ 0 
  ),
  RAW.D5.2.6.EMPL=EMPL)  %>%
  select(iso3c, country, date, RAW.D5.2.6.EMPL, SPI.D5.2.6.EMPL  ) %>%
  arrange(date, country)




```

---

### 5.2.7 Central government accounting status

Government finance accounting status refers to the accounting basis for 
reporting central government financial data.  For many countries' government 
finance data, have been consolidated into one set of accounts capturing all 
the central government's fiscal activities and following noncash recording basis.  
Budgetary central government accounts do not necessarily include all central government 
units, the picture they provide of central government activities is usually incomplete.  

1 Point. Consolidated central government accounting follows noncash recording basis	 
0.5 Points. Consolidated central government accounting follows cash recording basis	 
0 Points. Otherwise 

```{r cgov}

#read in csv file.
D5.2.7.CGOV <- read_csv(file = paste(raw_dir, "5.2_DISM","D5.2.7.CGOV.csv", sep="/" )) %>%
  mutate(SPI.D5.2.7.CGOV=case_when(
    CGOV=="AC" ~ 1, 
    CGOV=="CA" ~ 0.5,
    TRUE ~ 0 
  ),
  RAW.D5.2.7.CGOV=CGOV)  %>%
  select(iso3c, country, date, RAW.D5.2.7.CGOV, SPI.D5.2.7.CGOV  ) %>%
  arrange(date, country)

#####
# IMF Data
#####

#use alternative data source provided by the IMF

#read in data from IMF
D5.2.7.CGOV.IMF <-   read_excel(path=paste(raw_dir, "5.2_DISM","2020.11.04_Compiled Data for World Bank.xlsx", sep="/" ),
                               sheet = "5. Cntrl Gct Acct Status",
                               skip=6
                               ) %>%
  as_tibble(.name_repair='universal') %>%  
  rename(
    IMF_code=Code,
    IMF_country=Country,
  ) %>%
  mutate(SPI.D5.2.7.CGOV.IMF=case_when(
    General.Government..consolidated.=="AC" ~ 1, 
    General.Government..consolidated.=="CA" ~ 0.5,
    TRUE ~ 0 
  ),
  RAW.D5.2.7.CGOV.IMF=General.Government..consolidated.) %>%
  mutate(IMF_code=as.numeric(IMF_code)) %>%
  left_join(imf_codes) %>%
  select(iso3c, RAW.D5.2.7.CGOV.IMF,SPI.D5.2.7.CGOV.IMF ) %>%
  mutate(date=2019)
  
  
D5.2.7.CGOV <-  D5.2.7.CGOV %>%
  full_join(D5.2.7.CGOV.IMF) %>%
  mutate(SPI.D5.2.7.CGOV=if_else(is.na(SPI.D5.2.7.CGOV),SPI.D5.2.7.CGOV.IMF,SPI.D5.2.7.CGOV)) %>% #fill in with IMF data if missing.  This applies mostly to high income countries
  select(-country,-SPI.D5.2.7.CGOV.IMF) %>%
  arrange(date, iso3c)

```


---

### 5.2.8 Compilation of government finance statistics

(GFSM) in use for compiling the data.  It provides guidelines on the institutional 
structure of governments and the presentation of fiscal data in a format similar to 
business accounting with a balance sheet and income statement plus guidelines on the 
treatment of exchange rate and other valuation adjustments.  The latest manual GFSM2014 
is harmonized with the SNA2008. 

1 Point. Follow the latest Government Finance Statistical Manual (2014)/ ESA2010	
0.5 Points. Previous version is used (GFSM 2001)	
0 Points. Otherwise


```{r fina}

#read in csv file.
D5.2.8.FINA <- read_csv(file = paste(raw_dir, "5.2_DISM","D5.2.8.FINA.csv", sep="/" )) %>%
  mutate(SPI.D5.2.8.FINA=case_when(
    FINA=="2014" | FINA=="ESA 2010"~ 1, 
    FINA=="2001" ~ 0.5,
    TRUE ~ 0 
  ),
  RAW.D5.2.8.FINA=FINA)  %>%
  select(iso3c, country, date, RAW.D5.2.8.FINA, SPI.D5.2.8.FINA  ) %>%
  arrange(date, country)




```


---

### 5.2.9 Compilation of monetary and financial statistics

Compilation of monetary and financial statistics refers to the Monetary and Financial Statistics Manual 
(MFSM) in use.  It covers concepts, definitions, classifications of financial instruments and sectors, and 
accounting rules, and provides a comprehensive analytic framework for monetary and financial planning and policy 
determination.  The Monetary and Finance Statistics: Compilation Guide (2008) provides detailed guidelines for 
the compilation of monetary and financial statistics in addition to MFSM. 

1 Point. Follow the latest Monetary and Finance Statistics Manual (2000) or Monetary and Finance Statistics: Compilation Guide (2008/2016)
0 Points. Otherwise

```{r mony}

#read in csv file.
D5.2.9.MONY <- read_csv(file = paste(raw_dir, "5.2_DISM","D5.2.9.MONY.csv", sep="/" )) %>%
  mutate(SPI.D5.2.9.MONY=case_when(
    MONY=="MFSM 2000" | MONY=="MFSMCG 2016"~ 1, 
    TRUE ~ 0 
  ),
  RAW.D5.2.9.MONY=MONY)  %>%
  select(iso3c, country, date, RAW.D5.2.9.MONY, SPI.D5.2.9.MONY  ) %>%
  arrange(date, country)

#####
# IMF Data
#####

#use alternative data source provided by the IMF

#read in data from IMF
D5.2.9.MONY.IMF <-   read_excel(path=paste(raw_dir, "5.2_DISM","2020.11.04_Compiled Data for World Bank.xlsx", sep="/" ),
                               sheet ="7. MFS Compilation status",
                               skip=0
                               ) %>%
  as_tibble(.name_repair='universal') %>%  
  rename(
    IMF_code=Code,
    IMF_country=Country,
  ) %>%
  mutate(SPI.D5.2.9.MONY.IMF=case_when(
    grepl('MFSM 2000',Monetary.and.Financial.Statistics..MFS..Reporting.Status) ~ 1, 
    TRUE ~ 0 
  ),
  RAW.D5.2.9.MONY.IMF=Monetary.and.Financial.Statistics..MFS..Reporting.Status) %>%
  mutate(IMF_code=as.numeric(IMF_code)) %>%
  left_join(imf_codes) %>%
  select(iso3c, RAW.D5.2.9.MONY.IMF,SPI.D5.2.9.MONY.IMF ) %>%
  mutate(date=2019)
  
  
D5.2.9.MONY <-  D5.2.9.MONY %>%
  full_join(D5.2.9.MONY.IMF) %>%
  mutate(SPI.D5.2.9.MONY=if_else(is.na(SPI.D5.2.9.MONY),SPI.D5.2.9.MONY.IMF,SPI.D5.2.9.MONY)) %>% #fill in with IMF data if missing.  This applies mostly to high income countries
  select(-country,-SPI.D5.2.9.MONY.IMF) %>%
  arrange(date, iso3c)


```



---

### 5.2.10 Business process

The Generic Statistical Business Process Model (GSBPM) aims to describe 
statistics production in a general and process-oriented way.  It is used 
both within and between statistical offices as a common basis for work with 
statistics production in different ways, such as quality, efficiency, standardization, 
and process-orientation.  It is used for all types of surveys, and "business" is not 
related to "business statistics" but refers to the statistical office, simply expressed.  

1 Point. GSBPM is in use
0 Points. Otherwise

```{r gsbp}

#read in csv file.
D5.2.10.GSBP <- read_csv(file = paste(raw_dir, "5.2_DISM","D5.2.10.GSBP.csv", sep="/" )) %>%
  mutate(SPI.D5.2.10.GSBP=case_when(
    str_to_lower(GSBP)=="yes" ~ 1, 
    TRUE ~ 0 
  ),
  RAW.D5.2.10.GSBP=GSBP)  %>%
  select(iso3c, country, date, RAW.D5.2.10.GSBP, SPI.D5.2.10.GSBP  ) %>%
  arrange(date, country)




```





--- 


```{css, echo=F}
    /* Table width = 100% max-width */

    .remark-slide table{
        width: 100%;
    }

    /* Change the background color to white for shaded rows (even rows) */

    .remark-slide thead, .remark-slide tr:nth-child(2n) {
        background-color: white;
    }
```

---

.center3[
```{r overall_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
spi_charts('SPI','SPI.INDEX','Statistical Performance Indicators -  Overall Scores')

```


]
---
.center3[
```{r country_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
spi_country_charts('SPI','SPI.INDEX','Statistical Performance Indicators -  Overall Scores')

```


]



```{r overall_sumstats, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
        #add function to produce weighted summary stats
        
        
        #produce by region
        sumstats<- SPI_2019 %>%
            group_by(region) %>%
            filter(!is.na(region)) %>%
            select(region, c('SPI.INDEX', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5'), weights) %>%
            summarise_at(c('SPI.INDEX', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5'),~round(wtd.mean(as.numeric(.),as.numeric(weights), na.rm=T),1)) 
        
        #produce global number
        sumstats_gl<- SPI_2019 %>%
            mutate(region='Global') %>%
            group_by(region) %>%
            select(region, c('SPI.INDEX', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5'), weights) %>%
            summarise_at(c('SPI.INDEX', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5'),~round(wtd.mean(as.numeric(.),as.numeric(weights), na.rm=T),1)) 
        
        
        #transpose data
        sumstats_df_long <-sumstats_gl %>%
            bind_rows(sumstats) 
        
        sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-region)))
        colnames(sumstats_df) = sumstats_df_long$region 
        
        
        sumstats_df <- sumstats_df %>%
            rownames_to_column() %>%
            rename(series=rowname)
        
        
        #create labels df
        metadata_tab2_overall <- metadata %>% 
            janitor::clean_names() %>%
            filter(series %in% c('SPI.INDEX', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5')) %>%
            select(series, indicator_name)
        
        
        #add variable label
        sumstats_df <- sumstats_df %>%
            left_join(metadata_tab2_overall) %>%
            rename(Series=series,
                   Label=indicator_name) %>%
          select(Label, everything()) %>%
          select(-Series)
        

  
```

.center3[
```{r spi_plot_region, eval=FALSE, fig.height=11, fig.width=14, message=FALSE, warning=FALSE, include=FALSE}


SPI_2019_plot_region <- sumstats_df_long %>%
  pivot_longer(cols=c("SPI.INDEX", "SPI.INDEX.DIM2",   "SPI.INDEX.DIM3",    "SPI.INDEX.DIM4",   "SPI.INDEX.DIM5"),
               names_to='series',
               values_to='value') %>%
  left_join(metadata_tab2_overall)


  p1<-ggplot(SPI_2019_plot_region, aes(x=indicator_name, y= value, fill=region)) + #now plot the output in a bar graph
    geom_col( position="dodge") +
    geom_text(aes(x=indicator_name, y=value, label=value), 
              position = position_dodge(width = 0.8), size = 3, hjust = 1) +
    geom_text( aes(x=indicator_name, y=0, label=region), 
              position = position_dodge(width = 0.8), size = 3, hjust = 0) +
  xlab(str_wrap("Indicator", width=75))+
  ylab(str_wrap("SPI Score",35)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 23))  +
  scale_fill_discrete(name="Region") +

  coord_flip() +
  expand_limits(y=0:100) +
    theme_bw() +
    ggtitle(str_wrap("Statistical Performance Measures by Region", 50)) +
      theme(
    legend.position="none"
  ) 
p1
  


```

]

<!-- --- -->
<!-- # Mean by Region -->


.reduced[

```{r sumstats_table, eval=FALSE, include=FALSE}

  kable(sumstats_df,
      digits=1,
      caption="Statistical Performance Indicator Unweighted Summary Statistics for 2019",
      format='html') %>%
  kable_styling(bootstrap_options = c('hover', 'striped'))
  
```
]

---
class: inverse, middle, center

Scores For Each Dimension Across Countries

---
.center2[
```{r dimension_1_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}
spi_mapper('SPI', 'SPI.INDEX.DIM1', 'Statistical Performance Indicators - SPI Dimension 1: Data Use')

```
]


---
.center2[
```{r dimension_2_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}
spi_mapper('SPI', 'SPI.INDEX.DIM2', 'Statistical Performance Indicators - SPI Dimension 2: Data Services')

```
]



---
.center2[
```{r dimension_3_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}
spi_mapper('SPI', 'SPI.INDEX.DIM3', 'Statistical Performance Indicators - SPI Dimension 3: Data Products')

```

]



---
.center2[
```{r dimension_4_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}
spi_mapper('SPI', 'SPI.INDEX.DIM4', 'Statistical Performance Indicators - SPI Dimension 4: Data Sources')

```
]


---

.center2[
```{r dimension_5_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}
spi_mapper('SPI', 'SPI.INDEX.DIM5', 'Statistical Performance Indicators - SPI Dimension 5: Data Infrastructure')

```
]



---
class: inverse, middle, center

Relationship of SPI Index to Other Outcomes


---
  


```{r comparison, include=FALSE}

#pull SCI values

Request_metadata <- httr::GET(url = "http://api.worldbank.org/v2/country/all/indicator/IQ.SCI.OVRL?format=json&date=2004:2019&per_page=5000")
Response_metadata <- httr::content(Request_metadata, as = "text", encoding = "UTF-8")

# Parse the JSON content and convert it to a data frame.
sci_df <- jsonlite::fromJSON(Response_metadata, flatten = TRUE) %>%
  data.frame() %>%
  transmute(
    iso3c=countryiso3code,
    country=country.value,
    date=as.numeric(date),
    SCI=value
  ) %>%
    select(iso3c, country, date, SCI  ) 

#read in ODIN data
  for (i in 2015:2018) {
   temp <- read_csv(paste(raw_dir, '/2.2_DSOA/','ODIN_',i,'.csv', sep=""))  %>%
        as_tibble(.name_repair = 'universal') %>%
        mutate(date=i) %>%
        filter(Data.categories=='All Categories')


    assign(paste('odin_df',i,sep="_"), temp)
  }

    #bind different years together
odin_df <- bind_rows(odin_df_2015, odin_df_2016, odin_df_2017, odin_df_2018)


odin_df <- odin_df %>%
    select(Country.Code, date, Overall.score) %>%
    rename(iso3c=Country.Code,
           ODIN_score=Overall.score) %>%
    group_by(date) %>%
    arrange(-ODIN_score) %>%
    mutate(ODIN_rank=rank(-ODIN_score, na.last='NA')) 


#read in the old SPI
SPI_v0_df <- readxl::read_excel(path='C:/Users/wb469649/OneDrive - WBG/DECIS/SPI_AKI/Data/FinalCopy of SPI SCORE 2016-2018-DW.xlsx', skip=2) %>%
  transmute(
    iso3c=Country,
    SPI_2016=as.numeric(Overall...7),
    SPI_2017=as.numeric(Overall...12),
    SPI_2018=as.numeric(Overall...17)
  ) %>%
  pivot_longer(
    cols=c('SPI_2016','SPI_2017','SPI_2018'),
    names_to="date",
    values_to = 'SPI_v0'
  ) %>%
  mutate(date=gsub('SPI_','',date),
         date=as.numeric(date))


#create one database
comparison_df <- SPI %>%
  ungroup() %>%
  filter(date %in% c(2016:2019)) %>%
  arrange(-SPI.INDEX) %>%
  mutate(across(starts_with('SPI.INDEX'),~.),
         across(starts_with('SPI.INDEX'),round,1)) %>%
  select(country, iso3c, date, income, region, SPI.INDEX) %>%
  left_join(sci_df) %>%
  left_join(odin_df) %>%
  left_join(SPI_v0_df)




```

# Comparison of SPI Index to SCI

  * Next, compare the SPI Index to the SCI    
  * Unique values of index:   
    * 2016 SCI had 44 unique values   
    * SPI index has 166 unique scores

  * Correlation:    
    * SPI index and SCI: `r round(cor(comparison_df$SPI.INDEX,comparison_df$SCI, use='pairwise.complete.obs'),2)`.   
    * SPI index and Open Data Watch index:  `r round(cor(comparison_df$SPI.INDEX,comparison_df$ODIN_score, use='pairwise.complete.obs'),2)`.    


---




    
```{r log_gdp, echo=FALSE, message=FALSE}

#HCI
hci_df <- wbstats::wb_data(country="countries_only", 
              indicator='HD.HCI.OVRL',
              start_date=2016,
              end_date=2019,
              return_wide = F) %>%
  left_join(select(comparison_df,iso3c,date, region,SPI.INDEX,SCI)) #merge on SPI Index data

#get the correlation for 2019
hci_df_2018 <- hci_df %>%
  filter(date==2018) 

hci_df_2018_chart <- hci_df_2018 %>%
    pivot_longer(
    cols = c('SPI.INDEX', 'SCI'),
    names_to='alt_index',
    values_to='index_values'
  ) %>%
  mutate(alt_index=if_else(alt_index=="SCI","SCI","SPI Index"))



hci_spi <- ggplot(data=hci_df_2018, aes(x=value, y=SPI.INDEX)) +
  facet_wrap(~ indicator) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm') +
  theme_bw() +
  ylab('Index value') +
  xlab('Human Capital Index') +
  stat_poly_eq(aes(label  = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     label.x.npc = "right", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4) +
    theme(legend.position = 'bottom')


hci_spi2 <- ggplot(data=hci_df_2018_chart, aes(x=value, y=index_values, color=alt_index)) +
  geom_point() +
  geom_smooth(method='lm') +
  theme_bw() +
  ylab('Index value') +
  xlab('Human Capital Index') +
  labs(
    color='Index'
  ) +
  ggtitle("SCI & SPI Index on Human Capital Index") +
  stat_poly_eq(aes(label  = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     label.x = "right", label.y = 'bottom',
                     formula = 'y~x', parse = TRUE, size = 4) +
    theme(legend.position = 'bottom')
#GDP
gdp_df <- wbstats::wb_data(
  indicator='NY.GDP.PCAP.KD',
  start_date=2016,
  end_date=2019,
  return_wide = F
    ) %>%
  left_join(select(comparison_df,iso3c,date, region,SPI.INDEX,SCI)) #merge on SPI Index data

#get the correlation for 2019
gdp_df_2019 <- gdp_df %>%
  filter(date==2019) 

gdp_df_2019_chart <- gdp_df_2019 %>%
    pivot_longer(
    cols = c('SPI.INDEX', 'SCI'),
    names_to='alt_index',
    values_to='index_values'
  ) %>%
  mutate(alt_index=if_else(alt_index=="SCI","SCI","SPI Index"))

  gdp_spi <- ggplot(data=gdp_df_2019, aes(x=value, y=SPI.INDEX)) +
  facet_wrap(~indicator) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm') +
  scale_x_log10(labels = scales::comma) +
  theme_bw() +
  ylab('Index value') +
  xlab('Log GDP Per Capita') +
  theme(legend.position = 'bottom') +
  stat_poly_eq(aes(label = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     label.x.npc = "right", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4)
  
  gdp_spi2 <- ggplot(data=gdp_df_2019_chart, aes(x=value, y=index_values, color=alt_index)) +
  geom_point() +
  geom_smooth(method='lm') +
  scale_x_log10(labels = scales::comma) +
  theme_bw() +
  ylab('Index value') +
  xlab('Log GDP Per Capita') +
  ggtitle("SCI & SPI Index on Log GDP per Capita") +
  labs(
    color='Index'
  ) +
  theme(legend.position = 'bottom') +
  stat_poly_eq(aes(label = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     label.x = "right", label.y= 'bottom',
                     formula = 'y~x', parse = TRUE, size = 4)


corr_hci_2018 <- cor(hci_df_2018$value,hci_df_2018$SPI.INDEX, use='pairwise.complete.obs')


corr_2019 <- cor(log(gdp_df_2019$value),gdp_df_2019$SPI.INDEX, use='pairwise.complete.obs')
corr_2019_nontrans <- cor(gdp_df_2019$value,gdp_df_2019$SPI.INDEX, use='pairwise.complete.obs')

```

 # GDP per capita & Human Capital Index

  * Next, show relationship to Log GDP per capita and Human Capital Index      
  * Would expect strong relationship between these and SPI Index

  * Correlation:    
    * Log GDP per capita and SPI index:  `r round(corr_2019,2)`    
    * HCI & SPI index: `r round(corr_hci_2018,2)`   
    * Provides better fit than SCI
---

.center3[
```{r gdp_plot, echo=FALSE, message=FALSE, warning=FALSE, fig.height=9, fig.width=10}

### Scatterplot log GDP SPI
(gdp_spi + hci_spi)   +
  plot_annotation(
    title='Plot of SPI Index on Human Capital Index and GDP per capita',
    caption='Source: All indicators come from the World Bank.'
    )
  

```
]


---

.center3[
```{r gdp_plot2, echo=FALSE, message=FALSE, warning=FALSE, fig.height=9, fig.width=10}

### Scatterplot log GDP SPI
(gdp_spi2 + hci_spi2)   +
  plot_annotation(
    title='Plot of SPI Index & SCI on Human Capital Index and GDP per capita',
    caption='Source: All indicators come from the World Bank.'
    )
  

```

  ]

---

.center3[
```{r overperformers, echo=FALSE, message=FALSE, warning=FALSE, fig.height=9, fig.width=10}

#get top 10 and bottom 10 over performers compared to gdp and hci

## GDP
#regress SPI on gdp
m_spi <- lm(SPI.INDEX ~ log(value) , data = gdp_df_2019) 

gdp_overperformers_df <- gdp_df_2019 %>%
  modelr::add_residuals(m_spi) %>%
  arrange(-resid) %>%
  head(15)

gdp_underperformers_df <- gdp_df_2019 %>%
  modelr::add_residuals(m_spi) %>%
  arrange(resid) %>%
  head(15)


gdp_overperformers_plot <-  gdp_overperformers_df %>%
  bind_rows(gdp_underperformers_df) %>%
  arrange(resid) %>%
  mutate(country=factor(country, levels=country),
         group=if_else(resid>=0, 'above','below')) %>%
  ggplot(aes(x=country, y=resid, color=group)) +
  geom_segment( aes(x=country ,xend=country, y=0, yend=resid), color="black") +
  geom_point(size=3) +
  scale_color_manual(name="GDP per Capita",
                     labels = c("Over-performers", "Under-performers"),
                     values = c('above'="#1A9850", 'below'="#D73027")) +
  coord_flip() +
  theme_bw() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = 'bottom'
  ) +
  xlab("") +
  ylab("SPI (deviation)") +
  ggtitle("GDP per capita")



### HCI


#regress SPI on hci
m_spi_hci <- lm(SPI.INDEX ~ value , data = hci_df_2018) 

hci_overperformers_df <- hci_df_2018 %>%
  modelr::add_residuals(m_spi_hci) %>%
  arrange(-resid) %>%
  head(15)

hci_underperformers_df <- hci_df_2018 %>%
  modelr::add_residuals(m_spi_hci) %>%
  arrange(resid) %>%
  head(15)

hci_overperformers_plot <-  hci_overperformers_df %>%
  bind_rows(hci_underperformers_df) %>%
  arrange(resid) %>%
  mutate(country=factor(country, levels=country),
         group=if_else(resid>=0, 'above','below')) %>%
  ggplot(aes(x=country, y=resid, color=group)) +
  geom_segment( aes(x=country ,xend=country, y=0, yend=resid), color="black") +
  geom_point(size=3) +
  scale_color_manual(name="HCI",
                     labels = c("Over-performers", "Under-performers"),
                     values = c('above'="#1A9850", 'below'="#D73027")) +
  coord_flip() +
  theme_bw() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = 'bottom'
  ) +
  xlab("") +
  ylab("SPI (deviation)") +
  ggtitle("Human Capital Index")



gdp_overperformers_plot + hci_overperformers_plot +
  plot_annotation(title='Top 15 Over/Under-Performers on SPI Index Compared to GDP per capita and Human Capital Index',
                  caption=str_wrap('Over and under performers calculated for GDP per capita by using OLS regression of SPI Index in 2019 on Log GDP per capita and calculting residuals from this regression.  Over and Under performers for Human Capital Index calculated similarly.',100)
                  )
```
]
---
.center3[
```{r dim_corr, echo=FALSE, message=FALSE, warning=FALSE, fig.height=9, fig.width=10}

corr_df <- SPI %>%
  ungroup() %>%
  select(starts_with('SPI.INDEX'))

#calculate correlations between teacher practices
df_corr_plot <-    round(cor(corr_df, use="complete.obs"), 2) 
colnames(df_corr_plot) <- c('SPI Dimension 1','SPI Dimension 2','SPI Dimension 3','SPI Dimension 4','SPI Dimension 5','SPI Overall')
rownames(df_corr_plot) <- c('SPI Dimension 1','SPI Dimension 2','SPI Dimension 3','SPI Dimension 4','SPI Dimension 5','SPI Overall')

#plot the correlation in a nicely formatted table
pcorr<- ggcorrplot::ggcorrplot(df_corr_plot,
                   outline.color = "white",
                   ggtheme = theme_bw(),
                   colors = c("#F8696B", "#FFEB84", "#63BE7B"),
                   legend.title = "Correlation",
                   title = "Correlation Between SPI Dimensions",
                   lab=T) + 
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 16)) +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text.x = element_text(angle=45,vjust=.5)
  ) +
  labs( )

pcorr

```
]



---
class: inverse, middle, center

Supplementary Charts and Figures

---
---
.center3[
```{r lending_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
lending_chart_aggregate('SPI','SPI.INDEX','Statistical Performance Indicators -  Overall Scores')

```
]
---
.center3[
```{r lending_charts2, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
lending_charts('SPI','SPI.INDEX','Statistical Performance Indicators -  Overall Scores')

```
]

---
.center3[
```{r fcs_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
fcs_chart_aggregate('SPI','SPI.INDEX','Statistical Performance Indicators -  Overall Scores')

```


]
---
.center3[
```{r fcs_charts2, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
fcs_charts('SPI','SPI.INDEX','Statistical Performance Indicators -  Overall Scores')

```


]
---

.center3[
```{r sci, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}

scatter_df <- comparison_df %>%
  filter(date==2018) %>%
  pivot_longer(
    cols = c('SCI','ODIN_score'),
    names_to='alt_index',
    values_to='index_values'
  ) %>%
  mutate(alt_index=if_else(alt_index=="SCI","SCI","Open Data Watch"))

### Scatterplot SCI SPI
spi_sci_plot <- ggplot(scatter_df, aes(y=SPI.INDEX,x=index_values)) +
  facet_wrap(~alt_index,
             scales='free') +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm', 
              color='blue') +
  theme_bw() + 
  stat_poly_eq(aes(label = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     color='black',
                     label.x.npc = "right", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4) +
  ylab('SPI Index value') +
  xlab('Alternate index value') +
  theme(legend.position = 'bottom') +
  ggtitle('Scatterplot of SPI Index on Open Data Watch Index & SCI')

spi_sci_plot



```
]

---
.center3[
```{r dim1_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
spi_charts('SPI','SPI.INDEX.DIM1','Statistical Performance Indicators -  Data Use Scores')

```


]
---
.center3[
```{r dim1_country_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
spi_country_charts('SPI','SPI.INDEX.DIM1','Statistical Performance Indicators -  Data Use Scores')

```


]

---
.center3[
```{r dim2_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
spi_charts('SPI','SPI.INDEX.DIM2','Statistical Performance Indicators -  Data Services Scores')

```


]
---
.center3[
```{r dim2_country_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
spi_country_charts('SPI','SPI.INDEX.DIM2','Statistical Performance Indicators -  Data Services Scores')

```
]
---
.center3[
```{r dim3_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
spi_charts('SPI','SPI.INDEX.DIM3','Statistical Performance Indicators -  Data Products Scores')

```


]

---
.center3[
```{r dim3_country_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
spi_country_charts('SPI','SPI.INDEX.DIM3','Statistical Performance Indicators -  Data Products Scores')

```


]
---


.center3[
```{r dim4_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
spi_charts('SPI','SPI.INDEX.DIM4','Statistical Performance Indicators -  Data Sources Scores')

```


]
---


.center3[
```{r dim4_country_chartss, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
spi_country_charts('SPI','SPI.INDEX.DIM4','Statistical Performance Indicators -  Data Sources Scores')

```


]
---
.center3[
```{r dim5_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
spi_charts('SPI','SPI.INDEX.DIM5','Statistical Performance Indicators -  Data Infrastructure Scores')

```


]
---
.center3[
```{r dim5_country_charts, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
spi_country_charts('SPI','SPI.INDEX.DIM5','Statistical Performance Indicators -  Data Infrastructure Scores')

```


]
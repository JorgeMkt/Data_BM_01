---
title: "Statistical Performance Indicators"
author: "SPI Team"
institute: "World Bank, Development Data Group"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    fig_width: 5
    fig_height: 4
    fig_caption: true
    background-size: contain;
    css: xaringan-themer.css
---

<style>

.center2 {
  margin: 0;
  position: absolute;
  top: -80px;
  right: 0;  
  width: 800px;
  height: 800px;
}
.center3 {
  margin: 0;
  position: absolute;
  top: -20px;
  right: 20px;  
  width: 800px;
  height: 800px;
}
.reduced{
   font-size: 0.5em;
}
</style>

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(tidyverse)
library(kableExtra)
library(leaflet)
library(xaringanthemer)
library(wbggeo)
library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(plotly)
library(here)
library(patchwork)

style_mono_accent(base_color = "#009FDA",
                  title_slide_background_color = 'white',
                  title_slide_text_color = '#002244',
                  title_slide_background_image = 'WB_logo.png',
                  title_slide_background_size = '7',
                  title_slide_background_position = 'bottom 25px right 25px;',
                  text_font_google = google_font('Roboto'),
                  text_font_size = '24px',
                  
                  )

#set directories
dir <- here()

raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")

```

```{r load, include=FALSE}



#import data
SPI <- read_csv(paste(output_dir, 'SPI_index.csv', sep="/"))



#metadata 
metadata <- data.frame(
  series = c('SPI.INDEX', 'SPI.INDEX.DIM1', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5'),
  indicator_name = c('SPI Overall Score', 'Dimension 1: Data Use', 'Dimension 2: Data Services', 'Dimension 3: Data Products', 'Dimension 4: Data Sources', 'Dimension 5: Data Infrastructure')
)

#get list of country info
country_list <- wbstats::wbcountries()

SPI_2019 <- SPI %>%
  filter(date==2019) %>%
  mutate(weights=1) %>%  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.
  filter(!is.na(SPI.INDEX) & !is.na(weights)) %>%
  mutate(ISO_A3_EH=iso3c) %>%
  mutate(across(contains("SPI"),~100*.))

#read in TopoJSON from World Bank
#countries <- geojsonio::geojson_read("WB_countries_Admin0_lowres.geojson",
#                                     what = "sp")

```

# Introduction

- World Bank Development Data Group (DECDG) will be releasing new set of Statistical Performance Indicators along with WDR

- Will be major overhaul of Statistical Capacity Index

- Statistical Performance Indicators are tool for countries/donors to assess statistical system

Goal was for SPI framework to:  
  - Be forward looking (relevant at least 15 years)   
  - Measure low income systems, as well as advanced systems
  - Cover entire national statistical system, not just NSO   
  - Give countries incentives to build modern statistical system



---
# Building on SCI

- Statistical Performance Indicators build on the Statistical Capacity Index

The SCI (in use since 2004) has three dimensions:   
  1. Methodology (Balance of payments manual in use, CPI base year, SDDS, etc.)   
  2. Source Data (Agriculture Census, Health Surveys, etc)    
  3. Periodicity (values for indicators: access to water, child malnutrition, poverty, etc)   

--

New Statistical Performance Indicators build on this:
  - Includes same (or similar) indicators   
  - But also expands into new areas    
  - Open Data and Open Code   
  - Still will provide time series (minimum 3 years) for indicators   

---
# Framework Overview

- SPI framework covers five dimensions:   
  1. Data Use
      * Indicators that capture demand side of statistical system 

---
# Framework Overview

- SPI framework covers five dimensions:
  1. Data Use
      * Indicators that capture demand side of statistical system   
  2. Data Services
      * Information on data releases, online access, advisory/analytical services, and other data services

---
# Framework Overview

- SPI framework covers five dimensions:
  1. Data Use
      * Indicators that capture demand side of statistical system  
  2. Data Services
      * Information on data releases, online access, advisory/analytical services, and other data services    
  3. Data Products
      * Whether the country is able to produce relevant indicators, primarily related to SDGs

---
# Framework Overview

- SPI framework covers five dimensions:
  1. Data Use
      * Indicators that capture demand side of statistical system   
  2. Data Services
      * Information on data releases, online access, advisory/analytical services, and other data services    
  3. Data Products
      * Whether the country is able to produce relevant indicators, primarily related to SDGs    
  4. Data Sources
      * Censuses and surveys, admin data, geospatial, private/citizen generated data    

---
 # Framework  Overview

- SPI framework covers five dimensions:
  1. Data Use
      * Indicators that capture demand side of statistical system  
  2. Data Services
      * Information on data releases, online access, advisory/analytical services, and other data services    
  3. Data Products
      * Whether the country is able to produce relevant indicators, primarily related to SDGs    
  4. Data Sources
      * Censuses and surveys, admin data, geospatial, private/citizen generated data      
  5. Data Infrastructure
      * Legislation and Governance, standards, skill, partnerships, and finance



---
# SPI Framework

.center[![unchanged image](SPI_dashboard.png)]


---
# Data Use (5 Indicators)

  * <span style="color:grey"> Indicator 1.1: Data use by national legislature:   
    * *Not included because of lack of established methodology*   
  * <span style="color:red"> Indicator 1.2: Data use by national executive branch:    
    * *Researching method on use of statistics in Voluntary National Review documents*      
  * <span style="color:grey">Indicator 1.3: Data use by civil society:    
    * *Not included because of lack of established methodology*    
  * <span style="color:grey">Indicator 1.4: Data use by academia:      
    * *Not included because of lack of established methodology*   
  * **Indicator 1.5: Data use by international organizations:**  
    * *Reliability/Usefulness of Poverty, Child Mortality, Debt Statistics for international agencies using metadata*    

---
# Data Services (4 Indicators)

  * **Indicator 2.1: Data Releases:** 
    * *SDDS/e-GDDS subscription*    
  * **Indicator 2.2: Online access:** 
    * *ODIN Open Data Openness score*   
  * <span style="color:grey"> Indicator 2.3: Advisory/ Analytical Services:  
    * *Not included because of lack of established methodology*    
  * **Indicator 2.4: Data services:** 
    * *NADA metadata available*
    
---
  
# Data Products (4 Indicators) 

For these indicators, we pull values from the UN SDG database, calculate the share of SDG indicators with a valid value per country

  * **Indicator 3.1: Social Statistics:** 
    * *Average score for Goal 1-6 indicators*
  * **Indicator 3.2: Economic Statistics:** 
    * *Average score for Goal 7-12 indicators*  
  * **Indicator 3.3: Environmental Statistics:** 
    * *Average score for Goal 13-15 indicators*      
  * **Indicator 3.4: Institutional Statistics:**
    **Average score for Goal 16-17 indicators*
    
---

# Data Sources (4 Indicators) 


  * **Indicator 4.1: Censuses and Surveys:** 
    * *Average score 10 Census and Survey Indicators*    
  * **Indicator 4.2: Administrative Data:** 
    * *Complete CRVS, availability of SPL admin data (APSIRE), Education admin data (UNESCO), Labor admin data (ILO) *  
  * **Indicator 4.3: Geospatial Data:**  
    * *Geospatial data available at 1st Admin Level according to ODIN* 
  * <span style="color:grey">Indicator 4.4: Private/citizen generated data:  
    * *Not included because of lack of established methodology*   
    
---

# Data Infrastructure (5 Indicators) 


  * **Indicator 5.1: legislation and governance:**  
    * *SDG 17.18.2 - National Statistical Legislation complies with UN Fundamental Principles of Statistics (PARIS21)*  
  * **Indicator 5.2: Standards and Methods:** 
    * *Average score for 10 Standards and Methods indicators*  
  * <span style="color:red"> Indicator 5.3: skills:  
    * *Considering PARIS21 measure of statistical literacy*    
  * <span style="color:grey"> Indicator 5.4: partnerships:  
    * *Not included because of lack of established methodology*    
  * **Indicator 5.5: finance:**  
    * *SDG 17.18.3 - Statistical Plan fully funded (PARIS21)*   
    
---
class: inverse, middle, center

Overall Scores Across Countries


  

---

.center2[
```{r spi_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}

#Now map the result
quality = "high"
maps <- wbgmaps::wbgmaps[[quality]]


country_metadata <- wbstats::wbcountries()

data = SPI_2019



spi_mapper <- function(indicator,title_text) {
  
  indicator<-enquo(indicator)

  
  SPI_map <- SPI_2019 %>%
      mutate(indicator = !! indicator) %>%
      mutate(indicator = indicator) %>%
      mutate(spi_groups=case_when( #create groupings
      between(indicator, 90, 100) ~ "90-100",
      between( indicator, 80, 90) ~ "80-90",
      between( indicator, 70, 80) ~ "70-80",
      between( indicator, 60, 70) ~ "60-70",
      between( indicator, 50, 60) ~ "50-60",
      between( indicator, 40, 50) ~ "40-50",
      between( indicator, 30, 40) ~ "30-40",
      between( indicator, 20, 30) ~ "20-30",
      between( indicator, 10, 20) ~ "10-20",
      between( indicator, 0, 10) ~ "0-10" 
           )) %>%
      mutate(spi_groups=factor(spi_groups, levels=c("0-10", "10-20","20-30","30-40","40-50","50-60","60-70","70-80", "80-90", "90-100" ))) %>%
    select(iso3c, spi_groups, indicator) %>%
    right_join(country_list)
  
  
  
   ggplot() +
    geom_map(data = SPI_map, aes(map_id = iso3c, fill = spi_groups), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
     geom_path(data = maps$boundaries,
               aes(long, lat, group = group),
               color = "white",
               size = 0.1,
               lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
    scale_fill_brewer(
      name='SPI Score',
      palette='RdYlGn',
      na.value='grey'
    ) +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap(title_text,100),
      caption = 'Source: World Bank. Statistical Performance Indicators'
    )


}

spi_charts  <- function(data, indicator, title) {
  
 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  #add histogram by region 
  p2 <- map_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=100*mean(data_available, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Region', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (usually 2019)'
      ) +
      expand_limits(x=c(0,100)) +
      theme_bw()

  #by income
    p3 <- map_df %>%
    group_by(income) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=100*mean(data_available, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=income, fill=income)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (usually 2019)'
      ) +
      expand_limits(x=c(0,100)) +
      theme_bw()
    
  # #add line graph over time
  p4 <- get(data)  %>%
    rename(data_available=!! indicator) %>%
    # right_join(spi_df_empty) %>%
    group_by( date) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available))) %>%
    mutate(Percentage=100*mean(data_available, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ungroup() %>%
    ggplot(aes(y=Percentage, x=date)) +
      geom_point() +
      geom_line(fill='blue') +
      # geom_text_repel(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Date', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data'
      ) +
      expand_limits(y=c(0,100)) +
      theme_bw()
      
 (p2 + p3) 
    
}


spi_mapper(SPI.INDEX, 'Statistical Performance Indicators -  Overall Scores')

spi_charts('SPI','SPI.INDEX','Statistical Performance Indicators -  Overall Scores')


```

]

```{css, echo=F}
    /* Table width = 100% max-width */

    .remark-slide table{
        width: 100%;
    }

    /* Change the background color to white for shaded rows (even rows) */

    .remark-slide thead, .remark-slide tr:nth-child(2n) {
        background-color: white;
    }
```

---
.center3[
```{r region_plot, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}



p <- ggplot(data = SPI_2019, aes(y = region, x = SPI.INDEX,  color=region)) +
              geom_point() +
              geom_text(aes(label=country), position=position_jitter(width=.3,height=.3), check_overlap=T) +
              theme_bw() +
              ggtitle('Plot of SPI Overall Score by Region') +
              xlab('SPI Overall Score') +
              expand_limits(x=c(0,100)) +
              theme(
                axis.title.y = element_blank(),
                legend.position = 'none'
                
              )
            
            
        

p

```
]

<!-- --- -->

```{r overall_sumstats, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
        #add function to produce weighted summary stats
        
        
        #produce by region
        sumstats<- SPI_2019 %>%
            group_by(region) %>%
            filter(!is.na(region)) %>%
            select(region, c('SPI.INDEX', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5'), weights) %>%
            summarise_at(c('SPI.INDEX', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5'),~round(wtd.mean(as.numeric(.),as.numeric(weights), na.rm=T),1)) 
        
        #produce global number
        sumstats_gl<- SPI_2019 %>%
            mutate(region='Global') %>%
            group_by(region) %>%
            select(region, c('SPI.INDEX', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5'), weights) %>%
            summarise_at(c('SPI.INDEX', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5'),~round(wtd.mean(as.numeric(.),as.numeric(weights), na.rm=T),1)) 
        
        
        #transpose data
        sumstats_df_long <-sumstats_gl %>%
            bind_rows(sumstats) 
        
        sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-region)))
        colnames(sumstats_df) = sumstats_df_long$region 
        
        
        sumstats_df <- sumstats_df %>%
            rownames_to_column() %>%
            rename(series=rowname)
        
        
        #create labels df
        metadata_tab2_overall <- metadata %>% 
            janitor::clean_names() %>%
            filter(series %in% c('SPI.INDEX', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5')) %>%
            select(series, indicator_name)
        
        
        #add variable label
        sumstats_df <- sumstats_df %>%
            left_join(metadata_tab2_overall) %>%
            rename(Series=series,
                   Label=indicator_name) %>%
          select(Label, everything()) %>%
          select(-Series)
        

  
```

.center3[
```{r spi_plot_region, eval=FALSE, fig.height=11, fig.width=14, message=FALSE, warning=FALSE, include=FALSE}


SPI_2019_plot_region <- sumstats_df_long %>%
  pivot_longer(cols=c("SPI.INDEX", "SPI.INDEX.DIM2",   "SPI.INDEX.DIM3",    "SPI.INDEX.DIM4",   "SPI.INDEX.DIM5"),
               names_to='series',
               values_to='value') %>%
  left_join(metadata_tab2_overall)


  p1<-ggplot(SPI_2019_plot_region, aes(x=indicator_name, y= value, fill=region)) + #now plot the output in a bar graph
    geom_col( position="dodge") +
    geom_text(aes(x=indicator_name, y=value, label=value), 
              position = position_dodge(width = 0.8), size = 3, hjust = 1) +
    geom_text( aes(x=indicator_name, y=0, label=region), 
              position = position_dodge(width = 0.8), size = 3, hjust = 0) +
  xlab(str_wrap("Indicator", width=75))+
  ylab(str_wrap("SPI Score",35)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 23))  +
  scale_fill_discrete(name="Region") +

  coord_flip() +
  expand_limits(y=0:100) +
    theme_bw() +
    ggtitle(str_wrap("Statistical Performance Measures by Region", 50)) +
      theme(
    legend.position="none"
  ) 
p1
  


```

]

<!-- --- -->
<!-- # Mean by Region -->


.reduced[

```{r sumstats_table, eval=FALSE, include=FALSE}

  kable(sumstats_df,
      digits=1,
      caption="Statistical Performance Indicator Unweighted Summary Statistics for 2019",
      format='html') %>%
  kable_styling(bootstrap_options = c('hover', 'striped'))
  
```
]
---
class: inverse, middle, center

Scores For Each Dimension Across Countries

---
.center2[
```{r dimension_1_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}
spi_mapper(SPI.INDEX.DIM1, 'Statistical Performance Indicators - SPI Dimension 1: Data Use')

```
]

---
.center2[
```{r dimension_2_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}
spi_mapper(SPI.INDEX.DIM2, 'Statistical Performance Indicators - SPI Dimension 2: Data Services')

```
]



---
.center2[
```{r dimension_3_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}
spi_mapper(SPI.INDEX.DIM3, 'Statistical Performance Indicators - SPI Dimension 3: Data Products')

```

]
---
.center2[
```{r dimension_4_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}
spi_mapper(SPI.INDEX.DIM4, 'Statistical Performance Indicators - SPI Dimension 4: Data Sources')

```
]
---

.center2[
```{r dimension_5_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}
spi_mapper(SPI.INDEX.DIM5, 'Statistical Performance Indicators - SPI Dimension 5: Data Infrastructure')

```
]
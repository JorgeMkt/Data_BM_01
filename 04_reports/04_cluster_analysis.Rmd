---
title: "PCA and Cluster Analyis of SPI Data"
author: "Brian Stacy"
date: "1/8/2021"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6, fig.cap = "&nbsp;", fig.path = "plots/", dev = c("png"), dpi=500)
library(tidyverse)
library(flextable)
library(here)
# devtools::install_github("worldbank/wbgviz", subdir = "wbgdata")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgcharts")
# devtools::install_github("worldbank/wbgviz", subdir = "wbggeo")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgmaps")
library(wbggeo)
library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(httr)
library(patchwork)
library(ggrepel)
library(haven)
library(zoo)
library(estimatr)
library(ggpmisc)
library(ggthemes)
library(factoextra)
library(ggforce)
library(broom)
#set directories
dir <- here()

raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")

#weights (either unity (1) or population)
wgt <- 1
```


```{r load, include=FALSE}

#add in population
pop_df <- wbstats::wb_data(country="all",
             indicator='SP.POP.TOTL',
             start_date=2004,
             end_date=2019) %>%
  mutate(date=as.numeric(date)) %>%
  mutate(population=SP.POP.TOTL) %>%
  select(country, date, population) 

#import data
SPI <- read_csv(paste(output_dir, 'SPI_index.csv', sep="/")) %>%
    left_join(pop_df) %>%
  mutate(weights=wgt)  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.

spi_index_df <- SPI



#read in the SPI dataset
spi_df_final <- read_csv( file = paste(output_dir, 'SPI_data.csv', sep="/")) %>%
  left_join(pop_df) %>%
  mutate(weights=wgt)  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.



#metadata 
metadata <- data.frame(
  series = c('SPI.INDEX', 'SPI.INDEX.DIM1', 'SPI.INDEX.DIM2', 'SPI.INDEX.DIM3', 'SPI.INDEX.DIM4', 'SPI.INDEX.DIM5'),
  indicator_name = c('SPI Overall Score', 'Dimension 1: Data Use', 'Dimension 2: Data Services', 'Dimension 3: Data Products', 'Dimension 4: Data Sources', 'Dimension 5: Data Infrastructure')
)

#get list of country info
country_list <- wbstats::wb_countries()


SPI_2019 <- SPI %>%
  filter(date==2019) %>%
  filter(!is.na(SPI.INDEX) & !is.na(weights)) %>%
  mutate(ISO_A3_EH=iso3c) 

#get spi groups
  spi_groups_quantiles <- quantile(SPI_2019$SPI.INDEX, probs=c(1,2,3,4)/5,na.rm=T)
  
  SPI_2019_group_df <- SPI %>%
    filter(date==2019) %>%
    select(country, iso3c, date, region, income, starts_with('SPI')) %>%
    mutate(spi_groups=case_when(
      between(SPI.INDEX, spi_groups_quantiles[4],100) ~ "Top 20%",
      between(SPI.INDEX, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
      between(SPI.INDEX, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
      between(SPI.INDEX, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
      between(SPI.INDEX, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Top 20%","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
  
```

# Introduction

This is some exploratory analysis looking at both the number of dimensions in our statistical performance indicators and whether our quintile based approach for grouping countries is sensible.

We apply two methods.  First, we use principal components analysis (PCA) to examine how many relevant dimensions are present across our 54 SPI indicators.  Second, we compare our SPI quintile groups to groups formed using K means clustering.

Takeaways:

* There appears to be a single dominant dimension according to PCA that accounts for roughly 33% of the variation in our indicators.  This primary principal component is very strongly related to our SPI overall score ($R^2=0.96$).  There is also a second dimension that explains around 10% of the variation.  This second dimension seems to correspond most strongly with the Data Products dimension ($R^2=0.34$)

* K means cluster analysis with between 3-5 clusters seem to roughly line up with our SPI quintile groups, although K-means clustering tends to introduce differences along the 2nd PCA dimension, which our SPI quintile groups does not.

# Principal Components Analysis

Start by assessing dimensionality of SPI indicator data.  We will use principal components analysis applied to our 54 SPI indicators using data from 2019.  We begin by showing a "Scree" plot to show the number of principal components to keep in our principal components analysis.  There appears to be a single dominant principal component, with a second dimension that is less important but makes up 10% of the variation.

```{r pca,fig.height=6, fig.width=12}

pca_df <- spi_index_df %>%
  filter(date==2019) %>%
  filter(!is.na(SPI.INDEX)) %>%
  select(country, starts_with("SPI.")) %>%
  select(-starts_with('SPI.INDEX')) %>%
  column_to_rownames(var='country')

pca_df <- pca_df %>% 
  nest() %>%
  mutate(pca = map(data, ~ prcomp(.x, 
                                  center = TRUE, scale = TRUE)))

#scree plot
pca_df$pca %>%
  map(~tidy(.x, data = .y, "pcs")) %>%
  as.data.frame() %>%
  ggplot(aes(x = PC, y=percent)) +
  geom_bar(stat="identity") + 
  geom_text_repel(aes(label=round(percent,2)), nudge_y = 0.007) +
  labs(x="PC",y="Variance Explained") +
  xlab('Principal Component') +
  labs(title='Scree Plot from Principal Component Analysis on Statistical Performance Indicators'
      ) +
  theme_bw()




```


Next we look at how well the single PCA dimension maps to our SPI Overall Score.  The fit is quite strong.  The R squared in a regression of the SPI overall score on the 1st principal component is around 0.96.

This is some evidence that our SPI overall score is picking up the bulk of the variation between countries, since it is highly correlated with a dominant 1st principal component.

```{r pcascatter}


#augment data with pca
pca_compare_df <- pca_df %>% 
  mutate(pca_aug = map2(pca, data, ~augment(.x, data = .y))) %>%
  select(pca_aug) %>%
  unnest() %>%
  mutate(date=2019) 

#link SPI index

  #add to cluster database
pca_compare_df <- pca_compare_df %>%
  left_join(SPI_2019_group_df)

#scatter plot of pca versus SPI overall score
ggplot(pca_compare_df, aes(x=SPI.INDEX, y=.fittedPC1, color=spi_groups)) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm', color='blue') +
  theme_bw() +
  ylab('PCA1') +
  xlab('SPI Overall Score') +
  ggtitle('SPI Overall Score highly correlated with 1st Principal Component') +
  stat_poly_eq(aes(label  = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")),
                     color='black',
                     label.x.npc = "left", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4) +
    theme(legend.position = 'bottom')
```

Next we look at how the SPI dimension sub-scores line up with the first principal component and the second principal component. The first principal component aligns strongly with the SPI overall score, but also with the dimension sub-scores as well. The second principal component aligns most strongly with the Dimension 3 on Data Products. 

```{r seconddim}

pca_compare_df2 <- pca_compare_df %>%
  select(country, iso3c, date, region, income, spi_groups, starts_with("SPI.INDEX"), .fittedPC1, .fittedPC2 )

#pivot_longer
pca_compare_df2 <- pca_compare_df2 %>%
  pivot_longer(
    cols=starts_with("SPI.INDEX"),
    names_to='index',
    values_to='values'
  ) %>%
  mutate(index=case_when(
    index=='SPI.INDEX' ~ "SPI Overall Score",
    index=='SPI.INDEX.DIM1' ~ "Dim 1: Data Use",
    index=='SPI.INDEX.DIM2' ~ "Dim 2: Data Services",
    index=='SPI.INDEX.DIM3' ~ "Dim 3: Data Products",
    index=='SPI.INDEX.DIM4' ~ "Dim 4: Data Sources",
    index=='SPI.INDEX.DIM5' ~ "Dim 5: Data Infrastructure"
  ))

#scatter plot of pca versus SPI scores
ggplot(pca_compare_df2, aes(x=values, y=.fittedPC1, color=spi_groups)) +
  facet_wrap( ~ index) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm', color='blue') +
  theme_bw() +
  ylab('PCA1') +
  xlab('SPI Overall Score') +
  ggtitle('Correlations of SPI Overall Scores and Sub-Scores with 1st Principal Component') +
  stat_poly_eq(aes(label  = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")),
                     color='black',
                     label.x.npc = "left", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4) +
    theme(legend.position = 'bottom')

ggplot(pca_compare_df2, aes(x=values, y=.fittedPC2, color=spi_groups)) +
  facet_wrap( ~ index) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm', color='blue') +
  theme_bw() +
  ylab('PCA2') +
  xlab('SPI Overall Score') +
  ggtitle('Correlations of SPI Overall Scores and Sub-Scores with 2nd Principal Component') +
  stat_poly_eq(aes(label  = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")),
                     color='black',
                     label.x.npc = "left", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4) +
    theme(legend.position = 'bottom')


```


# K Means clustering

Next, we can assess whether our SPI quintile groups serve as sensible groups between countries.  In order to do this, we compare our SPI groups to those formed using K means clustering.  The K means clustering algorithm finds the groups of observations (in our case countries) that minimize the within group variance in our 54 indicators.  

In the analysis below, we explore both the optimal number of clusters and whether our SPI groupings based on the quintile of the SPI overall score match these K means clusters.

We examine different numbers of clusters below and visually inspect which seems to provide sensible clusters.  We choose k=8,5,4, and 3. 

# Clustering using 8 clusters

```{r clusteranalysis, echo=FALSE, fig.height=10, fig.width=10}

cluster_df <- spi_index_df %>%
  filter(date==2019) %>%
  filter(!is.na(SPI.INDEX)) %>%
  select(country, starts_with("SPI.")) %>%
  select(-starts_with('SPI.INDEX')) %>%
  column_to_rownames(var='country')

# Enhanced k-means clustering
res.km <- eclust(cluster_df, "kmeans")
#fviz_gap_stat(res.km$gap_stat)
```

# Clustering using 5 clusters

```{r clusteranalysis5, echo=FALSE, fig.height=10, fig.width=10}
#now form 5 clusters 
res.km.5 <- eclust(cluster_df, "kmeans", k=5)
```

# Clustering using 4 clusters

```{r clusteranalysis4, echo=FALSE, fig.height=10, fig.width=10}

#form 4 clusters and plot
res.km.4<- eclust(cluster_df, "kmeans", k=4)
```

# Clustering using 3 clusters

```{r clusteranalysis3, echo=FALSE, fig.height=10, fig.width=10}

#form 3 clusters and plot
res.km.3<- eclust(cluster_df, "kmeans", k=3)
```

# Compare k means clustering to SPI Overall Score Quintiles


Finally, we visually show how our SPI quintile groups might compare with some of the results from K means clustering.  General, our SPI quintile groups line up closely with the 1st PCA dimension, whereas the K means clustering also pick up differences with the 2nd PCA dimension causing some differences.

```{r clusteranalysiscompare, echo=FALSE, fig.height=10, fig.width=10}

cluster_analysis_df<-res.km.3$clust_plot$data %>%
  rownames_to_column(var='country') %>%
  mutate(date=2019) 

#link SPI index

  #add to cluster database
  cluster_analysis_df <- cluster_analysis_df %>%
  left_join(SPI_2019_group_df)
  
  # ggplot(cluster_analysis_df, aes(x=as.numeric(cluster), y=spi_groups, label=iso3c, color=income)) +
  #   geom_point() +
  #   geom_text_repel()

# # Enhanced hierarchical clustering
# res.hc <- eclust(cluster_df, "hclust") # compute hclust
# fviz_gap_stat(res.hc$gap_stat)
# fviz_dend(res.hc, rect = TRUE) # dendrogam
# hc_df<-res.hc$cluster %>%
#   as_tibble()
```

We can visually observe how well our SPI quintile groupings fit with the first two PCA dimensions.

Countries shaded in dark red are the lowest performing, countries in dark green are the highest performing.  Countries are grouped into five groups:   

* **Top 20%**:  Countries in the top 20% are classified in this group.  Shading in <span style="color:#2ec4b6">dark green</span>.    
* **4th Quantile**: Countries in the 4th quantile, or those above the 60th percentile but below the 80th percentile are in this group.  Shading in <span style="color:#acece7">light green</span>.    
* **3rd Quantile**: Countries in the 3rd quantile, or those between the 40th and 60th percentile, are classified in this group.  Shading in <span style="color:#f1dc76">yellow</span>.  
* **2nd Quantile**: Countries in the 2nd quantile, or those above the 20th percentile but below the 40th percentile, are in this group.  Shading in <span style="color:#ffbf69">light orange</span>.  
* **Bottom 20%**: Countries in the bottom 20% are classified in this group.  Shading in <span style="color:#ff9f1c">dark orange </span>.  



```{r compare, fig.height=10, fig.width=12}

# Correlation-based distance method
res.dist <- get_dist(cluster_df, method = "euclidean")
#head(round(as.matrix(res.dist), 2))[, 1:6]

#cluster plot using quintiles
  ggplot(cluster_analysis_df, aes(x=x, y=y, label=country, color=spi_groups)) +
    geom_mark_ellipse(aes(label = spi_groups, fill = spi_groups), show.legend = FALSE) +
    geom_text() +
    theme_bw() +
    xlab('PCA Dim 1') +
    ylab('PCA Dim 2') +
    ggtitle('Plot of first two PCA dimensions with SPI Quintile Groups')

    

```


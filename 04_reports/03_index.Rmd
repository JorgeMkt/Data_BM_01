---
title: 'Measuring the Statistical Performance of Countries: An Overview of the SPI  Index'
author: "SPI Team"
date: "`r Sys.Date()`"
output:
  word_document: 
    toc: yes
    fig_width: 9
    fig_height: 6
  html_document:
    theme: sandstone
    fig_width: 9
    fig_height: 7
abstract: Recognizing the new challenges for national statistical systems in monitoring  the
  Sustainable Development Goals (SDGs), the World Bank is developing a new, improved  Statistical  Performance
  Indicators (SPI) to monitor progress of the statistical  performance  of countries.
  This will replace the Statistical Capacity Index (SCI)  the World  Bank has regularly
  published since 2004. This short note briefly discusses  the  motivation behind
  the new SPI, describes some of its major features, and discusses  a  new index based
  on the indicators.
bibliography: ./bibliography.bib
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(flextable)
library(here)
# devtools::install_github("worldbank/wbgviz", subdir = "wbgdata")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgcharts")
# devtools::install_github("worldbank/wbgviz", subdir = "wbggeo")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgmaps")
library(wbggeo)
library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(httr)
library(patchwork)
library(ggrepel)
library(haven)
library(zoo)

#set directories
dir <- here()

raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")

#weights (either unity (1) or population)
wgt <- 1

```

# Motivation

The primary purpose of the statistical system is to help users of statistics make better decisions or to hold those decision makers accountable. In the words of Principle 1 of the Fundamental Principles of Official Statistics, the statistics must “meet the test of practical utility”, serving “the Government, the economy and the public with data about the economic, demographic, social and environmental situation.” 
The national statistical system, or NSS, plays a crucial role in modern economies. It provides stakeholders, ranging from policy makers to stock market analysts and the general public, with the latest data on the country’s socio-economic developments. At the international level, monitoring progress on global undertakings such as the recently established Sustainable Development Goals (SDGs) requires high-quality data that must be produced consistently across different national statistical systems. Assessing and improving the capacity of a country’s NSS has long been a part of the global agenda. Since the early 2000s, a few capacity assessment tools have been developed to identify the weaknesses and strengths of national statistical systems by other organizations including PARIS21, the Food and Agriculture Organization of the United Nations (FAO), the United Nations Economic Commission for Europe (UNECE), the United Nations Economic Commission for Africa (UNECA), and the U.S. Census Bureau.   

The World Bank’s Statistical Capacity Index (SCI) is one such tool that has been widely employed. Several international and national agencies have adopted the SCI for measuring progress in statistical capacity building and related investments.   The World Bank mainstreamed the SCI in its monitoring and assessment framework and has adopted it as a baseline indicator in various projects at the country level. The SCI is based on publicly available data, and this has various advantages over other indexes of statistical capacity. A key advantage of the SCI is that it can provide assessment of a country’s statistical capacity in an internationally comparable and cost-effective manner. We provide in Table 1 more detailed comparison between the SCI and the statistical capacity measurement indexes of other organizations. Table 1 shows that the SCI is the only tool that provides comparable data across different countries over time. Further, the SCI covers the largest number of countries—146 countries starting from 2004 and has by far the widest coverage of country-level indicators.

Yet, there are several areas in which the existing SCI can be improved. First, it comprises of a limited number of indicators and includes no indicators of some important data sources, such as labor force surveys, establishment surveys, or administrative data. Second, it ignores the data dissemination practices of an NSS, which is one of the key features of data usage. Third, the SCI has been criticized for placing too much weight on statistical output and activities, while neglecting the infrastructure and resource components of statistical systems.  Finally, it is silent on whether the data products produced by the NSS are in high demand. 
Since its launch in 2004, the SCI’s methodology and coverage have basically remained the same, while the global data landscape has changed significantly. NSSs have made significant advancements with data collection and dissemination practices. At the same time, the adoption of the Sustainable Development Goals (SDGs) set an ambitious development agenda for the next 15 years on ending poverty, protecting the planet, and ensuring prosperity for all by 2030. This, in turn, increased the demand for data and raised the bar for national statistical systems regarding their capacity to produce high-quality data. We thus propose to improve the current SCI to better suit the changing global data landscape.

# Overview of the New SPI

The new Statistical Performance Indicators (SPI) builds on the SCI, which the World Bank has regularly published since 2004.  Our new SPI will cover many of the same elements as the SCI, such as statistical methodology, source data, and periodicity, but will also expand into new areas. The goals are to offer a framework that was forward looking, measured less mature statistical systems as well as advanced systems, covered the entire national statistical system, not just the National Statistical Office (NSO), and gives countries incentives to build a modern statistical system.  We also are committing to making our project open data and open code to build confidence in our work.

The new Statistical Performance Indicators (SPI) are designed to monitor how well countries statistical systems are meeting this purpose.  By helping countries and development partners identify the strengths and weaknesses of national statistical systems the SPI can support policy advice for countries about their national statistical systems, investment decisions for donors including the World Bank, benchmarking of national statistical systems, and advocacy for national statistics.  

We identify five key drivers of a country’s statistical performance.  These are data use, data services, data products, data sources, and data infrastructure.

Statistics have no value unless they are used. The first dimension of the Dashboard is therefore data use. A successful statistical system is one that produces data products that are highly used. 

In order to meet those needs, the statistical system needs to develop a range of services that connect users and suppliers and facilitate dialogue between them. The second dimension of the SPI is therefore data services that are trusted by users. A successful statistical system is one with highly valued and well used statistical services.

The dialogue between users and suppliers in turn drives the design of statistical products that are to be created including the quality of product needed for the country requirement. This will incorporate accuracy, timeliness, frequency, comparability and levels of disaggregation. The third dimension of the SPI is therefore data products. A successful statistical system is one that generates high quality statistical indicators that can track progress for the Sustainable Development Goals (SDGs).

In order to create the products required, the statistical system needs to make use of a variety of sources from both inside and outside the government. This will include making use of typical data collection methods like censuses and surveys, but also administrative data, geospatial data, and data generated from the private sector and from citizens.  The fourth dimension of the Dashboard is therefore data sources.  A successful statistical system is one which draws on all types of data sources relevant to the indicators that are to be produced.

For the cycle to be complete, capability needs continuously to be reviewed to ensure that it is enough to deliver the products, services and ultimately data use required. The fifth dimension of the SPI is therefore data infrastructure. A successful statistical system is one that develops both hard infrastructure (legislation, governance, standards) and soft infrastructure (skills, partnerships) and has the financial resources to deliver.
The 5 dimensions and associated 22 components of the SPI are as shown in Figure 1 below.

*Figure 1: The Dimensions and Components that Construct the New SPI*
![unchanged image](SPI_dashboard.png)

Key characteristics of the SPI are: (i) uses only publicly accessible data; (ii) transparent methodology; (iii) easily replicable; (iv) provides a long-time series to track progress in performance; (v) captures outcomes and supporting elements; (vi) reflects the SDGs; (vii) facilitates at-a-glance comparisons on a global scale.
We are collecting data on indicators for the 22 components above. For dissemination, the SPI will be presented both in the dashboard format above and as an index for each country. Some further details on the construction of the new SPI are provided in the Annex. These indicators should be interpreted as a work-in-progress and are being continuously improved by the team. 
The upcoming World Development Report will focus on Data for Better Lives, and it will examine the tremendous potential of the changing data landscape to improve the lives of poor people and consider the backdoors that can harm people. The aim is to help bring this activity to a conclusion in time for the World Bank World Development Report that is due for publication in February 2021. Subsequent dissemination activities and spin-off products (e.g., toolkits, blogs) will run into April 2021.








```{r data, include=FALSE}

#add in population
pop_df <- wbstats::wb(country="all",
             indicator='SP.POP.TOTL',
             startdate=2004,
             enddate=2019) %>%
  mutate(date=as.numeric(date)) %>%
  mutate(population=value) %>%
  select(country, date, population) 


#read in the SPI dataset
spi_df_final <- read_csv( file = paste(output_dir, 'SPI_data.csv', sep="/")) %>%
  left_join(pop_df) %>%
  mutate(weights=wgt)  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.



metadata <- read_csv(paste(raw_dir, '/metadata/SPI_dimensions_sources.csv', sep=""))

```



```{r programs, include=FALSE}


#Now map the result
quality = "high"
maps <- wbgmaps::wbgmaps[[quality]]

country_metadata <- wbstats::wbcountries()




spi_mapper  <- function(data, indicator, title) {
  
 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))     

  
  
   p1 <- ggplot() +
    geom_map(data = map_df, aes(map_id = iso3c, fill = 100*data_available), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
     geom_path(data = maps$boundaries,
               aes(long, lat, group = group),
               color = "white",
               size = 0.1,
               lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
  scale_fill_distiller(palette = "RdYlGn",
                       direction=1,
                       limits = c(0,100))  +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap(title,100),
      subtitle= 'Data Point is for last year available (usually 2019)',
      caption = 'Source: SPI Indicator.',
      fill='SPI Indicator Value'
    )
  
  #add histogram by region 
  p2 <- map_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=100*wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Region', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (usually 2019)'
      ) +
      expand_limits(x=c(0,100)) +
      theme_bw()

  #by income
    p3 <- map_df %>%
    group_by(income) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=100*wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=income, fill=income)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (usually 2019)'
      ) +
      expand_limits(x=c(0,100)) +
      theme_bw()
    
  # #add line graph over time
  p4 <- get(data)  %>%
    rename(data_available=!! indicator) %>%
    # right_join(spi_df_empty) %>%
    group_by(income, date) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available))) %>%
    mutate(Percentage=100*wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ungroup() %>%
    ggplot(aes(y=Percentage, x=date, color=income)) +
      geom_point() +
      geom_line() +
      # geom_text_repel(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Date', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data'
      ) +
      expand_limits(y=c(0,100)) +
      theme_bw()
      
  print(p1)
  
  print(p2)
  
  print(p3)

  print(p4)
    
}



spi_income_table <- function(data, indicator, reference_year) {

  indicator<-indicator
  
  
  
  df_overall <- get(data) %>%
    filter(date==as.numeric(reference_year)) %>% 
    select(country, iso3c, date, income, region, starts_with(indicator))

    #produce by income
        sumstats<- df_overall %>%
            group_by(income) %>%
            filter(!is.na(income)) %>%
            select(income, starts_with(indicator)) %>%
            summarise_all(~round(100*mean(., na.rm=T),1)) 
        
        #produce global number
        sumstats_gl<- df_overall %>%
            mutate(income='Global') %>%
            group_by(income) %>%
            select(income, starts_with(indicator)) %>%
            summarise_all(~round(100*mean(., na.rm=T),1)) 
        
        
        #transpose data
        sumstats_df_long <-sumstats_gl %>%
            bind_rows(sumstats) 
        
        sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-income)))
        colnames(sumstats_df) = sumstats_df_long$income 
        
        
        sumstats_df <- sumstats_df %>%
            rownames_to_column() %>%
            rename(series=rowname)
        
        
        #create labels df
        metadata_tab2_overall <- metadata %>% 
            janitor::clean_names() %>%
            transmute(series=source_id, 
                      indicator_name=source_name)
        
        
        #add variable label
        sumstats_df <- sumstats_df %>%
            left_join(metadata_tab2_overall) %>%
            rename(Series=series,
                   Label=indicator_name) %>%
            mutate(Label=if_else(is.na(Label),Series,Label)) %>%
            select(Label, c("Global","Low income", "Lower middle income", "Upper middle income","High income"))

        sumstats_df
 

  }

#define function to pull data from UN Stats and return
un_pull <- function(series,start, end) {
  # jsonlite::fromJSON(paste('https://unstats.un.org/SDGAPI/v1/sdg/Series/Data?seriesCode=',series,'&timePeriodStart=',start,'&timePeriodEnd=',end,'&pageSize=10000',sep=""), flatten = TRUE)$data %>%
      jsonlite::fromJSON(paste('https://unstats.un.org/SDGAPI/v1/sdg/Series/Data?seriesCode=',series,'&pageSize=10000',sep=""), flatten = TRUE)$data %>%

    as_tibble() %>%
    mutate(date=timePeriodStart) %>%
    right_join(iso3c)
    
}  

FitFlextableToPage <- function(ft, pgwidth = 6){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

```

# Index Description

For research purposes, we create an index combining several indicators together to get an overview of country performance.

A quick primer on names. We refer to the 5 rows in the framework in Figure 1 as dimensions. We refer to the 22 cells in the framwork in Figure 1 as sub-dimensions. Finally, each sub-dimension may be composed of multiple indicators. For instance, the sub-dimension on censuses and surveys is made up indicators on whether population censuses have been conducted, agriculture censuses, labor force surveys, etc.

Below is the full set of indicators available to populate the index. along with the corresponding sub-dimension:


```{r metadata_tab, eval=FALSE, include=FALSE}
####
# create table
####

metatable <- metadata %>%
  filter(grepl('SPI.D',source_id)) %>%
  select(-spi_indicator_name)

DT::datatable(metatable, colnames = c(
                       "ID",
                       "Indicator Name",
                       "Sub-Dimension",
                       "Brief Description"
                                   ),
              caption=htmltools::tags$caption(
            style = 'caption-side: top; text-align: left;',
            htmltools::em("SPI Sub-Indicator Metadata."))    ,
            extensions = 'Buttons', options=list(
                dom = 'Bfrtip',
                buttons = c('copy', 'csv', 'excel' ),
                pageLength = 218)) 
```



```{r metadata_tab2}
####
# create table
####

metatable <- metadata %>%
  filter(grepl('SPI.D',source_id)) %>%
  select(-spi_indicator_name)



index_tab <- flextable(metatable) %>%
  add_header_lines('SPI Sub-Indicator Metadata.') %>%
  set_header_labels(values=list(
                       source_id="ID",
                       source_name="Indicator Name",
                       SPI_indicator_id="Sub-Dimension",
                       spi_indicator_description="Brief Description"
                                   ))
  FitFlextableToPage(index_tab)


```

## Methodology

The Index will contain only a subset of the sub-dimensions from our framework.  For sub-dimensions excluded, we either lacked a source with a developed methodology or else the data collection for that measure was incomplete. This is described below:

  * **Sub-Dimension 1.1: Data use by national legislature:**  *Not included because of lack of established methodology*   
  * **Sub-Dimension 1.2: Data use by national executive branch:** *Not included because of lack of established methodology*      
  * **Sub-Dimension 1.3: Data use by civil society:**  *Not included because of lack of established methodology*    
  * **Sub-Dimension 1.4: Data use by academia:**  *Not included because of lack of established methodology*   
  * **Sub-Dimension 1.5: Data use by international organizations:**  *Reliability/Usefulness of Poverty, Child Mortality, Debt Statistics for international agencies using metadata*    

  
  * **Sub-Dimension 2.1: Data Releases:** *SPI.D2.1.GDDS -	SDDS/e-GDDS subscription*    
  * **Sub-Dimension 2.2: Online access:** *SPI.D2.2.Openness.subscore	ODIN Open Data Openness score*   
  * **Sub-Dimension 2.3: Advisory/ Analytical Services:**  *Not included because of lack of established methodology*    
  * **Sub-Dimension 2.4: Data services:** *SPI.D2.4.NADA	NADA metadata*
  
  * **Sub-Dimension 3.1: Social Statistics:** *Average score for Goal 1-6 indicators*
  * **Sub-Dimension 3.2: Economic Statistics:** *Average score for Goal 7-12 indicators*  
  * **Sub-Dimension 3.3: Environmental Statistics:**  *Average score for Goal 13-15 indicators*      
  * **Sub-Dimension 3.4: Institutional Statistics:** *Average score for Goal 16-17 indicators*    

  * **Sub-Dimension 4.1: Censuses and Surveys:** *Average score Census and Survey Indicators indicators SPI.D4.1....*
  * **Sub-Dimension 4.2: Administrative Data:** *Average score for CRVS indicator and Education (UNESCO) admin data indicator.  Social Protection and Labor admin data indicators not included because of lack of established methodolgy*  
  * **Sub-Dimension 4.3: Geospatial Data:**  *SPI.D4.3.GEO.first.admin.level -	Geospatial data available at 1st Admin Level* 
  * **Sub-Dimension 4.4: Private/citizen generated data:**  *Not included because of lack of established methodology*   
  
  * **Sub-Dimension 5.1: legislation and governance:**  *Not included because of insufficient country coverage*  
  * **Sub-Dimension 5.2: Standards and Methods:** *Average score for Standards and Methods indicators SPI.D5.2....*  
  * **Sub-Dimension 5.3: skills:**  *Not included because of lack of established methodology*    
  * **Sub-Dimension 5.4: partnerships:**  *Not included because of lack of established methodology*    
  * **Sub-Dimension 5.5: finance:**  *Not included because of insufficient country coverage* 
  

This process of eliminating some Sub-Dimension due to lack of established methodology or country coverage results in 12 Sub-Dimension This includes 1 on data use, 3 on data services, 4 on data products, 3 on data sources, and 1 on data infrastructure.

### Overall Score

Our statistical performance indicators have a three level structure, and our overall score will be formed by sequentially aggregating each level.

To begin we produce a score for each sub-dimension, which is an unweighted average of the indicators within that indicator.  For instance, the Census and Surveys sub-dimension will be formed by taking the unweighted average of the Population Census score, the Agriculture Census score, the Business Census score, the Labor Force Survey score, the Health Survey score, etc.  

$$ SPI.SUB.DIM{ctds} = \sum_{i=1}^{N_I} \frac{SPI.IND_{ctdsi}}{N_I} $$

where $SPI.SUB.DIM{ctds}$ is sub-dimension s, in dimension d, in time period t, and country c.  $SPI.IND_{ctdsi}$ is an indicator (e.g. population census score).

After computing a score for the sub-dimensions, we then compute a dimension score, which is the unweighted average of the sub-dimensions in that dimension.

$$ SPI.DIM_{ctd} = \sum_{s=1}^{N_S} \frac{SPI.SUB.DIM{ctds}}{N_S} $$


After calculating the scores for each dimension The SPI index is the average across the 5 dimensions. 

The SPI index is scaled to have a maximum score of 100 and a minimum of 0. A score of 100 would indicate that a country has every single element that we measure in place. A score of 0 indicates that none are in place. To be precise:



$$ SPI.INDEX_{ct} = \sum_{d=1}^{N_D} \frac{SPI.DIM_{ctd}}{N_D} $$

Where SPI.INDEX is the SPI overall index. SPI.DIM are the 5 SPI dimensions listed above. In the notation, c is a country, t is the date, d is a dimension.  

The nested structure of our index and the summation methods used to build an overall score ensure the axiomatic properties outlined in [@cameron2019measuring].  These include symmetry, monotonicity, and subgroup decomposability.

## Handling Missing Data 

For a full description of the methodology behind each specific sub-indicator, please consult the technical documentation.  However, we did follow an approach of handling missing values and lining up data, which I will describe in general terms below.  For indicators where we had a value for a previous year (say a value in 2018 but not 2019), we would fill in from the previous value.  For instance, the open data watch indicators on geo-spatial data was only released in 2018, not 2019, so we filled in the value for 2019 with the value from 2018 as our best estimate of that indicator.

For indicators where we had no data for any years, we chose not to impute a value.  In that case, the value for that indicator is null and the country will not have a value for any sub-dimensions or dimensions where that value is used.


# Analysis


```{r spi_df}

# This block of code will create a blank SPI dataset (only containing country info) that will be appended to when each indicator is added.
# There will be two indicators added for each dimension
# 1. An indicator with a score between 0-1 for each dimension
# 2. An indicator with the raw (unscored) values of the indicators
# The unit for this database will be country*year

span <- c(2004:2019)

spi_df_empty <- bind_rows(replicate(length(span), wbstats::wbcountries(), simplify = FALSE), .id='date') %>%
  mutate(date=as.numeric(date)+span[1]-1) %>%
  filter(region!="Aggregates") # take out the aggregates (LAC, SAR, etc)

spi_df <- spi_df_empty

#read list of iso3c codes for matching from UN (https://unstats.un.org/unsd/methodology/m49/)
iso3c <- read_csv(paste(raw_dir,'metadata/iso_codes.csv', sep="/"),
                  col_types=list(col_character(), col_character(), col_character()))

```
  

```{r index}
#get a list of oecd countries
oecd_country_query <-  GET(url = "https://api.worldbank.org/v2/country?region=OED&format=json") %>%
  content( as = "text", encoding = "UTF-8") %>%
  jsonlite::fromJSON( flatten = TRUE) 

#do some conversion to produce a dataframe
oecd_country_df <- oecd_country_query[[2]] %>%
  as_tibble() 
  
country_mod_list <- oecd_country_df$name  #fill in the missing values for OECDs with 1s because by participating in OECD these countries have this
country_mod_list <- c(country_mod_list, 'Singapore')
# create index dataset
spi_index_df_temp <- spi_df_final %>%
  select(country, iso3c, date, starts_with("SPI"), income, region, weights, population) %>%
  arrange(-date,country)

#Drop certain indicators that don't make cut because of imcomplete coverage usually
spi_index_df_temp <- spi_index_df_temp %>%
  select( -SPI.D5.3.DISK, -SPI.D4.3.GEO.second.admin.level,, -SPI.D4.2.1.SPL, -SPI.D4.2.4.LBR) 





#first index 
# just take a simple numeric average acorss all indicators
# I will forward fill all indicators if they are missing
spi_index_simple <- spi_index_df_temp %>%
  arrange(country, date) %>%
  group_by(country) %>%
  select(-starts_with("SPI.D1")) %>%
  mutate(across(starts_with("SPI"), na.locf, na.rm=FALSE)) %>%
  mutate(across(c("SPI.D2.1.GDDS","SPI.D2.4.NADA","SPI.D4.1.1.POPU","SPI.D4.1.2.AGRI","SPI.D4.1.3.BIZZ","SPI.D4.1.4.HOUS","SPI.D4.1.5.AGSVY",
                  "SPI.D4.1.6.LABR","SPI.D4.1.7.HLTH","SPI.D4.1.8.BZSVY",
                  "SPI.D5.2.1.SNAU", "SPI.D5.2.2.NABY", "SPI.D5.2.1.SNAU","SPI.D5.2.2.NABY",                
                  "SPI.D5.2.3.CNIN", "SPI.D5.2.4.CPIBY", "SPI.D5.2.5.HOUS", "SPI.D5.2.6.EMPL","SPI.D5.2.7.CGOV", "SPI.D5.2.8.FINA",
                  "SPI.D5.2.9.MONY", "SPI.D5.2.10.GSBP" ),
                ~if_else(( (income=='High income') & (country %in% country_mod_list)),1,.)                )) %>% 
  mutate(SPI.INDEX=rowMeans(across(starts_with("SPI")), na.rm=FALSE),
         SPI.INDEX.DIM2=rowMeans(across(starts_with("SPI.D2")), na.rm=FALSE),
         SPI.INDEX.DIM3=rowMeans(across(starts_with("SPI.D3")), na.rm=FALSE),
         SPI.INDEX.DIM4=rowMeans(across(starts_with("SPI.D4")), na.rm=FALSE),
         SPI.INDEX.DIM5=rowMeans(across(starts_with("SPI.D5")), na.rm=FALSE)
         ) %>% #
  arrange(-date, -SPI.INDEX) %>%
  select(country, iso3c, date, starts_with('SPI.INDEX'), everything())


#################
# Nested Index
################
  spi_index_df <- spi_index_df_temp %>%
  arrange(country, date) %>%
  group_by(country) %>%
  mutate(across(starts_with("SPI"), na.locf, na.rm=FALSE)) %>%
  mutate(across(c("SPI.D1.5.POV",
                  "SPI.D2.1.GDDS","SPI.D2.4.NADA","SPI.D4.1.1.POPU","SPI.D4.1.2.AGRI","SPI.D4.1.3.BIZZ","SPI.D4.1.4.HOUS","SPI.D4.1.5.AGSVY",
                  "SPI.D4.1.6.LABR","SPI.D4.1.7.HLTH","SPI.D4.1.8.BZSVY",
                  "SPI.D5.2.1.SNAU", "SPI.D5.2.2.NABY", "SPI.D5.2.1.SNAU","SPI.D5.2.2.NABY",                
                  "SPI.D5.2.3.CNIN", "SPI.D5.2.4.CPIBY", "SPI.D5.2.5.HOUS", "SPI.D5.2.6.EMPL","SPI.D5.2.7.CGOV", "SPI.D5.2.8.FINA",
                  "SPI.D5.2.9.MONY", "SPI.D5.2.10.GSBP" ),
                ~if_else(( (income=='High income') & (country %in% country_mod_list)),1,.)                )) %>% 
  select(country, iso3c, date, everything())



#Create overall subscores corresponding to John's framework
  spi_index_df <- spi_index_df %>%
    mutate(INDEX.SPI.D2.1=rowMeans(across(starts_with('SPI.D2.1'))),
         INDEX.SPI.D2.2=SPI.D2.2.Openness.subscore,
         INDEX.SPI.D2.4=SPI.D2.4.NADA,
         INDEX.SPI.D3.1=rowMeans(across(c("SPI.D3.1.POV",
                                            "SPI.D3.2.HNGR",
                                            "SPI.D3.3.HLTH",
                                            "SPI.D3.4.EDUC",
                                            "SPI.D3.5.GEND",
                                            "SPI.D3.6.WTRS"))),
         INDEX.SPI.D3.2=rowMeans(across(c("SPI.D3.7.ENRG",
                                            "SPI.D3.8.WORK",
                                            "SPI.D3.9.INDY",
                                            "SPI.D3.10.NEQL",
                                            "SPI.D3.11.CITY",
                                            "SPI.D3.12.CNSP"))),         
         INDEX.SPI.D3.3=rowMeans(across(c("SPI.D3.13.CLMT",
                                            "SPI.D3.15.LAND" ))),
         INDEX.SPI.D3.4=rowMeans(across(c("SPI.D3.16.INST",
                                            "SPI.D3.17.PTNS" ))),
         INDEX.SPI.D4.1=rowMeans(across(starts_with('SPI.D4.1'))),
         INDEX.SPI.D4.2=rowMeans(across(starts_with('SPI.D4.2'))),
         INDEX.SPI.D4.3=rowMeans(across(starts_with('SPI.D4.3'))),
         #INDEX.SPI.D5.1=rowMeans(across(starts_with('SPI.D5.1'))),
         INDEX.SPI.D5.2=rowMeans(across(starts_with('SPI.D5.2'))),
         #INDEX.SPI.D5.5=rowMeans(across(starts_with('SPI.D5.5')))
                 ) %>%
  mutate(
         SPI.INDEX.DIM1=rowMeans(across(starts_with("SPI.D1.5")), na.rm=FALSE),
         SPI.INDEX.DIM2=rowMeans(across(starts_with("INDEX.SPI.D2")), na.rm=FALSE),
         SPI.INDEX.DIM3=rowMeans(across(starts_with("INDEX.SPI.D3")), na.rm=FALSE),
         SPI.INDEX.DIM4=rowMeans(across(starts_with("INDEX.SPI.D4")), na.rm=FALSE),
         SPI.INDEX.DIM5=rowMeans(across(starts_with("INDEX.SPI.D5")), na.rm=FALSE),
         SPI.INDEX=rowMeans(across(c('SPI.INDEX.DIM1',
                                     'SPI.INDEX.DIM2',
                                     'SPI.INDEX.DIM3',
                                     'SPI.INDEX.DIM4',
                                     'SPI.INDEX.DIM5')), na.rm=FALSE)
         ) %>% #
  arrange(-date, -SPI.INDEX) %>%
  select(country, iso3c, date, starts_with('SPI.INDEX'), everything()) %>%
    filter(date>=2016) #2016 is first year with complete data 

  
#display top 25
index_disp <- spi_index_df %>%
  ungroup() %>%
  filter(date==2019) %>%
  arrange(-SPI.INDEX) %>%
  mutate(across(starts_with('SPI.INDEX'),~100*.),
         across(starts_with('SPI.INDEX'),round,1)) %>%
  select(country, iso3c, date, starts_with('SPI.INDEX'))


spi_index_df %>%
  write_excel_csv(path=paste(output_dir, 'SPI_index.csv', sep="/"))





```


```{r text_computations}

#number of countries with data for SPI index
n_countries <- spi_index_df %>%
  filter(!is.na(SPI.INDEX) & date==2019) %>% #countries with value for SPI in 2019
  nrow()

# percentage of world population covered
pop_covered <- spi_index_df %>%
  filter(date==2019) %>%
  mutate(covered=!is.na(SPI.INDEX)) %>%
  mutate(covered_pop=if_else(covered==TRUE, population, 0)) %>%
  ungroup() %>%
  summarise(pop_covered=sum(covered_pop, na.rm=T)/sum(population, na.rm=T))


```


Below we show a set of summary measures for our SPI index.  We begin by presenting a world map containing the SPI index values for 2019 for each country.  In total, we have `r n_countries` countries with sufficient data to compute an index value.  This set of countries covers `r 100*round(pop_covered$pop_covered,3)` percent of the world population.


```{r sumstats}
#show map and summary stats by region and income group

spi_mapper('spi_index_df','SPI.INDEX','Overall SPI  Index Averaging Over All Sub-Dimensions.  Equal Weight for Each Sub-Dimension.')

```




# Comparison to the Statistical Capacity Indicators



```{r comparison, include=FALSE}

#pull SCI values

Request_metadata <- GET(url = "http://api.worldbank.org/v2/country/all/indicator/IQ.SCI.OVRL?format=json&date=2004:2019&per_page=5000")
Response_metadata <- content(Request_metadata, as = "text", encoding = "UTF-8")

# Parse the JSON content and convert it to a data frame.
sci_df <- jsonlite::fromJSON(Response_metadata, flatten = TRUE) %>%
  data.frame() %>%
  transmute(
    iso3c=countryiso3code,
    country=country.value,
    date=as.numeric(date),
    SCI=value
  ) %>%
  left_join(spi_df_empty) %>% #add on country metadata
  filter(!is.na(income)) %>%
  select(iso3c, country, date, SCI  ) %>%
  group_by(date) %>%
  arrange(-SCI) %>%
  mutate(SCI_rank=rank(-SCI),
         SCI_rank=if_else(is.na(SCI),as.numeric(NA),SCI_rank))

#read in ODIN data
  for (i in 2015:2018) {
   temp <- read_csv(paste(raw_dir, '/2.2_DSOA/','ODIN_',i,'.csv', sep=""))  %>%
        as_tibble(.name_repair = 'universal') %>%
        mutate(date=i) %>%
        filter(Data.categories=='All Categories')


    assign(paste('odin_df',i,sep="_"), temp)
  }

    #bind different years together
odin_df <- bind_rows(odin_df_2015, odin_df_2016, odin_df_2017, odin_df_2018)


odin_df <- odin_df %>%
    select(Country.Code, date, Overall.score) %>%
    rename(iso3c=Country.Code,
           ODIN_score=Overall.score) %>%
    group_by(date) %>%
    arrange(-ODIN_score) %>%
    mutate(ODIN_rank=rank(-ODIN_score, na.last='NA')) %>% 
  right_join(spi_df_empty) %>%
  arrange(country, date) %>%
  group_by(country) %>%
  mutate(across(starts_with("ODIN"), na.locf, na.rm=FALSE)) %>%
  select(country, date, starts_with("ODIN"))


#read in the old SPI
SPI_v0_df <- readxl::read_excel(path='C:/Users/wb469649/OneDrive - WBG/DECIS/SPI_AKI/Data/FinalCopy of SPI SCORE 2016-2018-DW.xlsx', skip=2) %>%
  transmute(
    iso3c=Country,
    SPI_2016=as.numeric(Overall...7),
    SPI_2017=as.numeric(Overall...12),
    SPI_2018=as.numeric(Overall...17)
  ) %>%
  pivot_longer(
    cols=c('SPI_2016','SPI_2017','SPI_2018'),
    names_to="date",
    values_to = 'SPI_v0'
  ) %>%
  mutate(date=gsub('SPI_','',date),
         date=as.numeric(date))


#create one database
comparison_df <- spi_index_df %>%
  ungroup() %>%
  filter(date %in% c(2016:2019)) %>%
  arrange(-SPI.INDEX) %>%
  mutate(across(starts_with('SPI.INDEX'),~100*.),
         across(starts_with('SPI.INDEX'),round,1)) %>%
  select(country, iso3c, date, income, region, SPI.INDEX) %>%
  left_join(sci_df) %>%
  left_join(odin_df) %>%
  left_join(SPI_v0_df)




```

We compare the SPI index to the older World Bank Statistical Capacity Indicators (http://datatopics.worldbank.org/statisticalcapacity/SCIdashboard.aspx).  The correlation between the SPI index and the SCI  is `r round(cor(comparison_df$SPI.INDEX,comparison_df$SCI, use='pairwise.complete.obs'),3)`

```{r sci}

### Scatterplot SCI SPI
spi_sci_plot <- ggplot(comparison_df, aes(x=SPI.INDEX,y=SCI, color=region)) +
  facet_wrap(~date) +
  # geom_point() +
  geom_text(aes(label=iso3c)) +
  theme_bw() +
  labs(
    title='Scatterplot of Statistical Capacity Index on SPI Index'
  )

spi_sci_plot


```


# ODIN ranking comparison

We compare the SPI index to the Open Data Watch rankings of country statistical systems (https://odin.opendatawatch.com/report/rankings).  The correlation between the SPI index and the ODIN index is `r round(cor(comparison_df$SPI.INDEX,comparison_df$ODIN_score, use='pairwise.complete.obs'),3)`
 


```{r odin, echo=FALSE}

 

### Scatterplot ODIN SPI
spi_odin_plot <- ggplot(comparison_df, aes(x=SPI.INDEX,y=ODIN_score, color=region)) +
  # geom_point() +
  facet_wrap(~date) +
  geom_text(aes(label=iso3c)) +
  theme_bw() +
  labs(
    title='Scatterplot of Open Data Watch Index on SPI Index'
  )

spi_odin_plot




```



# Comparison to Version 0 of the SPI

As a final comparison, we compare our new SPI index to an index developed by [@cameron2019measuring], which can be thought of as a version 0 of our SPI index.  The authors use similar data sources for their index.  However, there are some differences.


First, the similarities.  The methodology for constructing the index is the same.  Also, the censuses and surveys (Indicator 4.1) and standards and methods (Indicator 5.2) are identical.  The indicator for data releases (Indicator 2.1) and data services (Indicator 2.4) are pulled from the information collected in the fourth dimension on dissemination practices from version 0 of the SPI in Cameron et al. (2019).  Finally, both indicators include an indicator for Complete Vital Registration Statistics (CRVS).  The CRVS indicator is in the administrative data section of the new SPI index, while it was in the standards, methods, and classifications section of the SPI version 0.

For the differences, SPI version 0 had four dimensions, namely: (i) Methodology, Standards and Classifications (MSC), which provides information on the technology being used by the NSS; (ii) Census and Surveys (CS), which describes the intermediate products of the NSS; (iii) Availability of Key Indicators (AKI), which focuses on key final products needed for policy; and (iv) Dissemination Practices and Openness (DPO), which evaluates the extent to which products are publicly disseminated. 

The indicator on AKI, from version 0, is conceptually similar to our Data Products dimension in the new SPI, but uses different sources of data and the DPO section is similar to our data services section, but draw on some different sources in some cases.

We compare the SPI index to the SPI version 0.  The correlation between the SPI index and the version 0 index is `r round(cor(comparison_df$SPI.INDEX,comparison_df$SPI_v0, use='pairwise.complete.obs'),3)`



```{r spi_v0, echo=FALSE}


### Scatterplot SPI SPI_v0
spi_spi_plot <- ggplot(comparison_df, aes(x=SPI.INDEX,y=SPI_v0, color=region)) +
  facet_wrap(~date) +
  # geom_point() +
  geom_text(aes(label=iso3c)) +
  theme_bw() +
  labs(
    title='Scatterplot of SPI Version 0 Index on new SPI Index'
  )

spi_spi_plot






```




# Country SPI Index values

Full list of countries by their SPI Index Score in 2019

```{r tab1, echo=FALSE}

index_tab <- index_disp %>%
  select(country, iso3c, date, starts_with('SPI.INDEX')) %>%
  flextable() %>%
  add_header_lines('Overall SPI  Index Averaging Over All Sub-Dimensions.') %>%
  set_header_labels(values=list(
                       country="Country", 
                       iso3c="ISO3C", 
                       date="Date", 
                       SPI.INDEX="SPI Index Value",
                       SPI.INDEX.DIM1="Dimension 1: Data Use",
                       SPI.INDEX.DIM2="Dimension 2: Data Services",
                       SPI.INDEX.DIM3="Dimension 3: Data Products ",
                       SPI.INDEX.DIM4="Dimension 4: Data Sources",
                       SPI.INDEX.DIM5="Dimension 5: Data Infrastructure"
                                   ))
  

FitFlextableToPage(index_tab)

```

# References


---
title: 'Measuring the Statistical Performance of Countries: An Overview of the Statistical Performance Indicators and Index'
author: "SPI Team"
date: "`r Sys.Date()`"
output:
  word_document: 
    toc: yes
    fig_width: 9
    fig_height: 6
  html_document:
    theme: sandstone
    fig_width: 9
    fig_height: 7
abstract: Recognizing the new challenges for national statistical systems in monitoring  the
  Sustainable Development Goals (SDGs), the World Bank is developing a new, improved  Statistical  Performance
  Indicators (SPI) to monitor progress of the statistical  performance  of countries.
  This will replace the Statistical Capacity Index (SCI)  the World  Bank has regularly
  published since 2004. This short note briefly discusses  the  motivation behind
  the new SPI, describes some of its major features, and discusses  a  new index based
  on the indicators.
bibliography: ./bibliography.bib
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(flextable)
library(here)
# devtools::install_github("worldbank/wbgviz", subdir = "wbgdata")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgcharts")
# devtools::install_github("worldbank/wbgviz", subdir = "wbggeo")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgmaps")
library(wbggeo)
library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(httr)
library(patchwork)
library(ggrepel)
library(haven)
library(zoo)
library(estimatr)
library(ggpmisc)
library(ggthemes)
#set directories
dir <- here()

raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")

#weights (either unity (1) or population)
wgt <- 1

```

# Motivation

The primary purpose of the statistical system is to help users of statistics make better decisions or to hold those decision makers accountable. In the words of Principle 1 of the Fundamental Principles of Official Statistics, the statistics must “meet the test of practical utility”, serving “the Government, the economy and the public with data about the economic, demographic, social and environmental situation.” 
The national statistical system, or NSS, plays a crucial role in modern economies. It provides stakeholders, ranging from policy makers to stock market analysts and the general public, with the latest data on the country’s socio-economic developments. At the international level, monitoring progress on global undertakings such as the recently established Sustainable Development Goals (SDGs) requires high-quality data that must be produced consistently across different national statistical systems. Assessing and improving the capacity of a country’s NSS has long been a part of the global agenda. Since the early 2000s, a few capacity assessment tools have been developed to identify the weaknesses and strengths of national statistical systems by other organizations including PARIS21, the Food and Agriculture Organization of the United Nations (FAO), the United Nations Economic Commission for Europe (UNECE), the United Nations Economic Commission for Africa (UNECA), and the U.S. Census Bureau.   

The World Bank’s Statistical Capacity Index (SCI) is one such tool that has been widely employed. Several international and national agencies have adopted the SCI for measuring progress in statistical capacity building and related investments.   The World Bank mainstreamed the SCI in its monitoring and assessment framework and has adopted it as a baseline indicator in various projects at the country level. The SCI is based on publicly available data, and this has various advantages over other indexes of statistical capacity. A key advantage of the SCI is that it can provide assessment of a country’s statistical capacity in an internationally comparable and cost-effective manner. We provide in Table 1 more detailed comparison between the SCI and the statistical capacity measurement indexes of other organizations. Table 1 shows that the SCI is the only tool that provides comparable data across different countries over time. Further, the SCI covers the largest number of countries—146 countries starting from 2004 and has by far the widest coverage of country-level indicators.

Yet, there are several areas in which the existing SCI can be improved. First, it comprises of a limited number of indicators and includes no indicators of some important data sources, such as labor force surveys, establishment surveys, or administrative data. Second, it ignores the data dissemination practices of an NSS, which is one of the key features of data usage. Third, the SCI has been criticized for placing too much weight on statistical output and activities, while neglecting the infrastructure and resource components of statistical systems.  Finally, it is silent on whether the data products produced by the NSS are in high demand. 
Since its launch in 2004, the SCI’s methodology and coverage have basically remained the same, while the global data landscape has changed significantly. NSSs have made significant advancements with data collection and dissemination practices. At the same time, the adoption of the Sustainable Development Goals (SDGs) set an ambitious development agenda for the next 15 years on ending poverty, protecting the planet, and ensuring prosperity for all by 2030. This, in turn, increased the demand for data and raised the bar for national statistical systems regarding their capacity to produce high-quality data. We thus propose to improve the current SCI to better suit the changing global data landscape.

# Overview of the New SPI

The new Statistical Performance Indicators (SPI) builds on the SCI, which the World Bank has regularly published since 2004.  Our new SPI will cover many of the same elements as the SCI, such as statistical methodology, source data, and periodicity, but will also expand into new areas. The goals are to offer a framework that was forward looking, measured less mature statistical systems as well as advanced systems, covered the entire national statistical system, not just the National Statistical Office (NSO), and gives countries incentives to build a modern statistical system.  We also are committing to making our project open data and open code to build confidence in our work.

The new Statistical Performance Indicators (SPI) are designed to monitor how well countries statistical systems are meeting this purpose.  By helping countries and development partners identify the strengths and weaknesses of national statistical systems the SPI can support policy advice for countries about their national statistical systems, investment decisions for donors including the World Bank, benchmarking of national statistical systems, and advocacy for national statistics.  

We identify five key dimensions of a country’s statistical performance. These are data use, data services, data products, data sources, and data infrastructure . These dimensions can be presented in the form of a dashboard that can help countries identify areas for development in their statistical system. Improvements in performance can be represented as a virtuous data cycle that can become self-sustaining.

![](SPI_cycle.png)

Statistics have no value unless they are used. The first dimension of the Dashboard is therefore data use. A successful statistical system is one that produces data products that are highly used. 

In order to meet those needs, the statistical system needs to develop a range of services that connect users and suppliers and facilitate dialogue between them. The second dimension of the SPI is therefore data services that are trusted by users. A successful statistical system is one with highly valued and well used statistical services.

The dialogue between users and suppliers in turn drives the design of statistical products that are to be created including the quality of product needed for the country requirement. This will incorporate accuracy, timeliness, frequency, comparability and levels of disaggregation. The third dimension of the SPI is therefore data products. A successful statistical system is one that generates high quality statistical indicators that can track progress for the Sustainable Development Goals (SDGs).

In order to create the products required, the statistical system needs to make use of a variety of sources from both inside and outside the government. This will include making use of typical data collection methods like censuses and surveys, but also administrative data, geospatial data, and data generated from the private sector and from citizens.  The fourth dimension of the dashboard is therefore data sources.  A successful statistical system is one which draws on all types of data sources relevant to the indicators that are to be produced.

For the cycle to be complete, capability needs continuously to be reviewed to ensure that it is enough to deliver the products, services and ultimately data use required. The fifth dimension of the SPI is therefore data infrastructure. A successful statistical system is one that develops both hard infrastructure (legislation, governance, standards) and soft infrastructure (skills, partnerships) and has the financial resources to deliver.
The 5 dimensions and associated 22 pillars of the SPI are as shown in Figure 1 below.

*Figure 1: The Dimensions and Pillars that Construct the New SPI*
![unchanged image](SPI_dashboard.png)

A score against each element would facilitate:    

  1. Understanding of the maturity of the national statistical system in relation to others eg quintile groups of countries could be shown against each dimension    
  2. This in turn would highlight relative strengths and weaknesses of the system and give an indication of the extent to which the official statistics could be relied upon   
  3. It would also point to which other countries the country in question could learn from as it seeks to improve and create incentives to develop in a forward looking rather than backward looking way   
  4. Time series would allow assessments to be made of progress of the system and a start point for assessments of return on investment for funding given for capacity building    
  5. A dynamic view encouraging continuous improvement. As countries improve the bar for what good looks like would get higher     


Key characteristics of the SPI are: (i) uses only publicly accessible data; (ii) transparent methodology; (iii) easily replicable; (iv) provides a long-time series to track progress in performance; (v) captures outcomes and supporting elements; (vi) reflects the SDGs; (vii) facilitates at-a-glance comparisons on a global scale.
We are collecting data on indicators for the 22 pillars above. For dissemination, the SPI will be presented both in the dashboard format above and as an index for each country. Further details on the construction of the new SPI are provided in the remainder of the document.









```{r data, include=FALSE}

#add in population
pop_df <- wbstats::wb(country="all",
             indicator='SP.POP.TOTL',
             startdate=2004,
             enddate=2019) %>%
  mutate(date=as.numeric(date)) %>%
  mutate(population=value) %>%
  select(country, date, population) 


#read in the SPI dataset
spi_df_final <- read_csv( file = paste(output_dir, 'SPI_data.csv', sep="/")) %>%
  left_join(pop_df) %>%
  mutate(weights=wgt)  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.



metadata <- read_csv(paste(raw_dir, '/metadata/SPI_dimensions_sources.csv', sep=""))

pillars <- read_csv(paste(raw_dir, '/metadata/SPI_pillars.csv', sep=""))

```



```{r programs, include=FALSE}


#Now map the result
quality = "high"
maps <- wbgmaps::wbgmaps[[quality]]

country_metadata <- wbstats::wbcountries()




spi_mapper  <- function(data, indicator, title) {
  
 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))     

  
  
   p1 <- ggplot() +
    geom_map(data = map_df, aes(map_id = iso3c, fill = 100*data_available), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
     geom_path(data = maps$boundaries,
               aes(long, lat, group = group),
               color = "white",
               size = 0.1,
               lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
  scale_fill_distiller(palette = "RdYlGn",
                       direction=1,
                       limits = c(0,100))  +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap(title,100),
      subtitle= 'Data Point is for last year available (2019)',
      caption = 'Source: SPI Indicator.',
      fill='SPI Indicator Value'
    )
  
  #add histogram by region 
  p2 <- map_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=100*wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Region', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top')


  p2_alt <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=100*(data_available),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=region, color=region)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Country', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top')  
  
  #by income
    income <- c("Low income", "Lower middle income","Upper middle income","High income")

    p3 <- map_df %>%
    group_by(income) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=100*wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=income, fill=income)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      scale_y_discrete(limits = income) +
      expand_limits(x=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top')
    
  # #add line graph over time
  p4 <- get(data)  %>%
    rename(data_available=!! indicator) %>%
    # right_join(spi_df_empty) %>%
    group_by(income, date) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available))) %>%
    mutate(Percentage=100*wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ungroup() %>%
    ggplot(aes(y=Percentage, x=date, color=income)) +
      geom_point() +
      geom_line() +
      # geom_text_repel(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Date', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data'
      ) +
      expand_limits(y=c(0,100)) +
      theme_bw() +
      theme(legend.position = 'top')
  

            
      
  print(p1)
  
  print(p2)
  
  print(p2_alt)
  
  print(p3)

  print(p4)
    
}



spi_income_table <- function(data, indicator, reference_year) {

  indicator<-indicator
  
  
  
  df_overall <- get(data) %>%
    filter(date==as.numeric(reference_year)) %>% 
    select(country, iso3c, date, income, region, starts_with(indicator))

    #produce by income
        sumstats<- df_overall %>%
            group_by(income) %>%
            filter(!is.na(income)) %>%
            select(income, starts_with(indicator)) %>%
            summarise_all(~round(100*mean(., na.rm=T),1)) 
        
        #produce global number
        sumstats_gl<- df_overall %>%
            mutate(income='Global') %>%
            group_by(income) %>%
            select(income, starts_with(indicator)) %>%
            summarise_all(~round(100*mean(., na.rm=T),1)) 
        
        
        #transpose data
        sumstats_df_long <-sumstats_gl %>%
            bind_rows(sumstats) 
        
        sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-income)))
        colnames(sumstats_df) = sumstats_df_long$income 
        
        
        sumstats_df <- sumstats_df %>%
            rownames_to_column() %>%
            rename(series=rowname)
        
        
        #create labels df
        metadata_tab2_overall <- metadata %>% 
            janitor::clean_names() %>%
            transmute(series=source_id, 
                      indicator_name=source_name)
        
        
        #add variable label
        sumstats_df <- sumstats_df %>%
            left_join(metadata_tab2_overall) %>%
            rename(Series=series,
                   Label=indicator_name) %>%
            mutate(Label=if_else(is.na(Label),Series,Label)) %>%
            select(Label, c("Global","Low income", "Lower middle income", "Upper middle income","High income"))

        sumstats_df
 

  }

#define function to pull data from UN Stats and return
un_pull <- function(series,start, end) {
  # jsonlite::fromJSON(paste('https://unstats.un.org/SDGAPI/v1/sdg/Series/Data?seriesCode=',series,'&timePeriodStart=',start,'&timePeriodEnd=',end,'&pageSize=10000',sep=""), flatten = TRUE)$data %>%
      jsonlite::fromJSON(paste('https://unstats.un.org/SDGAPI/v1/sdg/Series/Data?seriesCode=',series,'&pageSize=10000',sep=""), flatten = TRUE)$data %>%

    as_tibble() %>%
    mutate(date=timePeriodStart) %>%
    right_join(iso3c)
    
}  

FitFlextableToPage <- function(ft, pgwidth = 6){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

```

# Pillars of the new SPI


A quick primer on names. We refer to the 5 rows in the framework in Figure 1 as dimensions. We refer to the 22 cells in the framwork in Figure 1 as pillars. Finally, each pillar may be composed of multiple indicators. For instance, the pillar on censuses and surveys is made up indicators on whether population censuses have been conducted, agriculture censuses, labor force surveys, etc.

## Data use

The data use dimension is segmented by user type. The tiles on the Dashboard provide an indicator of use of statistics respectively by the legislature, executive, civil society (including sub-national actors), academia and international bodies. A mature system would score well across the tiles. Areas for development would be highlighted by weaker scores in that domain enabling questions to be asked about prioritization amongst user groups and why existing services are not resulting in higher use of national statistics in that segment.

## Data services

The data services dimension is segmented by service type. The tiles on the Dashboard provide an indicator of the quality of data releases, the richness and openness of online access, the effectiveness of advisory and analytical services related to statistics and the availability and use of data services such as secure microdata access. Advisory and analytical services might incorporate elements related to data stewardship services including ethical consideration of proposals and calling out misuse of data in accordance with the Fundamental Principles of Official Statistics.

## Data products

The data products dimension is segmented by topic and organized into social, economic, environmental and institutional domains using the typology of the Sustainable Development Goals. This approach enables comparisons across countries and anchors the system in the 2030 agenda so that a global view can be generated whilst enabling different emphasis to be applied in different countries to reflect the user needs of that country.

## Data sources

The data sources dimension is segmented between sources generated by the statistical office (censuses and surveys) and sources accessed from elsewhere (administrative data, geospatial data, private sector data and citizen generated data). The appropriate balance between these types of source will vary depending on the institutional setting and maturity of the statistical system in each country. High scores should reflect the extent to which the sources being utilized enable the necessary statistical indicators to be generated. For example, a low score on environment statistics may reflect a lack of use of (and low score for) geospatial data. This linkage, which is inherent in the data cycle approach, should help highlight areas for investment if country needs are to be met.

## Data infrastructure

The data infrastructure dimension is segmented into hard and soft infrastructure segments itemizing essential cross cutting requirements for an effective statistical system. The segments are:   

  1. Legislation and governance covering the existence of laws and a functioning institutional framework for the statistical system    
  2. Standards and methods addressing compliance with recognized frameworks and concepts   
  3. Skills including level of skills within the statistical system and amongst users (statistical literacy)   
  4. Partnerships reflecting the need for the statistical system to be inclusive and coherent    
  5. Finance, both domestically and from donors    
  
## Indicators and weights    

We are seeking answers to the questions:    

  1. What indicator (that we can measure in practice) could act as a proxy measure for the concept we are trying to capture?   
  2. What weight can we assign to the indicator that allows this concept to be aggregated with others in a meaningful way?   
  
  There will be no right answer to these questions and the proposed approach makes a virtue of this by: 
  
  1. Allowing missing values and setting out how missing values are dealt with for the purposes of making comparisons over time and between countries    
  2. Providing users the opportunity to apply their own weights    
  3. Releasing the dashboard as a “Beta” and encouraging a research agenda to help fill in gaps and improve any elements   
  4. Establishing a process for review that enables time series to be respected.   
  5. Presenting the dashboard within a toolkit for understanding statistical performance   



Below is a brief description of the 22 pillars in our framework.  A detailed description of the underlying indicators populating the pillars is also available in the annex.



```{r metadata_tab1}
####
# create table
####

pillars <- pillars %>%
  mutate(pillar=paste(pillar_number, pillar_name, sep=": ")) %>%
  select(pillar, spi_indicator_description)


pillars_tab <- flextable(pillars) %>%
  add_header_lines('SPI Pillars Metadata.') %>%
  set_header_labels(values=list(
                       pillar="Pillar",
                       spi_indicator_description="Brief Description"
                                   )) 

FitFlextableToPage(pillars_tab) %>%
  width(width=3.2) %>%
  align( align = "left", part = "body")


```

# Index Methodology

For research purposes, we create an index combining several indicators together to get an overview of country performance.  The Index will contain only a subset of the pillars from our framework.  For pillars excluded, we either lacked a source with a developed methodology or else the data collection for that measure was incomplete. This is described below:

  * **Pillar 1.1: Data use by national legislature:**  *Not included because of lack of established methodology*   
  * **Pillar 1.2: Data use by national executive branch:** *Not included because of lack of established methodology*      
  * **Pillar 1.3: Data use by civil society:**  *Not included because of lack of established methodology*    
  * **Pillar 1.4: Data use by academia:**  *Not included because of lack of established methodology*   
  * **Pillar 1.5: Data use by international organizations:**  *Reliability/Usefulness of Poverty, Child Mortality, Debt Statistics for international agencies using metadata*    

  
  * **Pillar 2.1: Data Releases:** *SPI.D2.1.GDDS -	SDDS/e-GDDS subscription*    
  * **Pillar 2.2: Online access:** *SPI.D2.2.Openness.subscore	ODIN Open Data Openness score*   
  * **Pillar 2.3: Advisory/ Analytical Services:**  *Not included because of lack of established methodology*    
  * **Pillar 2.4: Data services:** *SPI.D2.4.NADA	NADA metadata*
  
  * **Pillar 3.1: Social Statistics:** *Average score for Goal 1-6 indicators*
  * **Pillar 3.2: Economic Statistics:** *Average score for Goal 7-12 indicators*  
  * **Pillar 3.3: Environmental Statistics:**  *Average score for Goal 13-15 indicators*      
  * **Pillar 3.4: Institutional Statistics:** *Average score for Goal 16-17 indicators*    

  * **Pillar 4.1: Censuses and Surveys:** *Average score Census and Survey Indicators indicators SPI.D4.1....*
  * **Pillar 4.2: Administrative Data:** *Average score for CRVS indicator.  Social Protection, Education, and Labor admin data indicators not included because of lack of established methodolgy*  
  * **Pillar 4.3: Geospatial Data:**  *SPI.D4.3.GEO.first.admin.level -	Geospatial data available at 1st Admin Level* 
  * **Pillar 4.4: Private/citizen generated data:**  *Not included because of lack of established methodology*   
  
  * **Pillar 5.1: Legislation and governance:**  *Not included because of insufficient country coverage*  
  * **Pillar 5.2: Standards and Methods:** *Average score for Standards and Methods indicators SPI.D5.2....*  
  * **Pillar 5.3: Skills:**  *Not included because of lack of established methodology*    
  * **Pillar 5.4: Partnerships:**  *Not included because of lack of established methodology*    
  * **Pillar 5.5: Finance:**  *Not included because of insufficient country coverage* 
  

This process of eliminating some pillars due to lack of established methodology or country coverage results in 12 pillars. This includes 1 on data use, 3 on data services, 4 on data products, 3 on data sources, and 1 on data infrastructure.

## Overall Score

Our statistical performance indicators have a three level structure, and our overall score will be formed by sequentially aggregating each level.

To begin we produce a score for each pillar, which is an unweighted average of the indicators within that pillar.  For instance, the Census and Surveys pillar will be formed by taking the unweighted average of the Population Census score, the Agriculture Census score, the Business Census score, the Labor Force Survey score, the Health Survey score, etc.  

$$ SPI.PILLAR{ctds} = \sum_{i=1}^{N_I} \frac{SPI.IND_{ctdsi}}{N_I} $$

where $SPI.PILLAR{ctds}$ is pillar s, in dimension d, in time period t, and country c.  $SPI.IND_{ctdsi}$ is an indicator (e.g. population census score).

After computing a score for the pillar, we then compute a dimension score, which is the unweighted average of the pillars in that dimension.

$$ SPI.DIM_{ctd} = \sum_{s=1}^{N_S} \frac{SPI.PILLAR{ctds}}{N_S} $$


After calculating the scores for each dimension The SPI index is the average across the 5 dimensions. 

The SPI index is scaled to have a maximum score of 100 and a minimum of 0. A score of 100 would indicate that a country has every single element that we measure in place. A score of 0 indicates that none are in place. To be precise:



$$ SPI.INDEX_{ct} = \sum_{d=1}^{N_D} \frac{SPI.DIM_{ctd}}{N_D} $$

Where SPI.INDEX is the SPI overall index. SPI.DIM are the 5 SPI dimensions listed above. In the notation, c is a country, t is the date, d is a dimension.  

The nested structure of our index and the summation methods used to build an overall score ensure the axiomatic properties outlined in [@cameron2019measuring].  These include symmetry, monotonicity, and subgroup decomposability.

## Handling Missing Data 

For a full description of the methodology behind each specific indicator, please consult the technical documentation.  However, we did follow an approach of handling missing values and lining up data, which I will describe in general terms below.  For indicators where we had a value for a previous year (say a value in 2018 but not 2019), we would fill in from the previous value.  For instance, the open data watch indicators on geo-spatial data was only released in 2018, not 2019, so we filled in the value for 2019 with the value from 2018 as our best estimate of that indicator.

For indicators where we had no data for any years, we chose not to impute a value.  In that case, the value for that indicator is null and the country will not have a value for any pillars or dimensions where that value is used.


# Analysis


```{r spi_df}

# This block of code will create a blank SPI dataset (only containing country info) that will be appended to when each indicator is added.
# There will be two indicators added for each dimension
# 1. An indicator with a score between 0-1 for each dimension
# 2. An indicator with the raw (unscored) values of the indicators
# The unit for this database will be country*year

span <- c(2004:2019)

spi_df_empty <- bind_rows(replicate(length(span), wbstats::wbcountries(), simplify = FALSE), .id='date') %>%
  mutate(date=as.numeric(date)+span[1]-1) %>%
  filter(region!="Aggregates") # take out the aggregates (LAC, SAR, etc)

spi_df <- spi_df_empty

#read list of iso3c codes for matching from UN (https://unstats.un.org/unsd/methodology/m49/)
iso3c <- read_csv(paste(raw_dir,'metadata/iso_codes.csv', sep="/"),
                  col_types=list(col_character(), col_character(), col_character()))

```
  

```{r index}
#get a list of oecd countries
oecd_country_query <-  GET(url = "https://api.worldbank.org/v2/country?region=OED&format=json") %>%
  content( as = "text", encoding = "UTF-8") %>%
  jsonlite::fromJSON( flatten = TRUE) 

#do some conversion to produce a dataframe
oecd_country_df <- oecd_country_query[[2]] %>%
  as_tibble() 
  
country_mod_list <- oecd_country_df$name  #fill in the missing values for OECDs with 1s because by participating in OECD these countries have this
country_mod_list <- c(country_mod_list, 'Singapore')
# create index dataset
spi_index_df_temp <- spi_df_final %>%
  select(country, iso3c, date, starts_with("SPI"), income, region, weights, population) %>%
  arrange(-date,country)

#Drop certain indicators that don't make cut because of imcomplete coverage usually
spi_index_df_temp <- spi_index_df_temp %>%
  select( -SPI.D5.3.DISK, -SPI.D4.3.GEO.second.admin.level,, -SPI.D4.2.1.SPL, -SPI.D4.2.4.LBR,-SPI.D4.2.2.EDU) 





#first index 
# just take a simple numeric average acorss all indicators
# I will forward fill all indicators if they are missing
spi_index_simple <- spi_index_df_temp %>%
  arrange(country, date) %>%
  group_by(country) %>%
  select(-starts_with("SPI.D1")) %>%
  mutate(across(starts_with("SPI"), na.locf, na.rm=FALSE)) %>%
  mutate(across(c("SPI.D2.1.GDDS","SPI.D2.4.NADA","SPI.D4.1.1.POPU","SPI.D4.1.2.AGRI","SPI.D4.1.3.BIZZ","SPI.D4.1.4.HOUS","SPI.D4.1.5.AGSVY",
                  "SPI.D4.1.6.LABR","SPI.D4.1.7.HLTH","SPI.D4.1.8.BZSVY",
                  "SPI.D5.2.1.SNAU", "SPI.D5.2.2.NABY", "SPI.D5.2.1.SNAU","SPI.D5.2.2.NABY",                
                  "SPI.D5.2.3.CNIN", "SPI.D5.2.4.CPIBY", "SPI.D5.2.5.HOUS", "SPI.D5.2.6.EMPL","SPI.D5.2.7.CGOV", "SPI.D5.2.8.FINA",
                  "SPI.D5.2.9.MONY", "SPI.D5.2.10.GSBP" ),
                ~if_else(( (income=='High income') & (country %in% country_mod_list)),1,.)                )) %>% 
  mutate(SPI.INDEX=rowMeans(across(starts_with("SPI")), na.rm=FALSE),
         SPI.INDEX.DIM2=rowMeans(across(starts_with("SPI.D2")), na.rm=FALSE),
         SPI.INDEX.DIM3=rowMeans(across(starts_with("SPI.D3")), na.rm=FALSE),
         SPI.INDEX.DIM4=rowMeans(across(starts_with("SPI.D4")), na.rm=FALSE),
         SPI.INDEX.DIM5=rowMeans(across(starts_with("SPI.D5")), na.rm=FALSE)
         ) %>% #
  arrange(-date, -SPI.INDEX) %>%
  select(country, iso3c, date, starts_with('SPI.INDEX'), everything())


#################
# Nested Index
################
  spi_index_df <- spi_index_df_temp %>%
  arrange(country, date) %>%
  group_by(country) %>%
  mutate(across(starts_with("SPI"), na.locf, na.rm=FALSE)) %>%
  mutate(across(c("SPI.D1.5.POV",
                  "SPI.D2.1.GDDS","SPI.D2.4.NADA","SPI.D4.1.1.POPU","SPI.D4.1.2.AGRI","SPI.D4.1.3.BIZZ","SPI.D4.1.4.HOUS","SPI.D4.1.5.AGSVY",
                  "SPI.D4.1.6.LABR","SPI.D4.1.7.HLTH","SPI.D4.1.8.BZSVY",
                  "SPI.D5.2.1.SNAU", "SPI.D5.2.2.NABY", "SPI.D5.2.1.SNAU","SPI.D5.2.2.NABY",                
                  "SPI.D5.2.3.CNIN", "SPI.D5.2.4.CPIBY", "SPI.D5.2.5.HOUS", "SPI.D5.2.6.EMPL","SPI.D5.2.7.CGOV", "SPI.D5.2.8.FINA",
                  "SPI.D5.2.9.MONY", "SPI.D5.2.10.GSBP" ),
                ~if_else(( (income=='High income') & (country %in% country_mod_list)),1,.)                )) %>% 
  select(country, iso3c, date, everything())



#Create overall subscores corresponding to John's framework
  spi_index_df <- spi_index_df %>%
    mutate(INDEX.SPI.D2.1=rowMeans(across(starts_with('SPI.D2.1'))),
         INDEX.SPI.D2.2=SPI.D2.2.Openness.subscore,
         INDEX.SPI.D2.4=SPI.D2.4.NADA,
         INDEX.SPI.D3.1=rowMeans(across(c("SPI.D3.1.POV",
                                            "SPI.D3.2.HNGR",
                                            "SPI.D3.3.HLTH",
                                            "SPI.D3.4.EDUC",
                                            "SPI.D3.5.GEND",
                                            "SPI.D3.6.WTRS"))),
         INDEX.SPI.D3.2=rowMeans(across(c("SPI.D3.7.ENRG",
                                            "SPI.D3.8.WORK",
                                            "SPI.D3.9.INDY",
                                            "SPI.D3.10.NEQL",
                                            "SPI.D3.11.CITY",
                                            "SPI.D3.12.CNSP"))),         
         INDEX.SPI.D3.3=rowMeans(across(c("SPI.D3.13.CLMT",
                                            "SPI.D3.15.LAND" ))),
         INDEX.SPI.D3.4=rowMeans(across(c("SPI.D3.16.INST",
                                            "SPI.D3.17.PTNS" ))),
         INDEX.SPI.D4.1=rowMeans(across(starts_with('SPI.D4.1'))),
         INDEX.SPI.D4.2=rowMeans(across(starts_with('SPI.D4.2'))),
         INDEX.SPI.D4.3=rowMeans(across(starts_with('SPI.D4.3'))),
         #INDEX.SPI.D5.1=rowMeans(across(starts_with('SPI.D5.1'))),
         INDEX.SPI.D5.2=rowMeans(across(starts_with('SPI.D5.2'))),
         #INDEX.SPI.D5.5=rowMeans(across(starts_with('SPI.D5.5')))
                 ) %>%
  mutate(
         SPI.INDEX.DIM1=rowMeans(across(starts_with("SPI.D1.5")), na.rm=FALSE),
         SPI.INDEX.DIM2=rowMeans(across(starts_with("INDEX.SPI.D2")), na.rm=FALSE),
         SPI.INDEX.DIM3=rowMeans(across(starts_with("INDEX.SPI.D3")), na.rm=FALSE),
         SPI.INDEX.DIM4=rowMeans(across(starts_with("INDEX.SPI.D4")), na.rm=FALSE),
         SPI.INDEX.DIM5=rowMeans(across(starts_with("INDEX.SPI.D5")), na.rm=FALSE),
         SPI.INDEX=rowMeans(across(c('SPI.INDEX.DIM1',
                                     'SPI.INDEX.DIM2',
                                     'SPI.INDEX.DIM3',
                                     'SPI.INDEX.DIM4',
                                     'SPI.INDEX.DIM5')), na.rm=FALSE)
         ) %>% #
  arrange(-date, -SPI.INDEX) %>%
  select(country, iso3c, date, starts_with('SPI.INDEX'), everything()) %>%
    filter(date>=2016) #2016 is first year with complete data 

  
#display top 25
index_disp <- spi_index_df %>%
  ungroup() %>%
  filter(date==2019) %>%
  arrange(-SPI.INDEX) %>%
  mutate(across(starts_with('SPI.INDEX'),~100*.),
         across(starts_with('SPI.INDEX'),round,1)) %>%
  select(country, iso3c, date, starts_with('SPI.INDEX'))


spi_index_df %>%
  write_excel_csv(path=paste(output_dir, 'SPI_index.csv', sep="/"))





```


```{r text_computations}

#number of countries with data for SPI index
n_countries <- spi_index_df %>%
  filter(!is.na(SPI.INDEX) & date==2019) %>% #countries with value for SPI in 2019
  nrow()

# percentage of world population covered
pop_covered <- spi_index_df %>%
  filter(date==2019) %>%
  mutate(covered=!is.na(SPI.INDEX)) %>%
  mutate(covered_pop=if_else(covered==TRUE, population, 0)) %>%
  ungroup() %>%
  summarise(pop_covered=sum(covered_pop, na.rm=T)/sum(population, na.rm=T))


```


Below we show a set of summary measures for our SPI index.  We begin by presenting a world map containing the SPI index values for 2019 for each country.  In total, we have `r n_countries` countries with sufficient data to compute an index value.  This set of countries covers `r 100*round(pop_covered$pop_covered,3)` percent of the world population.


```{r sumstats}
#show map and summary stats by region and income group

spi_mapper('spi_index_df','SPI.INDEX','Overall SPI Index')

```

## Unique Values

```{r unique_scores}

#calculate the number of unique values in the SPI Index
spi_index_2019 <- spi_index_df %>%
  filter(date==2019) %>%
  filter(!is.na(SPI.INDEX))

unique_scores <-  length(unique(spi_index_2019$SPI.INDEX))

#check unique values by dimension.
unique_scores1 <-  length(unique(spi_index_2019$SPI.INDEX.DIM1))
unique_scores2 <-  length(unique(spi_index_2019$SPI.INDEX.DIM2))
unique_scores3 <-  length(unique(spi_index_2019$SPI.INDEX.DIM3))
unique_scores4 <-  length(unique(spi_index_2019$SPI.INDEX.DIM4))
unique_scores5 <-  length(unique(spi_index_2019$SPI.INDEX.DIM5))

```


As a check of the data, we calculate the number of unique scores for our SPI index. If our SPI index produces a large number of tied scores, for instance, then our index will be less able to distinguish between the statistical performance of countries.  When calculating the number of unique values for 2019, we find that there are `r unique_scores` unique scores for `r n_countries` countries.  This means there are `r n_countries-unique_scores` tied values.  When looking within each dimension.  

When looking at each specific dimension, there are only `r unique_scores1` unique scores for Dimension 1 on data use.  The data use indicator is coming solely from dimension 1.5 on data use by international organizations.  For Dimension 2, there are `r unique_scores2` unique scores.  For Dimension 3, there are `r unique_scores3` unique scores.  There are `r unique_scores4` unique scores for dimension 4, and there are `r unique_scores5` unique scores for dimension 5.




## Relationship to GDP Per Capita and the Human Capital Index

Below, we will present the correlation between our SPI index and the log of GDP per capita and the World Bank's Human Capital Index ([@hci2020]).  The source for GDP per capita comes from the  World Bank's World Development Indicators (WDI) database (NY.GDP.PCAP.KD).  The GDP per capita numbers are in constant 2010 US$.  

```{r log_gdp}

#HCI
hci_df <- wbstats::wb_data(country="countries_only", 
              indicator='HD.HCI.OVRL',
              start_date=2016,
              end_date=2019,
              return_wide = F) %>%
  left_join(select(spi_index_df,iso3c,date, region,SPI.INDEX)) #merge on SPI Index data

#get the correlation for 2019
hci_df_2018 <- hci_df %>%
  filter(date==2018) 




hci_spi <- ggplot(data=hci_df_2018, aes(x=value, y=100*SPI.INDEX)) +
  facet_wrap(~indicator) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm') +
  theme_bw() +
  ylab('SPI Index value') +
  xlab('Human Capital Index') +
  stat_poly_eq(aes(label  = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     label.x.npc = "right", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4) +
    theme(legend.position = 'bottom')


#GDP
gdp_df <- wbstats::wb_data(
  indicator='NY.GDP.PCAP.KD',
  start_date=2016,
  end_date=2019,
  return_wide = F
    ) %>%
  left_join(select(spi_index_df,iso3c,date, region,SPI.INDEX)) #merge on SPI Index data

#get the correlation for 2019
gdp_df_2019 <- gdp_df %>%
  filter(date==2019) 

  gdp_spi <- ggplot(data=gdp_df_2019, aes(x=value, y=100*SPI.INDEX)) +
  facet_wrap(~indicator) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm') +
  scale_x_log10(labels = scales::comma) +
  theme_bw() +
  ylab('SPI Index value') +
  xlab('Log GDP Per Capita') +
  theme(legend.position = 'bottom') +
  stat_poly_eq(aes(label = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     label.x.npc = "right", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4)
  




corr_hci_2018 <- cor(hci_df_2018$value,hci_df_2018$SPI.INDEX, use='pairwise.complete.obs')


corr_2019 <- cor(log(gdp_df_2019$value),gdp_df_2019$SPI.INDEX, use='pairwise.complete.obs')
corr_2019_nontrans <- cor(gdp_df_2019$value,gdp_df_2019$SPI.INDEX, use='pairwise.complete.obs')

```

We would expect a strong positive relationship between GDP per capita of countries and their statistical system, as higher income countries would tend to have more resources available for statistical production.  In fact, there is a strong relationship between the two.  The correlation in 2019 between log GDP per capita and the SPI index is `r round(corr_2019,2)`.[^1]

[^1]: To understand what effect taking the log has on this correlation, the correlation in 2019 between (non-logged) GDP per capita and the SPI index is `r round(corr_2019_nontrans,2)`. 

Another measure of a country's development is the Human Capital Index (HCI) developed by the World Bank ([@hci2020]).  The Human Capital Index is designed to capture the amount of human capital a child born today can expect to attain by age 18 in a country.  The index combines a country's child mortality, learning adjusted years of schooling, adult survival rates & stunting into one index. For more details, visit the Human Capital Index website (https://www.worldbank.org/en/publication/human-capital).  Again, we would expect a strong positive relationship between a country's HCI value and their Statistical Performance Indicators index value, as countries with a more developed human capital stock are likely to have greater capacity to produce statistics.  Again, this is what we see.  The correlation between the 2018 value of the HCI (the latest value available at the time of this writing) and the 2018 value of the SPI index is `r round(corr_hci_2018,2)`.

Below we show the scatter plot of the relationship between log GDP per capita, the HCI, and our SPI index for the years 2016-2019.  In general, countries with higher per capita income and higher levels of human capital tend to have better performing statistical systems according to our measure.  

```{r gdp_plot}

### Scatterplot log GDP SPI
gdp_spi + hci_spi   +
  plot_annotation(
    title='Plot of SPI Index on Human Capital Index and GDP per capita',
    caption='Source: All indicators come from the World Bank.'
    )
  

```

## Country Changes in the Index



```{r changes}
#create a dataframe for the 2016 SPI to calculate changes since 2016
spi_index_2016 <- spi_index_df %>%
  filter(date==2016) %>%
  filter(!is.na(SPI.INDEX)) %>%
  mutate(SPI.INDEX.2016=100*SPI.INDEX) %>%
  select(iso3c, country, region, SPI.INDEX.2016)

spi_changes <- spi_index_2019 %>%
  mutate(SPI.INDEX.2019=100*SPI.INDEX) %>%
  select(iso3c, country,region, SPI.INDEX.2019) %>%
  left_join(spi_index_2016)


#correlation
corr_2019_2016 <- cor(spi_changes$SPI.INDEX.2019,spi_changes$SPI.INDEX.2016, use='pairwise.complete.obs')


```

In order to assess how stable our index values are over time, next we will compare the index values in 2016 to the 2019 values.  Overall, the SPI index is quite stable over time.  The correlation between the 2016 value and the 2019 value is `r round(corr_2019_2016,2)`.

```{r changes_plot}

ggplot(spi_changes, aes(x=SPI.INDEX.2016, y=SPI.INDEX.2019, color=region)) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm', color='blue') +
  theme_bw() +
  labs(
    title='Scatterplot of 2019 SPI Index values & 2016 SPI Index values'
  ) +
  ylab('2019 SPI Index value') +
  xlab('2016 SPI Index value') +
  theme(legend.position = 'bottom') +
    stat_poly_eq(aes(label = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     color='black',
                     label.x.npc = "right", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4)


```


```{r top_bottom_changes}

top_changes <- spi_changes %>%
  mutate(changes=SPI.INDEX.2019-SPI.INDEX.2016) %>%
  arrange(-changes) %>%
  select(country,SPI.INDEX.2019,SPI.INDEX.2016, changes) %>%
  mutate(across(c('SPI.INDEX.2019','SPI.INDEX.2016', 'changes'),round,1))

top_mover <- as.character(top_changes[1,1])
top_mover_change <- as.numeric(top_changes[1,4])
```


While the scores were relatively stable over time, some countries did see large improvements in their score from 2016-2019.  The country that improved most on our index from 2016 to 2019 was `r top_mover`. `r top_mover` improved by `r top_mover_change` points on our scale out of 100.  The table below shows the changes in our SPI index for the top 10 largest improvers.



```{r top_bottom_changes_tab}
top_changes_tab <- flextable(head(top_changes,10)) %>%
  add_header_lines('Top 10 Countries with Largest Changes from 2016-2019.') %>%
  set_header_labels(values=list(
                       country="Country",
                       SPI.INDEX.2019="SPI Index Score 2019",
                       SPI.INDEX.2016="SPI Index Score 2016",
                       changes="Difference"
                                   )) 

FitFlextableToPage(top_changes_tab) %>%
  width(width=1.2) %>%
  align( align = "left", part = "body")
```


## Comparison to the Statistical Capacity Indicators

Next, we compare our index to several other indices of statistical performance that have been created.  This will provide a sense of how rankings differ across measures, how they correlate with other outcomes, and how the distributions of scores compare.

```{r comparison, include=FALSE}

#pull SCI values

Request_metadata <- GET(url = "http://api.worldbank.org/v2/country/all/indicator/IQ.SCI.OVRL?format=json&date=2004:2019&per_page=5000")
Response_metadata <- content(Request_metadata, as = "text", encoding = "UTF-8")

# Parse the JSON content and convert it to a data frame.
sci_df <- jsonlite::fromJSON(Response_metadata, flatten = TRUE) %>%
  data.frame() %>%
  transmute(
    iso3c=countryiso3code,
    country=country.value,
    date=as.numeric(date),
    SCI=value
  ) %>%
  left_join(spi_df_empty) %>% #add on country metadata
  filter(!is.na(income)) %>%
  select(iso3c, country, date, SCI  ) %>%
  group_by(date) %>%
  arrange(-SCI) %>%
  mutate(SCI_rank=rank(-SCI),
         SCI_rank=if_else(is.na(SCI),as.numeric(NA),SCI_rank))

#read in ODIN data
  for (i in 2015:2018) {
   temp <- read_csv(paste(raw_dir, '/2.2_DSOA/','ODIN_',i,'.csv', sep=""))  %>%
        as_tibble(.name_repair = 'universal') %>%
        mutate(date=i) %>%
        filter(Data.categories=='All Categories')


    assign(paste('odin_df',i,sep="_"), temp)
  }

    #bind different years together
odin_df <- bind_rows(odin_df_2015, odin_df_2016, odin_df_2017, odin_df_2018)


odin_df <- odin_df %>%
    select(Country.Code, date, Overall.score) %>%
    rename(iso3c=Country.Code,
           ODIN_score=Overall.score) %>%
    group_by(date) %>%
    arrange(-ODIN_score) %>%
    mutate(ODIN_rank=rank(-ODIN_score, na.last='NA')) %>% 
  right_join(spi_df_empty) %>%
  arrange(country, date) %>%
  group_by(country) %>%
  mutate(across(starts_with("ODIN"), na.locf, na.rm=FALSE)) %>%
  select(country, date, starts_with("ODIN"))


#read in the old SPI
SPI_v0_df <- readxl::read_excel(path='C:/Users/wb469649/OneDrive - WBG/DECIS/SPI_AKI/Data/FinalCopy of SPI SCORE 2016-2018-DW.xlsx', skip=2) %>%
  transmute(
    iso3c=Country,
    SPI_2016=as.numeric(Overall...7),
    SPI_2017=as.numeric(Overall...12),
    SPI_2018=as.numeric(Overall...17)
  ) %>%
  pivot_longer(
    cols=c('SPI_2016','SPI_2017','SPI_2018'),
    names_to="date",
    values_to = 'SPI_v0'
  ) %>%
  mutate(date=gsub('SPI_','',date),
         date=as.numeric(date))


#create one database
comparison_df <- spi_index_df %>%
  ungroup() %>%
  filter(date %in% c(2016:2019)) %>%
  arrange(-SPI.INDEX) %>%
  mutate(across(starts_with('SPI.INDEX'),~100*.),
         across(starts_with('SPI.INDEX'),round,1)) %>%
  select(country, iso3c, date, income, region, SPI.INDEX) %>%
  left_join(sci_df) %>%
  left_join(odin_df) %>%
  left_join(SPI_v0_df)




```

We compare the SPI index to the older World Bank Statistical Capacity Indicators (http://datatopics.worldbank.org/statisticalcapacity/SCIdashboard.aspx).  The correlation between the SPI index and the SCI  is `r round(cor(comparison_df$SPI.INDEX,comparison_df$SCI, use='pairwise.complete.obs'),3)`.

```{r sci}

### Scatterplot SCI SPI
spi_sci_plot <- ggplot(comparison_df, aes(y=SPI.INDEX,x=SCI, color=region)) +
  facet_wrap(~date) +
  # geom_point() +
  geom_text(aes(label=iso3c)) +
  theme_bw() +
  labs(
    title='Scatterplot of Statistical Capacity Index (SCI) and SPI Index'
  ) +
  ylab('SPI Index value') +
  xlab('SCI value') +
  theme(legend.position = 'bottom')

spi_sci_plot


```


```{r sci_spi_reg}
gdp_reg_df <- wbstats::wb_data(
  indicator='NY.GDP.PCAP.KD',
  start_date=2016,
  end_date=2019
    ) %>%
  mutate(log_gdp_pcap=log(NY.GDP.PCAP.KD)) %>%
  left_join(select(comparison_df,iso3c,date, region,SPI.INDEX,SCI,ODIN_score,SPI_v0)) #merge on SPI Index data
  
  
#regress Log GDP SPI
m_spi <- lm_robust(SPI.INDEX ~ log_gdp_pcap + factor(date), data = gdp_reg_df, se_type = "HC2") 

m_spi_lm <- lm(SPI.INDEX ~ log_gdp_pcap + factor(date), data = filter(gdp_reg_df,!(is.na(SPI.INDEX) | is.na(log_gdp_pcap)))) 
gdp_reg_df_resids <- broom::augment(m_spi_lm, data=filter(gdp_reg_df,!(is.na(SPI.INDEX) | is.na(log_gdp_pcap)) ))


#regress Log GDP SCI
m_sci <- lm_robust(SCI ~ log_gdp_pcap + factor(date), data = gdp_reg_df, se_type = "HC2") 


#regress Log GDP ODIN
m_odin <- lm_robust(ODIN_score ~ log_gdp_pcap + factor(date), data = gdp_reg_df, se_type = "HC2") 


#regress Log GDP SPI_v0
m_spi_v0 <- lm_robust(SPI_v0 ~ log_gdp_pcap + factor(date), data = gdp_reg_df, se_type = "HC2") 

m_spi_tidy <- broom::tidy(m_spi)
m_spi_glance <- broom::glance(m_spi)

spi_coef <- as.numeric(m_spi_tidy[2,2])
spi_r2 <- as.numeric(m_spi_glance[1,1])

```


Next, we show how the relationship to Log GDP per capita differs for the SCI and the SPI index using linear regression.  We also include the Open Data Watch and the version of the Statistical Performance Index developed in [@cameron2019measuring].  While showing a strong relationship between an index and log GDP per capita does not mean the index is necessarily correct, and is certainly not necessarily causal, it does provide a face validity check of the index.  Heteroskedasticity robust standard errors are shown in the table.

Overall, the new SPI index has the strongest relationship to GDP per capita.  The linear regression estimates indicate that a 1% increase in GDP per capita is associated with a `r round(spi_coef/100,1)` point increase in our SPI index score.  The r-squared from this regression is `r round(spi_r2,2)`.



```{r sci_spi_reg_tab}



#combine SPI and SCI results together
date_names <- grep("factor", names(coef(m_spi)), value = TRUE)
names(date_names) <- gsub(".*)(.)", "Year: \\1", date_names)

huxtable::huxreg('SPI Index'=m_spi, 'SCI'=m_sci, 'Open Data Watch'=m_odin, 'SPI Version 0'=m_spi_v0,
       coefs=c('Log GDP per Capita'='log_gdp_pcap', date_names, 'Intercept'='(Intercept)'),
       note='{stars}. Heteroskedasticity Robust Std Errors in Parenthesis',
       number_format=2,
       bold_signif=0.05) %>%
  huxtable::set_caption('Linear Regressions of Alternate Statistical Performance Indices on Log GDP per Capita') %>%
  huxtable::as_flextable() %>%
  FitFlextableToPage() %>%
  width(width=1.2)



gdp_long <- gdp_reg_df %>%
  pivot_longer(
    cols = c('SPI.INDEX', 'SPI_v0', 'ODIN_score', 'SCI'),
    names_to='index',
    values_to='index_values'
  ) %>%
  mutate(
    index_name=case_when(
      index=='SPI.INDEX' ~ "SPI Index",
      index=='SPI_v0' ~ "SPI Index Version 0",
      index=='ODIN_score' ~ "Open Data Watch",
      index=='SCI' ~ "SCI",
      
    )
  ) %>%
  filter(date==2018)

ggplot(gdp_long, aes(x=log_gdp_pcap,y=index_values, color=region)) +
  facet_wrap(~index_name) +
  # geom_point() +
  geom_text(aes(label=iso3c)) +
  theme_bw() +
  labs(
    title='Scatterplot of Alternate Statistical Performance Indices on Log GDP per Capita'
  ) +
  xlab('Log GDP Per Capita') +
  ylab('Index Values') +
  theme(legend.position = 'bottom')

```


## ODIN ranking comparison

We compare the SPI index to the Open Data Watch rankings of country statistical systems (https://odin.opendatawatch.com/report/rankings).  The correlation between the SPI index and the ODIN index is `r round(cor(comparison_df$SPI.INDEX,comparison_df$ODIN_score, use='pairwise.complete.obs'),3)`
 


```{r odin, echo=FALSE}

 

### Scatterplot ODIN SPI
spi_odin_plot <- ggplot(comparison_df, aes(y=SPI.INDEX,x=ODIN_score, color=region)) +
  # geom_point() +
  facet_wrap(~date) +
  geom_text(aes(label=iso3c)) +
  theme_bw() +
  labs(
    title='Scatterplot of Open Data Watch Index on SPI Index'
  ) +
  ylab('SPI Index value') +
  xlab('ODIN value') +
  theme(legend.position = 'bottom')

spi_odin_plot




```



## Comparison to Version 0 of the SPI

As a final comparison, we compare our new SPI index to an index developed by [@cameron2019measuring], which can be thought of as a version 0 of our SPI index.  The authors use similar data sources for their index.  However, there are some differences.


First, the similarities.  The methodology for constructing the index is the same.  Also, the censuses and surveys (Indicator 4.1) and standards and methods (Indicator 5.2) are identical.  The indicator for data releases (Indicator 2.1) and data services (Indicator 2.4) are pulled from the information collected in the fourth dimension on dissemination practices from version 0 of the SPI in Cameron et al. (2019).  Finally, both indicators include an indicator for Complete Vital Registration Statistics (CRVS).  The CRVS indicator is in the administrative data section of the new SPI index, while it was in the standards, methods, and classifications section of the SPI version 0.

For the differences, SPI version 0 had four dimensions, namely: (i) Methodology, Standards and Classifications (MSC), which provides information on the technology being used by the NSS; (ii) Census and Surveys (CS), which describes the intermediate products of the NSS; (iii) Availability of Key Indicators (AKI), which focuses on key final products needed for policy; and (iv) Dissemination Practices and Openness (DPO), which evaluates the extent to which products are publicly disseminated. 

The indicator on AKI, from version 0, is conceptually similar to our Data Products dimension in the new SPI, but uses different sources of data and the DPO section is similar to our data services section, but draw on some different sources in some cases.

We compare the SPI index to the SPI version 0.  The correlation between the SPI index and the version 0 index is `r round(cor(comparison_df$SPI.INDEX,comparison_df$SPI_v0, use='pairwise.complete.obs'),3)`



```{r spi_v0, echo=FALSE}


### Scatterplot SPI SPI_v0
spi_spi_plot <- ggplot(comparison_df, aes(y=SPI.INDEX,x=SPI_v0, color=region)) +
  facet_wrap(~date) +
  # geom_point() +
  geom_text(aes(label=iso3c)) +
  theme_bw() +
  labs(
    title='Scatterplot of SPI Version 0 Index on new SPI Index'
  ) +
  ylab('SPI Index value') +
  xlab('SPI Version 0 value') +
  theme(legend.position = 'bottom')

spi_spi_plot






```


## Density Plots

As another check, we present the distribution of scores across countries for each year and compare this distribution to a normal distribution.  This exercise checks for whether the distribution of our SPI index scores contains significant skew or fat tails.  There is some indication of a bunching of scores near the top of the distribution of SPI scores.  This is due to a large number of OECD countries possessing similar scores on our index.  This is not unexpected as OECD requires member countries to adhere to several methodological standards and  to regularly report on a large set of indicators.  These countries also are composed of several of the highest income countries that tend to be on the frontier of statistical production.

We also compare the distribution of our index to other measures of statistical performance.  These are the SCI, the Open Data Watch index (ODIN), and version 0 of the SPI index that was produced in [@cameron2019measuring] 

```{r density}

density_df <- comparison_df %>%
  select(iso3c, date, SPI.INDEX, SPI_v0, ODIN_score, SCI) %>%
  pivot_longer(
    cols = c('SPI.INDEX', 'SPI_v0', 'ODIN_score', 'SCI'),
    names_to='index',
    values_to='index_values'
  ) %>%
  mutate(
    index_name=case_when(
      index=='SPI.INDEX' ~ "SPI Index",
      index=='SPI_v0' ~ "SPI Index Version 0",
      index=='ODIN_score' ~ "Open Data Watch",
      index=='SCI' ~ "SCI",
      
    )
  )

#show the density of our SPI index
ggplot(spi_index_df, aes(x = SPI.INDEX)) + 
  facet_wrap(~date) +
  geom_histogram( 
                          aes(y=..density.., fill=..count..)) +
  stat_function(fun = dnorm, 
                color='red',
                args = list(mean = mean(spi_index_df$SPI.INDEX, na.rm=T), sd = sd(spi_index_df$SPI.INDEX, na.rm=T))) +
    theme_bw() +
  labs(
    title='Distribution of SPI Index across Countries',
    color='Index Name'
  ) +
  xlab('SPI Index value') +
  theme(legend.position = 'bottom')

#show the density of our SPI index compared to other indices
ggplot(density_df, aes(x = index_values, color=index_name)) + 
  facet_wrap(~date) +
  geom_density() +
    theme_bw() +
  labs(
    title='Distribution of SPI Index and Alternative Indices across Countries',
    color='Index Name'
  ) +
  xlab('Index value') +
  theme(legend.position = 'bottom')

```

# Dimension Index Scores

Next, we present the scores for each dimension that compose the SPI index (Data Use, Data Services, Data Products, Data Sources, and Data Infrastructure).  These figures can help show where (which dimension) variation is coming from across countries and to see where countries may be struggling in specific areas.

```{r dimensions_plot}

spi_mapper('spi_index_df','SPI.INDEX.DIM1','Dimension 1: Data Use Scores')
spi_mapper('spi_index_df','SPI.INDEX.DIM2','Dimension 2: Data Services Scores')
spi_mapper('spi_index_df','SPI.INDEX.DIM3','Dimension 3: Data Products Scores')
spi_mapper('spi_index_df','SPI.INDEX.DIM4','Dimension 4: Data Sources Scores')
spi_mapper('spi_index_df','SPI.INDEX.DIM5','Dimension 5: Data Infrastructure Scores')


```


# Annex

## Country SPI Index values

Below, we present the full list of countries by their SPI Index Score in 2019.  The first column is the country name and the following columns are the overall SPI index score, and then the sub-scores for dimension 1,2,3,4 and 5.  

The cells in the table are color coded based on the performance of countries on our index and the sub-scores of the dimensions.  Given the imprecision inherent in the calculations we recommend that the color coding provides the most detailed subdivisions of maturity. Finer distinctions are unlikely to provide meaningful differentiation between countries. 

Countries shaded in dark red are the lowest performing, countries in dark green are the highest performing.  Countries are grouped into three groups:   

* Emerging: Countries in the bottom 33% are classified in this group.  Shading is in red.  Countries in bottom half of this group are shown in dark red.  
* Intermediate: Countries in the middle 33% are classified in this group.  Shading in yellow.  Countries in the bottom half of this group are shown in light yellow.    
* Advanced:  Countries in the top 33% are classified in this group.  Shading in green.  Countries in the bottom half of this group are shown in light green.




```{r tab1, echo=FALSE}


#colors
col_palette <- c("#D73027",  "#FC7F60", "#FFFF8C", 
  "#E4ED40",  "#66BD63", "#1A9850")

col_palette2 <- c("#D73027",  "#E4ED40",  "#1A9850")

#make the table
index_tab <- index_disp %>%
  filter(date==2019) %>%
  select(country, SPI.INDEX,SPI.INDEX.DIM1,SPI.INDEX.DIM2,SPI.INDEX.DIM3,SPI.INDEX.DIM4,SPI.INDEX.DIM5) 

#make nice looking
index_tab <- index_tab %>%
  flextable() %>%
  add_header_lines('Overall SPI Index in 2019 and Dimension Scores.') %>%
  set_header_labels(values=list(
                       country="Country", 
                       SPI.INDEX="SPI Index Value",
                       SPI.INDEX.DIM1="Dim 1: Data Use",
                       SPI.INDEX.DIM2="Dim 2: Data Services",
                       SPI.INDEX.DIM3="Dim 3: Data Products ",
                       SPI.INDEX.DIM4="Dim 4: Data Sources",
                       SPI.INDEX.DIM5="Dim 5: Data Infrastructure"
                                   )) %>%
    bg(j = c('SPI.INDEX'), 
       bg = scales::col_quantile(col_palette, domain=NULL, n=6)) %>%
    bg(j = c('SPI.INDEX.DIM1'),
       bg = scales::col_quantile(col_palette2, domain=NULL, n=3)) %>%
    bg(j = c('SPI.INDEX.DIM2'),
       bg = scales::col_quantile(col_palette, domain=NULL, n=6)) %>%
    bg(j = c('SPI.INDEX.DIM3'),
       bg = scales::col_quantile(col_palette, domain=NULL, n=6)) %>%
    bg(j = c('SPI.INDEX.DIM4'),
       bg = scales::col_quantile(col_palette, domain=NULL, n=6)) %>%
    bg(j = c('SPI.INDEX.DIM5'),
       bg = scales::col_quantile(col_palette2, domain=NULL, n=3))

  

FitFlextableToPage(index_tab)

```

## Indicator Metadata


```{r metadata_tab2}
####
# create table
####

metatable <- metadata %>%
  filter(grepl('SPI.D',source_id)) %>%
  select(-spi_indicator_name,-source_id)



index_tab <- flextable(metatable) %>%
  add_header_lines('SPI Indicator Metadata.') %>%
  set_header_labels(values=list(
                       source_name="Indicator Name",
                       SPI_indicator_id="Pillar",
                       spi_indicator_description="Brief Description",
                       spi_indicator_scoring="Scoring"
                                   ))
  FitFlextableToPage(index_tab) %>%
  width(width=1.63)


```

# References


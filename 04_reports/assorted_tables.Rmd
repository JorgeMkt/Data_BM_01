---
title: "SPI Data Analysis"
author: "Brian Stacy"
date: "9/18/2020"
output:
  word_document: 
    toc: yes
    fig_width: 9
    fig_height: 6
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(flextable)
library(here)
# devtools::install_github("worldbank/wbgviz", subdir = "wbgdata")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgcharts")
# devtools::install_github("worldbank/wbgviz", subdir = "wbggeo")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgmaps")
library(wbggeo)
library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(httr)
library(patchwork)
library(ggrepel)
library(lubridate)
library(haven)
library(zoo)
library(skimr)

#set directories
dir <- here()

raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")
```

# Intro

Below is an overview of the SPI framework.

![unchanged image](SPI_dashboard.png)

The following will generate a set of tables and figures for the WDR.  Below is the list:

  1. Figure on Data use: great if you can put something together as you think makes sense, with a breakdown by income level   
  2. Data Products: % by goal at the global level    
  3. Indicators 4.x: by income group    
  4. Indicator 5.2 – standards. Same table as above but only with 5.2 
  5. Indicator 5.5 finance – same table as above, and in addition table by region   
  6.	Indicator 5.1 legislation and governance    
  8.	Population and Housing census and Agricultural Census. Four table as above, one set with % of countries with census in last 10 years, one set with % of countries with census in the last 20 years.     



```{r data, include=FALSE}
#read in the SPI dataset
spi_df_final <- read_csv( file = paste(output_dir, 'SPI_data.csv', sep="/"))

spi_index_df <- read_csv( file = paste(output_dir, 'SPI_index.csv', sep="/"))

metadata <- read_csv(paste(raw_dir, '/metadata/SPI_dimensions_sources.csv', sep=""))

```

```{r index, eval=FALSE, include=FALSE}

# create index dataset
spi_index_df_temp <- spi_df_final %>%
  select(country, iso3c, date, starts_with("SPI"), income, region) 
#Drop certain indicators that don't make cut because of imcomplete coverage usually
spi_index_df_temp <- spi_index_df_temp %>%
  select(-starts_with('SPI.D1'), -SPI.D5.3.DISK, -SPI.D4.3.GEO.second.admin.level,, -SPI.D4.2.1.SPL, -SPI.D4.2.4.LBR) 



#get a list of oecd countries
oecd_country_query <-  GET(url = "https://api.worldbank.org/v2/country?region=OED&format=json") %>%
  content( as = "text", encoding = "UTF-8") %>%
  jsonlite::fromJSON( flatten = TRUE) 

#do some conversion to produce a dataframe
oecd_country_df <- oecd_country_query[[2]] %>%
  as_tibble() 
  
country_mod_list <- oecd_country_df$name  #fill in the missing values for OECDs with 1s because by participating in OECD these countries have this
country_mod_list <- c(country_mod_list, 'Singapore')


#################
# Nested Index
################

#start by lining up data to 2019 and filling in some values for OECD countries.  
spi_index_df <- spi_index_df_temp %>%
  arrange(country, date) %>%
  group_by(country) %>%
  mutate(across(starts_with("SPI"), na.locf, na.rm=FALSE)) %>%
  mutate(across(c("SPI.D2.1.GDDS","SPI.D2.4.NADA","SPI.D4.1.1.POPU","SPI.D4.1.2.AGRI","SPI.D4.1.3.BIZZ","SPI.D4.1.4.HOUS","SPI.D4.1.5.AGSVY",
                  "SPI.D4.1.6.LABR","SPI.D4.1.7.HLTH","SPI.D4.1.8.BZSVY",
                  "SPI.D5.1.DILG",
                  "SPI.D5.2.1.SNAU", "SPI.D5.2.2.NABY", "SPI.D5.2.1.SNAU","SPI.D5.2.2.NABY",                
                  "SPI.D5.2.3.CNIN", "SPI.D5.2.4.CPIBY", "SPI.D5.2.5.HOUS", "SPI.D5.2.6.EMPL","SPI.D5.2.7.CGOV", "SPI.D5.2.8.FINA",
                  "SPI.D5.2.9.MONY", "SPI.D5.2.10.GSBP",
                  "SPI.D5.5.DIFI"),
                ~if_else(( (income=='High income') & (country %in% country_mod_list)),1,.)                )) 

#Create overall subscores corresponding to John's framework
  spi_index_df <- spi_index_df %>%
    mutate(INDEX.SPI.D2.1=rowMeans(across(starts_with('SPI.D2.1'))),
         INDEX.SPI.D2.2=SPI.D2.2.Openness.subscore,
         INDEX.SPI.D2.4=SPI.D2.4.NADA,
         INDEX.SPI.D3.1=rowMeans(across(c("SPI.D3.1.POV",
                                            "SPI.D3.2.HNGR",
                                            "SPI.D3.3.HLTH",
                                            "SPI.D3.4.EDUC",
                                            "SPI.D3.5.GEND",
                                            "SPI.D3.6.WTRS"))),
         INDEX.SPI.D3.2=rowMeans(across(c("SPI.D3.7.ENRG",
                                            "SPI.D3.8.WORK",
                                            "SPI.D3.9.INDY",
                                            "SPI.D3.10.NEQL",
                                            "SPI.D3.11.CITY",
                                            "SPI.D3.12.CNSP"))),         
         INDEX.SPI.D3.3=rowMeans(across(c("SPI.D3.13.CLMT",
                                            "SPI.D3.15.LAND" ))),
         INDEX.SPI.D3.4=rowMeans(across(c("SPI.D3.16.INST",
                                            "SPI.D3.17.PTNS" ))),
         INDEX.SPI.D4.1=rowMeans(across(starts_with('SPI.D4.1'))),
         INDEX.SPI.D4.2=rowMeans(across(starts_with('SPI.D4.2'))),
         INDEX.SPI.D4.3=rowMeans(across(starts_with('SPI.D4.3'))),
         #INDEX.SPI.D5.1=rowMeans(across(starts_with('SPI.D5.1'))),
         INDEX.SPI.D5.2=rowMeans(across(starts_with('SPI.D5.2'))),
         #INDEX.SPI.D5.5=rowMeans(across(starts_with('SPI.D5.5')))
                 ) %>%
  mutate(SPI.INDEX=rowMeans(across(starts_with("INDEX.SPI")), na.rm=FALSE),
         SPI.INDEX.DIM2=rowMeans(across(starts_with("INDEX.SPI.D2")), na.rm=FALSE),
         SPI.INDEX.DIM3=rowMeans(across(starts_with("INDEX.SPI.D3")), na.rm=FALSE),
         SPI.INDEX.DIM4=rowMeans(across(starts_with("INDEX.SPI.D4")), na.rm=FALSE),
         SPI.INDEX.DIM5=rowMeans(across(starts_with("INDEX.SPI.D5")), na.rm=FALSE)
         ) %>% #
  arrange(-date, -SPI.INDEX) %>%
  select(country, iso3c, date, starts_with('SPI.INDEX'), everything())
```


```{r programs, include=FALSE}


#Now map the result
quality = "high"
maps <- wbgmaps::wbgmaps[[quality]]

country_metadata <- wbstats::wbcountries()



spi_mapper  <- function(data, indicator, title) {
  
 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==2019) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  
  
   p1 <- ggplot() +
    geom_map(data = map_df, aes(map_id = iso3c, fill = 100*data_available), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
     geom_path(data = maps$boundaries,
               aes(long, lat, group = group),
               color = "white",
               size = 0.1,
               lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
  scale_fill_distiller(palette = "RdYlGn",
                       direction=1,
                       limits = c(0,100))  +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap(title,100),
      subtitle= 'Data Point is for last year available (2019)',
      caption = 'Source: SPI Indicator.',
      fill='SPI Indicator Value'
    )
  
  #add histogram by region 
  p2 <- map_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=100*mean(data_available, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Region', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available (2019)'
      ) +
      expand_limits(x=c(0,100)) +
      theme_bw()

  #by income
    p3 <- map_df %>%
    group_by(income) %>%
    filter(region!='Aggregates') %>%
    mutate(Percentage=100*mean(data_available, na.rm=T),
           Label = paste(round(Percentage,0))) %>%
    ggplot(aes(x=Percentage, y=income, fill=income)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data',
      subtitle= 'Data Point is for last year available  (2019)'
      ) +
      expand_limits(x=c(0,100)) +
      theme_bw()
    
  # #add line graph over time
  p4 <- get(data)  %>%
    rename(data_available=!! indicator) %>%
    # right_join(spi_df_empty) %>%
    group_by( date) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available))) %>%
    mutate(Percentage=100*mean(data_available),
           Label = paste(round(Percentage,0))) %>%
    ungroup() %>%
    ggplot(aes(y=Percentage, x=date)) +
      geom_point() +
      geom_line(fill='blue') +
      # geom_text_repel(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Date', sep=" - "),100),
      caption = 'Source: SPI Indicators Raw Data'
      ) +
      expand_limits(y=c(0,100)) +
      theme_bw()
      
  print(p1)
  
  print(p2)
  
  print(p3)

}


spi_income_table <- function(data, indicator, reference_year) {

  indicator<-indicator
  
  
  
  df_overall <- get(data) %>%
    filter(date==as.numeric(reference_year)) %>% 
    select(country, iso3c, date, income, region, starts_with(indicator))

    #produce by income
        sumstats<- df_overall %>%
            group_by(income) %>%
            filter(!is.na(income)) %>%
            select(income, starts_with(indicator)) %>%
            summarise_all(~round(100*mean(., na.rm=T),1)) 
        
        #produce global number
        sumstats_gl<- df_overall %>%
            mutate(income='Global') %>%
            group_by(income) %>%
            select(income, starts_with(indicator)) %>%
            summarise_all(~round(100*mean(., na.rm=T),1)) 
        
        
        #transpose data
        sumstats_df_long <-sumstats_gl %>%
            bind_rows(sumstats) 
        
        sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-income)))
        colnames(sumstats_df) = sumstats_df_long$income 
        
        
        sumstats_df <- sumstats_df %>%
            rownames_to_column() %>%
            rename(series=rowname)
        
        
        #create labels df
        metadata_tab2_overall <- metadata %>% 
            janitor::clean_names() %>%
            transmute(series=source_id, 
                      indicator_name=source_name)
        
        
        #add variable label
        sumstats_df <- sumstats_df %>%
            left_join(metadata_tab2_overall) %>%
            rename(Series=series,
                   Label=indicator_name) %>%
            mutate(Label=if_else(is.na(Label),Series,Label)) %>%
            select(Label, c("Global","Low income", "Lower middle income", "Upper middle income","High income"))

        sumstats_df
 

  }

spi_income_table_count <- function(data, indicator, reference_year) {

  indicator<-indicator
  
  
  
  df_overall <- get(data) %>%
    filter(date==as.numeric(reference_year)) %>% 
    select(country, iso3c, date, income, region, starts_with(indicator))

    #produce by income
        sumstats<- df_overall %>%
            group_by(income) %>%
            filter(!is.na(income)) %>%
            select(income, starts_with(indicator)) %>%
            summarise_all(~round(sum(., na.rm=T),1)) 
        
        #produce global number
        sumstats_gl<- df_overall %>%
            mutate(income='Global') %>%
            group_by(income) %>%
            select(income, starts_with(indicator)) %>%
            summarise_all(~round(sum(., na.rm=T),1)) 
        
        
        #transpose data
        sumstats_df_long <-sumstats_gl %>%
            bind_rows(sumstats) 
        
        sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-income)))
        colnames(sumstats_df) = sumstats_df_long$income 
        
        
        sumstats_df <- sumstats_df %>%
            rownames_to_column() %>%
            rename(series=rowname)
        
        
        #create labels df
        metadata_tab2_overall <- metadata %>% 
            janitor::clean_names() %>%
            transmute(series=source_id, 
                      indicator_name=source_name)
        
        
        #add variable label
        sumstats_df <- sumstats_df %>%
            left_join(metadata_tab2_overall) %>%
            rename(Series=series,
                   Label=indicator_name) %>%
            mutate(Label=if_else(is.na(Label),Series,Label)) %>%
            select(Label, c("Global","Low income", "Lower middle income", "Upper middle income","High income"))

        sumstats_df
 

  }

spi_region_table <- function(data, indicator, reference_year) {

  indicator<-indicator
  
  
  
  df_overall <- get(data) %>%
    filter(date==as.numeric(reference_year)) %>% 
    select(country, iso3c, date, income, region, starts_with(indicator))

    #produce by region
        sumstats<- df_overall %>%
            group_by(region) %>%
            filter(!is.na(region)) %>%
            select(region, starts_with(indicator)) %>%
            summarise_all(~round(100*mean(., na.rm=T),1)) 
        
        #produce global number
        sumstats_gl<- df_overall %>%
            mutate(region='Global') %>%
            group_by(region) %>%
            select(region, starts_with(indicator)) %>%
            summarise_all(~round(100*mean(., na.rm=T),1)) 
        
        
        #transpose data
        sumstats_df_long <-sumstats_gl %>%
            bind_rows(sumstats) 
        
        sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-region)))
        colnames(sumstats_df) = sumstats_df_long$region 
        
        
        sumstats_df <- sumstats_df %>%
            rownames_to_column() %>%
            rename(series=rowname)
        
        
        #create labels df
        metadata_tab2_overall <- metadata %>% 
            janitor::clean_names() %>%
            transmute(series=source_id, 
                      indicator_name=source_name)
        
        
        #add variable label
        sumstats_df <- sumstats_df %>%
            left_join(metadata_tab2_overall) %>%
            rename(Series=series,
                   Label=indicator_name) %>%
            mutate(Label=if_else(is.na(Label),Series,Label)) %>%
            select(Label, c("Global",
                            "Latin America & Caribbean",
                            "South Asia",
                            "Sub-Saharan Africa",
                            "Europe & Central Asia",
                            "Middle East & North Africa",
                            "East Asia & Pacific",
                            "North America" ))

        sumstats_df
 

  }

spi_region_table_count <- function(data, indicator, reference_year) {

  indicator<-indicator
  
  
  
  df_overall <- get(data) %>%
    filter(date==as.numeric(reference_year)) %>% 
    select(country, iso3c, date, income, region, starts_with(indicator))

    #produce by region
        sumstats<- df_overall %>%
            group_by(region) %>%
            filter(!is.na(region)) %>%
            select(region, starts_with(indicator)) %>%
            summarise_all(~round(sum(., na.rm=T),1)) 
        
        #produce global number
        sumstats_gl<- df_overall %>%
            mutate(region='Global') %>%
            group_by(region) %>%
            select(region, starts_with(indicator)) %>%
            summarise_all(~round(sum(., na.rm=T),1)) 
        
        
        #transpose data
        sumstats_df_long <-sumstats_gl %>%
            bind_rows(sumstats) 
        
        sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-region)))
        colnames(sumstats_df) = sumstats_df_long$region 
        
        
        sumstats_df <- sumstats_df %>%
            rownames_to_column() %>%
            rename(series=rowname)
        
        
        #create labels df
        metadata_tab2_overall <- metadata %>% 
            janitor::clean_names() %>%
            transmute(series=source_id, 
                      indicator_name=source_name)
        
        
        #add variable label
        sumstats_df <- sumstats_df %>%
            left_join(metadata_tab2_overall) %>%
            rename(Series=series,
                   Label=indicator_name) %>%
            mutate(Label=if_else(is.na(Label),Series,Label)) %>%
            select(Label, c("Global",
                            "Latin America & Caribbean",
                            "South Asia",
                            "Sub-Saharan Africa",
                            "Europe & Central Asia",
                            "Middle East & North Africa",
                            "East Asia & Pacific",
                            "North America" ))

        sumstats_df
 

}


spi_lending_table <- function(data, indicator, reference_year) {

  indicator<-indicator
  
  
  
  df_overall <- get(data) %>%
    filter(date==as.numeric(reference_year)) %>% 
    select(country, iso3c, date, income, lending, starts_with(indicator))

    #produce by lending
        sumstats<- df_overall %>%
            group_by(lending) %>%
            filter(!is.na(lending)) %>%
            select(lending, starts_with(indicator)) %>%
            summarise_all(~round(100*mean(., na.rm=T),1)) 
        
        #produce global number
        sumstats_gl<- df_overall %>%
            mutate(lending='Global') %>%
            group_by(lending) %>%
            select(lending, starts_with(indicator)) %>%
            summarise_all(~round(100*mean(., na.rm=T),1)) 
        
        
        #transpose data
        sumstats_df_long <-sumstats_gl %>%
            bind_rows(sumstats) 
        
        sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-lending)))
        colnames(sumstats_df) = sumstats_df_long$lending 
        
        
        sumstats_df <- sumstats_df %>%
            rownames_to_column() %>%
            rename(series=rowname)
        
        
        #create labels df
        metadata_tab2_overall <- metadata %>% 
            janitor::clean_names() %>%
            transmute(series=source_id, 
                      indicator_name=source_name)
        
        
        #add variable label
        sumstats_df <- sumstats_df %>%
            left_join(metadata_tab2_overall) %>%
            rename(Series=series,
                   Label=indicator_name) %>%
            mutate(Label=if_else(is.na(Label),Series,Label)) %>%
            select(Label, c("Global",
                            "IDA",
                            "Blend",
                            "IBRD",
                            "Not classified"))

        sumstats_df
 

  }
spi_lending_table_count <- function(data, indicator, reference_year) {

  indicator<-indicator
  
  
  
  df_overall <- get(data) %>%
    filter(date==as.numeric(reference_year)) %>% 
    select(country, iso3c, date, income, lending, starts_with(indicator))

    #produce by lending
        sumstats<- df_overall %>%
            group_by(lending) %>%
            filter(!is.na(lending)) %>%
            select(lending, starts_with(indicator)) %>%
            summarise_all(~round(sum(., na.rm=T),1)) 
        
        #produce global number
        sumstats_gl<- df_overall %>%
            mutate(lending='Global') %>%
            group_by(lending) %>%
            select(lending, starts_with(indicator)) %>%
            summarise_all(~round(sum(., na.rm=T),1)) 
        
        
        #transpose data
        sumstats_df_long <-sumstats_gl %>%
            bind_rows(sumstats) 
        
        sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-lending)))
        colnames(sumstats_df) = sumstats_df_long$lending 
        
        
        sumstats_df <- sumstats_df %>%
            rownames_to_column() %>%
            rename(series=rowname)
        
        
        #create labels df
        metadata_tab2_overall <- metadata %>% 
            janitor::clean_names() %>%
            transmute(series=source_id, 
                      indicator_name=source_name)
        
        
        #add variable label
        sumstats_df <- sumstats_df %>%
            left_join(metadata_tab2_overall) %>%
            rename(Series=series,
                   Label=indicator_name) %>%
            mutate(Label=if_else(is.na(Label),Series,Label)) %>%
            select(Label, c("Global",
                            "IDA",
                            "Blend",
                            "IBRD",
                            "Not classified"))

        sumstats_df
 

  }
#define function to pull data from UN Stats and return
un_pull <- function(series,start, end) {
  # jsonlite::fromJSON(paste('https://unstats.un.org/SDGAPI/v1/sdg/Series/Data?seriesCode=',series,'&timePeriodStart=',start,'&timePeriodEnd=',end,'&pageSize=10000',sep=""), flatten = TRUE)$data %>%
      jsonlite::fromJSON(paste('https://unstats.un.org/SDGAPI/v1/sdg/Series/Data?seriesCode=',series,'&pageSize=10000',sep=""), flatten = TRUE)$data %>%

    as_tibble() %>%
    mutate(date=timePeriodStart) %>%
    right_join(iso3c)
    
}  

FitFlextableToPage <- function(ft, pgwidth = 6){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

```

## Notes on Tables and Figures

All tables and figures show unweighted summary statistics (i.e. the summary statistics do not weight by population).  

The dataset contains `r nrow(filter(spi_index_df, (date==2019 & !is.na(SPI.INDEX))))` countries with complete data for 2019.  Below is a map showing these countries with complete data in 2019.  Many of the HIC island nations are excluded, as we collect more of this data.

```{r complete}

complete_df <- spi_index_df %>%
  mutate(complete=!is.na(SPI.INDEX)) %>%
  select(country, date, complete)

spi_mapper('complete_df', 'complete', 'Countries with Complete SPI Observations in 2019')

```

  


## Figure on Data use: great if you can put something together as you think makes sense, with a breakdown by income level   

Based on PARIS21 data use indicator (Chapter 4 of Statistical Capacity Development Outlook) using voluntary national review plans as a source.

Our main source for this is the UN Voluntary National Reviews (VNR) Database (https://sustainabledevelopment.un.org/vnrs/).


The indicator for each data use by the national executive branch is formed by:   
  1.	Searches the documents for references to a set of keywords related to each SDG goal     
  2.	Searches the documents for the subset of references that also include statistics, by searching for numeric values (excluding references to years)    
  3.	Calculates the ratio between the two

The ratio captures density of discussion of each topic in each document assessed.  The keywords are based on indicators found in the World Bank's World Development Indicators (WDI).  

  
```{r use, eval=FALSE, include=FALSE}

vnr_df <- spi_df_final %>%
  select(country, date, SPI.D1.2.VNR)

spi_mapper('vnr_df', 'SPI.D1.2.VNR', 'Overall Score for Use of Numbers in VNRs')


vnr_table <- spi_income_table('spi_df_final', c('SPI.D1.2.VNR'),'2019')

#export table to word
ft <- flextable(vnr_table) %>%
  add_header_lines("Overall Score for Use of Numbers in VNRs") 

FitFlextableToPage(ft)
```  
  
## Data Products: % by goal at the global level    

Data Products (16 Indicators):   

- GOAL 1: No Poverty    
- GOAL 2: Zero Hunger   
- GOAL 3: Good Health and Well-beingq   
- GOAL 4: Quality Education   
- GOAL 5: Gender Equality   
- GOAL 6: Clean Water and Sanitation    
- GOAL 7: Affordable and Clean Energy   
- GOAL 8: Decent Work and Economic Growth   
- GOAL 9: Industry, Innovation and Infrastructure   
- GOAL 10: Reduced Inequality   
- GOAL 11: Sustainable Cities and Communities   
- GOAL 12: Responsible Consumption and Production   
- GOAL 13: Climate Action   
- **GOAL 14: Life Below Water is excluded because this indicator is not relevant for landlocked countries**   
- GOAL 15: Life on Land   
- GOAL 16: Peace and Justice Strong Institutions    
- GOAL 17: Partnerships to achieve the Goal   




Scoring Approach:

  1. Download the latest SDG indicator data from UN Stats (https://unstats.un.org/sdgs/indicators/en/#) using their API   
  
  2. Transform the data so that for each indicator we can create a score documenting whether a value exists for the country in a year, whether the value is based on country data, country data adjusted, estimated, or modelled data according the UN Stats metadata. **This will only include tier 1 indicators**.    
  
  3. Combine the resulting data into a single set of indicators for use in the Statistical Performance Indicators dashboard and index by calculating the average across SDGs.  This results in 17 total indicators.  One for each SDG, which is the share of indicators with a value meeting quality criteria defined below.

Below is a paraphrased description from the UN stats webpage (https://unstats.un.org/sdgs/indicators/indicators-list/):

The global indicator framework for Sustainable Development Goals was developed by the Inter-Agency and Expert Group on SDG Indicators (IAEG-SDGs) and agreed upon at the 48th session of the United Nations Statistical Commission held in March 2017.

The global indicator framework includes 231 unique indicators. Please note that the total number of indicators listed in the global indicator framework of SDG indicators is 247. However, twelve indicators repeat under two or three different targets.

For each value of the indicator, the responsible international agency has been requested to indicate whether the national data were adjusted, estimated, modelled or are the result of global monitoring. The “nature” of the data in the SDG database is determined as follows:


  * Country data (C): Produced and disseminated by the country (including data adjusted by the country to meet international standards);    
  
  * Country data adjusted (CA): Produced and provided by the country, but adjusted by the international agency for international comparability to comply with internationally agreed standards, definitions and classifications;    
  
  * Estimated (E): Estimated based on national data, such as surveys or administrative records, or other sources but on the same variable being estimated, produced by the international agency when country data for some year(s) is not available, when multiple sources exist, or when there are data quality issues;    
  
  * Modelled (M): Modelled by the agency on the basis of other covariates when there is a complete lack of data on the variable being estimated;    
  
  * Global monitoring data (G): Produced on a regular basis by the designated agency for global monitoring, based on country data. There is no corresponding figure at the country level.

# Scoring

For each indicator, we will produce a value for each country with the following coding scheme:    

  * **1 Point**: Indicator exists and the value is based on the **country**, **country data adjusted**, or **estimated or Global Monitoring** data    
  * **0 Points**: Indicator **based on modeled data or does not exists**
  
We give countries no credit for modeled data, because the country did not produce indicators in a form that was directly usable for reporting on an SDG indicator.
  
When we average over all indicators in a goal to get a score, we compute a 5 year moving average to avoid year to year variability in reporting for SDGs.  The overall score for an SDG is then the 5 year average of the percentage of indicator values based on **country**, **country data adjusted**, or **estimated or Global Monitoring** data that were available for the SDG.
  
Because of the large data files and runtime of the program to calculate these indicators, the code to produce these indicators is in a separate file.  https://github.com/stacybri/UN_Stats_SDG_Indicators_SPI/blob/master/02_programs/un_stats_cleaning.Rmd
  
```{r products, echo=FALSE}


products_table <- spi_income_table('spi_df_final', 'SPI.D3','2019')

products_region_table <- spi_region_table('spi_df_final', 'SPI.D3','2019')

products_lending_table <- spi_lending_table('spi_df_final', 'SPI.D3','2019')

#export table to word
ft <- flextable(products_table) %>%
  add_header_lines("Percentage of SDG Indicator Values Available by Goal That Meet Metadata Standards") 

FitFlextableToPage(ft)
```  
  
## Indicators 4.x: by income group    
  
```{r sources, echo=FALSE}


products_table <- spi_income_table('spi_index_df', 'SPI.D4','2019')

#export table to word
ft <- flextable(products_table) %>%
  add_header_lines("Data Sources Scores by Income Group") 

FitFlextableToPage(ft)
```   
  
## Indicator 5.2 – standards. Same table as above but only with 5.2 
  
```{r standards, echo=FALSE}


methods_table <- spi_income_table('spi_index_df', 'SPI.D5.2','2019')

#export table to word
ft <- flextable(methods_table) %>%
  add_header_lines("Data Standards and Methods Scores by Income Group") 

FitFlextableToPage(ft)
```  
  
## Indicator 5.5 finance – same table as above, and in addition table by region   
  
Indicator based on  SDG indicators (SDG 17.18.3 (national statistical plan that is fully funded and under implementation). This indicator measures whether the national statistical plan under implementation is fully funded. It relates to SDG 17.18.3 and is based on the annual Status Report on National Strategies for the Development of Statistics (NSDS).

Scores is 1 if the country has a national statistical plan that is fully funded and under implementation.  Scores of 0 or scores with missing values are treated the same (both given a score of zero).

The source is Paris 21 and UNSD.  Data accessed using UNSD SDG API on `r Sys.Date()`

Source of this data is UNSD and Paris21.  

```{r finance, echo=FALSE}

finance_df <- spi_index_df %>%
  select(country, date,SPI.D5.5.DIFI )

spi_mapper('finance_df', 'SPI.D5.5.DIFI', 'Statistical plan fully funded. Source: Paris21')

finance_table <- spi_income_table('spi_index_df', 'SPI.D5.5','2019')

#export table to word
ft <- flextable(finance_table) %>%
  add_header_lines(" Finance Score by Income Group") 

FitFlextableToPage(ft)
```  
  
## Indicator 5.1 legislation and governance 

The legislation and governance indicator will be drawn from SDG indicator 17.18.2 (national statistical legislation compliance with UN Fundamental Principles of Official Statistics), existence of National Statistical Council, national statistical strategy generation, national statistical plan. Also include some other legislative aspects that foster good use of statistics eg freedom of information, privacy/transparency, good governance (eg free and fair elections).

This indicator measures whether the national statistical legislation complies with United Nations Fundamental Principles of Statistics (SDG 17.18.2)

Scores is 1 if the country has a national statistical legislation compliant with United Nations Fundamental Principles of Statistics.  Scores of 0 or scores with missing values are treated the same (both given a score of zero).

The source is Paris 21 and UNSD.  Data accessed using UNSD SDG API on `r Sys.Date()`

```{r legislation, echo=FALSE}

legislation_df <- spi_index_df %>%
  select(country, date,SPI.D5.1.DILG )

spi_mapper('legislation_df', 'SPI.D5.1.DILG', 'Statistical plan fully funded. Source: Paris21')

finance_table <- spi_income_table('spi_index_df', 'SPI.D5.1.DILG','2019')

#export table to word
ft <- flextable(finance_table) %>%
  add_header_lines(" Legislation and Governance Score by Income Group") 

FitFlextableToPage(ft)
```    
  
## 	Population and Housing census and Agricultural Census. Four table as above, one set with % of countries with census in last 10 years, one set with % of countries with census in the last 20 years.    

```{r cen, echo=FALSE}

df_10yr <- spi_df_final %>%
  mutate('Population Census Last 10 Years'=if_else(SPI.D4.1.1.POPU==1,1,0),
         'Population Census Last 20 Years'=if_else(SPI.D4.1.1.POPU>0,1,0),
         'No Population Census Last 10 Years'=if_else(SPI.D4.1.1.POPU<1,1,0),
         'No Population Census Last 20 Years'=if_else(SPI.D4.1.1.POPU==0,1,0),
         'Agriculture Census Last 10 Years'=if_else(SPI.D4.1.2.AGRI==1,1,0),
         'Agriculture Census Last 20 Years'=if_else(SPI.D4.1.2.AGRI>0,1,0),
         'total'=1)


cen_table <- spi_income_table('df_10yr', c('Population Census Last 10 Years','Population Census Last 20 Years','Agriculture Census Last 10 Years','Agriculture Census Last 20 Years'),'2019')

cen_table_count <- spi_income_table_count('df_10yr', c('No Population Census Last 10 Years','No Population Census Last 20 Years', 'total'),'2019')

cen_table_count_reg <- spi_region_table_count('df_10yr', c('No Population Census Last 10 Years','No Population Census Last 20 Years', 'total'),'2019')

cen_table_count_lend <- spi_lending_table_count('df_10yr', c('No Population Census Last 10 Years','No Population Census Last 20 Years', 'total'),'2019')

#export table to word
ft <- flextable(cen_table) %>%
  add_header_lines("Population and Housing census and Agricultural Censuses") 

FitFlextableToPage(ft)
```  
  



  